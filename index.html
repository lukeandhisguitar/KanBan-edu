<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœ‹æ¿</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ============================================= */
        /* =========== åŸºç¡€å¸ƒå±€ & ä¾§è¾¹æ æ ·å¼ =========== */
        /* ============================================= */
        body {
            margin: 0;
            font-size: 14px;
            user-select: none;
            overflow-x: hidden; /* é˜²æ­¢æ°´å¹³æ»šåŠ¨æ¡ */
        }
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 220px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            padding: 1.5rem 0;
            transition: all 0.3s ease;
        }
        .sidebar-header {
            padding: 0 1.5rem;
            margin-bottom: 2.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .sidebar-logo {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
        }
        .sidebar-title {
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: 1px;
        }
        .sidebar-nav {
            padding: 0 1rem;
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.85rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .nav-icon {
            width: 20px;
            height: 20px;
            margin-right: 1rem;
            stroke-width: 2;
        }
        .main-content {
            flex-grow: 1;
            padding: 2rem 4rem;
            transition: background-color 0.3s ease;
        }
        #main-title {
              margin: 0;
              font-weight: 600;
        }

        /* é€šç”¨UIç»„ä»¶æ ·å¼ */
        .controls { display: flex; align-items: center; gap: 1.25rem; }
        .header-btn {
            display: inline-flex; align-items: center; justify-content: center; height: 40px; padding: 0;
            border: none; font-weight: 500; font-size: 14px; cursor: pointer; transition: all 0.2s ease-in-out;
            overflow: hidden; color: white;
        }
        .header-btn:hover { transform: translateY(-2px); }
        .btn-text { padding: 0 0.75rem 0 1rem; letter-spacing: 0.5px; }
        .btn-icon { width: 40px; height: 100%; display: flex; align-items: center; justify-content: center; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; justify-content: center; align-items: center; }
        .modal-content { padding: 2rem; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .modal-actions { margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 1rem; }
         
        .project-table-wrapper { overflow-x: auto; }
        .project-table { border-collapse: collapse; width: 100%;}
        .project-row, .project-header-row { display: grid; align-items: center; border-bottom: 1px solid var(--border-color); min-height: 58px; }
        .project-table .project-row:last-child { border-bottom: none; }
        .project-header-row { position: sticky; top: 0; z-index: 20; font-size: 14px; font-weight: 600; }
        .cell, .header-cell { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding: 1rem 1rem; position: relative; border-right: 1px solid var(--border-color); min-width: 30px; }
        .cell:last-child, .header-cell:last-child { border-right: none; }
        .header-cell { cursor: grab; display: flex; align-items: center; gap: 8px; }
        .action-cell, .header-cell[data-key="actions"] { position: sticky; right: 0; z-index: 15; }
        .resize-handle { display: none; } /* ç¦ç”¨è°ƒæ•´å®½åº¦åŠŸèƒ½ */
        .header-icon-svg { width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; flex-shrink: 0; }
        .bottom-controls-container { padding-top: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .add-project-btn { padding: 0.5rem; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; border-radius: 6px; }
        .inline-editor { position: absolute; top: 2px; left: 2px; right: 2px; bottom: 2px; z-index: 10; }
        .inline-editor input, .inline-editor select { width: 100%; height: 100%; border-radius: 3px; font-size: 14px; box-sizing: border-box; }
         
        /* ============================================= */
        /* =========== ä¸»é¢˜ä¸€: æ·±ç©ºå•†åŠ¡ (å·¥ä½œ) =========== */
        /* ============================================= */
        .theme-work {
            --bg-color: #111827; --text-color: #d1d5db; --text-color-secondary: #9ca3af;
            --border-color: #374151; --header-bg: #1f2937; --hover-bg: #2b3a50;
            --primary-color: #3b82f6; --sidebar-bg: #0f172a; --sidebar-text: #94a3b8;
            --sidebar-hover-bg: #1e293b; --sidebar-active-bg: #3b82f6; --sidebar-active-text: #ffffff;
            --modal-bg: #1f2937;
            --pill-text-color: white;
            --btn-config-color: #8b5cf6; --btn-export-color: #10b981; --btn-import-color: #6b7280;
        }
        .theme-work .sidebar { background-color: var(--sidebar-bg); }
        .theme-work .sidebar-logo { background-color: var(--primary-color); color: white; }
        .theme-work .sidebar-title { color: #f1f5f9; }
        .theme-work .nav-item { color: var(--sidebar-text); }
        .theme-work .nav-item:hover { background-color: var(--sidebar-hover-bg); color: #e2e8f0; }
        .theme-work .nav-item.active { background-color: var(--sidebar-active-bg); color: var(--sidebar-active-text); font-weight: 600;}
        .theme-work .main-content { background-color: var(--bg-color); color: var(--text-color); font-family: 'Inter', sans-serif;}
        .theme-work #main-title { color: #f9fafb; }
        .theme-work .header-btn { border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2); }
        .theme-work .btn-icon { background-color: rgba(255,255,255,0.05); }
        .theme-work #config-btn { background-color: var(--btn-config-color); }
        .theme-work #export-btn { background-color: var(--btn-export-color); }
        .theme-work #import-btn { background-color: var(--btn-import-color); }
        .theme-work .project-table-wrapper { border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); background-color: var(--header-bg); }
        .theme-work .project-header-row { color: #e5e7eb; background-color: #2b3a50; border-bottom: 2px solid var(--border-color); }
        .theme-work .modal { background-color: rgba(17, 24, 39, 0.6); backdrop-filter: blur(4px); }
        .theme-work .modal-content { background-color: var(--modal-bg); border-radius: 8px; border: 1px solid var(--border-color); color: var(--text-color); }
        .theme-work .cell-name-span { font-weight: 500; color: #f9fafb; }
        .theme-work .pill { padding: 3px 12px; font-size: 12px; font-weight: 500; display: inline-block; border-radius: 999px; }
        .theme-work .pill[data-value="å°šæœªå¼€å§‹"] { background-color: #374151; color: #d1d5db; }
        .theme-work .pill[data-value="åˆæ­¥æ¥è§¦"] { background-color: #1e3a8a; color: #dbeafe; }
        .theme-work .pill[data-value="æ­£åœ¨æ¨è¿›"] { background-color: #92400e; color: #fef3c7; }
        .theme-work .pill[data-value="é¡ºåˆ©å®Œæˆ"] { background-color: #064e3b; color: #d1fae5; }
        .theme-work .pill[data-value="å·²ç»æ”¾å¼ƒ"] { background-color: #4b5563; color: #9ca3af; }
        .theme-work .pill[data-value="è‚¡æƒ"] { background-color: #115e59; color: #ccfbf1; }
        .theme-work .pill[data-value="å¹¶è´­"] { background-color: #4c1d95; color: #ede9fe; }
        .theme-work .pill[data-value="ä¸è‰¯"] { background-color: #7c2d12; color: #ffedd5; }
        .theme-work .pill[data-value="å…¶ä»–"] { background-color: #334155; color: #e2e8f0; }
        .theme-work #project-form-fields input, .theme-work #project-form-fields select, .theme-work #project-form-fields textarea { background-color: #2b3a50; color: var(--text-color); border: 1px solid var(--border-color); border-radius: 6px; padding: 0.75rem;}
        .theme-work .add-project-btn { color: var(--text-color-secondary); font-weight: 500; }
        .theme-work .add-project-btn:hover { background-color: var(--header-bg); color: #f9fafb; }
        .theme-work .inline-editor input, .theme-work .inline-editor select { font-family: 'Inter', sans-serif; background-color: #111827; color: var(--text-color); border: 2px solid var(--primary-color);}
        .theme-work .action-btn { color: #6b7280; }

        /* ============================================= */
        /* =========== ä¸»é¢˜äºŒ: å­¦é™¢ç»¿èŒµ (æ•™å­¦) =========== */
        /* ============================================= */
        .theme-student {
            --bg-color: #f4f8f7; --text-color: #2c3e50; --border-color: #dce4e1;
            --header-bg: #eaf3f0; --hover-bg: #f0f5f3; --primary-color: #27ae60;
            --sidebar-bg: #ffffff; --sidebar-text: #34495e;
            --sidebar-hover-bg: #f3f9f6; --sidebar-active-bg: #27ae60; --sidebar-active-text: #ffffff;
            --modal-bg: #ffffff;
            --btn-config-color: #8e44ad; --btn-export-color: #2980b9; --btn-import-color: #7f8c8d;
        }
        .theme-student .sidebar { background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); }
        .theme-student .sidebar-logo { background-color: var(--primary-color); color: white; }
        .theme-student .sidebar-title { color: #16a085; }
        .theme-student .nav-item { color: var(--sidebar-text); }
        .theme-student .nav-item:hover { background-color: var(--sidebar-hover-bg); color: var(--primary-color); }
        .theme-student .nav-item.active { background-color: var(--sidebar-active-bg); color: var(--sidebar-active-text); font-weight: 600; }
        .theme-student .main-content {
            background-color: var(--bg-color); color: var(--text-color); font-family: 'Noto Sans SC', sans-serif;
            background-image: linear-gradient(rgba(45, 174, 96, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(45, 174, 96, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .theme-student #main-title { color: #16a085; }
        .theme-student .header-btn { border-radius: 99px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
        .theme-student .btn-icon { background-color: rgba(0,0,0,0.1); }
        .theme-student #config-btn { background-color: var(--btn-config-color); }
        .theme-student #export-btn { background-color: var(--btn-export-color); }
        .theme-student #import-btn { background-color: var(--btn-import-color); }
        .theme-student .project-table-wrapper { border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .theme-student .project-header-row { color: #34495e; background-color: var(--header-bg); border-bottom: 2px solid #b2d8c4; border-top-left-radius: 12px; border-top-right-radius: 12px; }
        .theme-student .action-cell, .theme-student .header-cell[data-key="actions"] { background-color: var(--bg-color); border-left: 1px solid #c8d5d1;}
        .theme-student .project-header-row .header-cell[data-key="actions"] { background-color: var(--header-bg); }
        .theme-student .modal { background-color: rgba(44, 62, 80, 0.4); }
        .theme-student .modal-content { background-color: var(--modal-bg); border-radius: 12px; }
        #config-modal .modal-content { max-width: 500px; width: 100%; }
        #config-form-fields label { display: inline-flex; align-items: center; gap: 8px; }
        .theme-student .cell { font-weight: 500; }
        .theme-student .cell-name-span { color: #2c3e50; }
        
        .theme-student .pill { padding: 4px 14px; font-size: 12px; display: inline-block; border-radius: 16px; border: 1px solid transparent; }
        .theme-student .pill[data-value="ALEVEL"] { background-color: #eafaf1; color: #1e8449; border-color: #a3d9b8; }
        .theme-student .pill[data-value="AP"] { background-color: #e8f6f3; color: #117864; border-color: #9edad8; }
        .theme-student .pill[data-value="IB"] { background-color: #fef5e7; color: #d35400; border-color: #f5cba7; }
        .theme-student .pill[data-value="IGCSE"] { background-color: #f4ecf7; color: #884ea0; border-color: #d7bde2; }
        .theme-student .pill[data-value="æ•°å­¦"] { background-color: #eaf2f8; color: #2980b9; border-color: #a9cce3; }
        .theme-student .pill[data-value="ç‰©ç†"] { background-color: #fdedec; color: #c0392b; border-color: #f5b7b1; }
        .theme-student .pill[data-value="åŒ–å­¦"] { background-color: #ebf5fb; color: #2471a3; border-color: #aed6f1; }
        .theme-student .pill[data-value="ç»æµ"] { background-color: #f6eefc; color: #7d3c98; border-color: #dcbbf4; }
        .theme-student #project-form-fields input, .theme-student #project-form-fields select, .theme-student #project-form-fields textarea { border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem;}
        .theme-student .add-project-btn { color: #34495e; font-weight: 500;}
        .theme-student .add-project-btn:hover { background-color: #eaf3f0; color: #16a085; }
        .theme-student .inline-editor input, .theme-student .inline-editor select { font-family: 'Noto Sans SC', sans-serif; border: 2px solid var(--primary-color);}
        .theme-student .action-btn { cursor: pointer; padding: 2px; border-radius: 8px; transition: all 0.2s; vertical-align: middle; display: inline-flex; align-items: center; color: #95a5a6; flex-shrink: 0; font-size: 18px;}
        .theme-student .action-btn:hover { background-color: #ecf0f1; color: var(--primary-color); }
        
        /* æ•™å­¦è¿›åº¦å¼¹çª—æ ·å¼ */
        .theme-student #progress-modal .modal-content { max-width: 800px; transition: max-width 0.4s ease; }
        .theme-student #progress-modal-body.side-by-side ~ .modal-content, .theme-student #progress-modal .modal-content.side-by-side-mode { max-width: 1200px; }
        .theme-student #progress-modal-body { display: flex; gap: 2rem; }
        .theme-student #progress-log-list-wrapper { width: 100%; transition: width 0.4s ease; position: relative; padding-bottom: 50px; }
        .theme-student #progress-modal-body.side-by-side #progress-log-list-wrapper { width: 50%; padding-bottom: 0;}
        .theme-student #progress-log-list { max-height: 60vh; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; background-color: #fdfefe; }
        .theme-student #progress-log-list:empty::after { content: 'æš‚æ— æ•™å­¦è®°å½•ï¼Œè¯·åœ¨ä¸‹æ–¹æ·»åŠ ç¬¬ä¸€æ¡ã€‚'; color: #95a5a6; text-align: center; display: block; padding: 3rem 0; }
        .theme-student #show-add-log-form-btn { position: absolute; bottom: 0; right: 0; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; padding: 0.6rem 1.2rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .theme-student #show-add-log-form-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .theme-student #progress-modal-body.side-by-side #show-add-log-form-btn { display: none; }
        .theme-student #progress-log-form { display: none; width: 0; transition: width 0.4s ease; }
        .theme-student #progress-modal-body.side-by-side #progress-log-form { display: block; width: 50%; }
        .theme-student .progress-log-entry { position: relative; border-bottom: 1px solid var(--border-color); padding: 1.5rem 0.5rem; }
        .theme-student .progress-log-entry:last-child { border-bottom: none; }
        .theme-student .log-entry-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; }
        .theme-student .log-entry-date { position: relative; font-weight: 700; font-size: 1.1em; color: var(--text-color); }
        .theme-student .log-entry-duration { position: relative; font-size: 13px; color: #7f8c8d; background-color: #ecf0f1; padding: 3px 10px; border-radius: 12px; }
        .theme-student .log-entry-body { display: grid; grid-template-columns: 115px 1fr; gap: 0.8rem 1rem; font-size: 14px; }
        .theme-student .log-entry-body dt { font-weight: 500; color: #34495e; text-align: right; padding-right: 1rem; border-right: 2px solid var(--header-bg);}
        .theme-student .log-entry-body dd { position: relative; margin: 0; white-space: pre-wrap; word-break: break-word; line-height: 1.6; }
        .theme-student dd[data-homework-status="å·²å®Œæˆ"] { color: #27ae60; font-weight: 500; }
        .theme-student dd[data-homework-status="éƒ¨åˆ†å®Œæˆ"] { color: #f39c12; font-weight: 500; }
        .theme-student dd[data-homework-status="æœªæäº¤"] { color: #e74c3c; font-weight: 500; }
        .theme-student dd[data-homework-status="å¾…æ£€æŸ¥"] { color: #3498db; font-weight: 500; }
        .theme-student #progress-log-form { border-left: 1px solid var(--border-color); padding-left: 2rem; max-height: 65vh; overflow-y: auto;}
        .theme-student #progress-log-form h3 { margin-top: 0; margin-bottom: 1.5rem; font-size: 16px; font-weight: 700;}
        .theme-student .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem 1.5rem; }
        .theme-student .form-field { display: flex; flex-direction: column; }
        .theme-student .form-field.full-width { grid-column: 1 / -1; }
        .theme-student .form-field label { font-weight: 500; margin-bottom: 0.5rem; font-size: 13px; color: #34495e;}
        .theme-student .form-field input, .theme-student .form-field select, .theme-student .form-field textarea {
            width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px;
            box-sizing: border-box; font-family: 'Noto Sans SC', sans-serif; font-size: 14px; transition: all 0.2s;
        }
        .theme-student .form-field input:focus, .theme-student .form-field select:focus, .theme-student .form-field textarea:focus {
            border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1); outline: none;
        }
        .theme-student .delete-log-btn {
            position: absolute;
            bottom: 1rem;
            right: 0.5rem;
            width: 28px;
            height: 28px;
            background-color: #fdedec;
            color: #c0392b;
            border: 1px solid #f5b7b1;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s ease-in-out;
            font-size: 16px;
            font-weight: bold;
        }
        .theme-student .progress-log-entry:hover .delete-log-btn { opacity: 1; }
        .theme-student .delete-log-btn:hover { background-color: #e74c3c; color: white; transform: scale(1.1); }
        .theme-student .log-inline-editor { position: absolute; top: 0; left: 0; z-index: 10; }
        .theme-student .log-inline-editor input, 
        .theme-student .log-inline-editor select, 
        .theme-student .log-inline-editor textarea {
             box-sizing: border-box;
             font-family: 'Noto Sans SC', sans-serif;
             font-size: inherit;
             line-height: inherit;
             border-radius: 4px;
             border: 2px solid var(--primary-color);
             padding: 0 2px;
             resize: none;
        }
/* --- æ–°å¢ï¼šä¸ºå†å²è®°å½•æ¡ç›®æ·»åŠ å¯ç‚¹å‡»å…‰æ ‡ --- */
        .theme-student .log-entry-date,
        .theme-student .log-entry-duration,
        .theme-student .log-entry-body dd {
            cursor: pointer;
        }

        /* --- æ–°å¢ï¼šå½“è¿›å…¥åˆ†æ æ¨¡å¼æ—¶ï¼Œå–æ¶ˆå¯ç‚¹å‡»å…‰æ ‡ --- */
        .theme-student #progress-modal-body.side-by-side .log-entry-date,
        .theme-student #progress-modal-body.side-by-side .log-entry-duration,
        .theme-student #progress-modal-body.side-by-side .log-entry-body dd {
            cursor: default;
        }

        /* æ—¥å†å¼¹çª—æ ·å¼ */
        #calendar-modal .modal-content { max-width: 500px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .calendar-header h2 { margin: 0; font-size: 1.2rem; font-weight: 600; color: #34495e;}
        .calendar-header button { background: none; border: 1px solid transparent; border-radius: 6px; padding: 0.4rem 0.8rem; cursor: pointer; transition: all 0.2s; font-weight: 500; }
        .calendar-header button:hover { background-color: #ecf0f1; }
        #edit-schedule-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .day-header, .day-cell { padding: 0.5rem; border-radius: 8px; }
        .day-header { font-weight: 600; color: #95a5a6; font-size: 13px; }
        .day-cell { color: #7f8c8d; }
        .current-month-day { color: var(--text-color); }
        .day-cell.taught { background-color: #a3d9b8; color: #1e8449; font-weight: bold; }
        #calendar-modal.calendar-editing .current-month-day { cursor: pointer; }
        #calendar-modal.calendar-editing .current-month-day:hover { background-color: #eafaf1; }

/* --- æ–°å¢ï¼šä¸ºâ€œæ–°å¢/ç¼–è¾‘å­¦ç”Ÿâ€å¼¹çª—è®¾ç½®æœ€å¤§å®½åº¦ --- */
        .theme-student #project-modal .modal-content {
            max-width: 800px;
        }

    </style>
</head>
<body>

    <div class="dashboard-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">K</div>
                <div class="sidebar-title">çœ‹æ¿</div>
            </div>
            <nav class="sidebar-nav">
                <a class="nav-item" id="nav-work">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
                    <span>é¡¹ç›®çœ‹æ¿</span>
                </a>
                <a class="nav-item" id="nav-student">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                    <span>å­¦ç”Ÿçœ‹æ¿</span>
                </a>
            </nav>
        </div>

        <main class="main-content">
            <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h1 id="main-title"></h1>
                <div class="controls">
                    <button class="header-btn" id="config-btn">
                        <span class="btn-text">çœ‹æ¿é…ç½®</span>
                        <span class="btn-icon">
                            <svg style="width: 20px; height: 20px; stroke-width: 1.5;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19-.15-.24-.42-.12-.64l2 3.46c.12-.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69-.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65z"></path><circle cx="12" cy="12" r="3.5"></circle></svg>
                        </span>
                    </button>
                    <button class="header-btn" id="export-btn">
                        <span class="btn-text">å¤‡ä»½æ•°æ®</span>
                        <span class="btn-icon">
                            <svg style="width: 20px; height: 20px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M5 20h14v-2H5v2zm7-18L5.33 9h3.58v6h6.18V9h3.58L12 2z"></path></svg>
                        </span>
                    </button>
                    <input type="file" id="import-input" accept=".json" style="display: none;">
                    <button class="header-btn" id="import-btn">
                        <span class="btn-text">æ¢å¤æ•°æ®</span>
                        <span class="btn-icon">
                            <svg style="width: 20px; height: 20px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M5 20h14v-2H5v2zM12 2l6.67 7h-3.58v6h-6.18V9H5.33L12 2z" transform="rotate(180 12 12)"></path></svg>
                        </span>
                    </button>
                </div>
            </header>

            <div class="project-table-wrapper">
                <div class="project-table" id="board-container"></div>
            </div>
            <div class="bottom-controls-container">
                <a class="add-project-btn" id="add-btn"></a>
            </div>
        </main>
    </div>

    <div id="project-modal" class="modal">
        <div class="modal-content">
            <form id="project-form">
                <h2 id="modal-title"></h2>
                <input type="hidden" id="project-id" value="">
                <div id="project-form-fields" style="display: grid; grid-template-columns: 100px 1fr; gap: 1.5rem; align-items: center; margin-top: 2.5rem;"></div>
                <div class="modal-actions">
                    <button type="submit" id="save-project-btn" style="border: none; padding: 0.6rem 1.2rem; border-radius: 6px; font-weight: 500; cursor: pointer;">ä¿å­˜</button>
                    <button type="button" id="delete-btn" style="border: none; padding: 0.6rem 1.2rem; border-radius: 6px; font-weight: 500; display: none; cursor: pointer;">åˆ é™¤</button>
                </div>
            </form>
        </div>
    </div>
    <div id="config-modal" class="modal">
         <div class="modal-content">
            <h2 style="font-weight: 600;">çœ‹æ¿é…ç½®</h2>
            <div id="config-form-fields" style="display: flex; flex-direction: column; gap: 1rem; padding: 2rem 1rem;"></div>
            <div class="modal-actions">
                <button type="button" id="save-config-btn" style="padding: 0.6rem 1.2rem; border-radius: 6px; font-weight: 500; cursor: pointer;">ä¿å­˜é…ç½®</button>
            </div>
        </div>
    </div>
    <div id="progress-modal" class="modal">
        <div class="modal-content">
            <h2 id="progress-modal-title" style="font-weight: 600;"></h2>
            <div id="progress-modal-body">
                <div id="progress-log-list-wrapper">
                    <div id="progress-log-list"></div>
                    <button id="show-add-log-form-btn">+ æ·»åŠ æ–°è®°å½•</button>
                </div>
                <form id="progress-log-form">
                    <h3>æ·»åŠ æ–°æ•™å­¦è®°å½•</h3>
                    <div class="form-grid">
                        <div class="form-field">
                            <label for="new-log-date">ä¸Šè¯¾æ—¥æœŸ</label>
                            <input type="date" id="new-log-date" required>
                        </div>
                        <div class="form-field">
                            <label for="new-log-duration">ä¸Šè¯¾æ—¶é•¿ (å°æ—¶)</label>
                            <input type="number" id="new-log-duration" step="0.5" min="0" placeholder="ä¾‹å¦‚: 1.5">
                        </div>
                        <div class="form-field full-width">
                            <label for="new-log-content">ä¸Šè¯¾å†…å®¹</label>
                            <textarea id="new-log-content" rows="3" placeholder="ç®€è¿°æœ¬æ¬¡è¯¾çš„æ ¸å¿ƒå†…å®¹..."></textarea>
                        </div>
                        <div class="form-field full-width">
                            <label for="new-log-feedback">åé¦ˆä¸è¡¨ç°</label>
                            <textarea id="new-log-feedback" rows="2" placeholder="è®°å½•å­¦ç”Ÿçš„äº®ç‚¹ä¸å¾…æ”¹è¿›ä¹‹å¤„..."></textarea>
                        </div>
                        <div class="form-field">
                            <label for="new-log-homework">ä½œä¸šå¸ƒç½®</label>
                            <input type="text" id="new-log-homework" placeholder="ä¾‹å¦‚: å®Œæˆç»ƒä¹ å†ŒP25-28">
                        </div>
                        <div class="form-field">
                            <label for="new-log-homework-status">ä½œä¸šå®Œæˆæƒ…å†µ</label>
                            <select id="new-log-homework-status">
                                <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                                <option value="éƒ¨åˆ†å®Œæˆ">éƒ¨åˆ†å®Œæˆ</option>
                                <option value="æœªæäº¤">æœªæäº¤</option>
                                <option value="å¾…æ£€æŸ¥" selected>å¾…æ£€æŸ¥</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-actions" style="margin-top: 1.5rem;">
                        <button type="button" id="return-to-log-list-btn" style="background-color: #f0f0f0; padding: 0.6rem 1.2rem; border-radius: 6px; font-weight: 500; cursor: pointer; border: 1px solid #ccc;">è¿”å›</button>
                        <button type="submit" id="save-progress-btn" style="border: none; padding: 0.6rem 1.2rem; border-radius: 6px; font-weight: 500; cursor: pointer;">ä¿å­˜è®°å½•</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="calendar-modal" class="modal">
        <div class="modal-content">
            <div class="calendar-header">
                <div>
                    <button id="prev-month-btn">â—€</button>
                    <button id="next-month-btn">â–¶</button>
                </div>
                <h2 id="calendar-month-year"></h2>
                <button id="edit-schedule-btn">ç¼–è¾‘</button>
            </div>
            <div id="calendar-grid"></div>
        </div>
    </div>
    
    <script>
    (() => {
        // =============================================
        // =========== çŠ¶æ€ç®¡ç†ä¸æ•°æ®å®šä¹‰ ===========
        // =============================================
        let currentView = '';
        let data, columnConfig, columnWidths;
        let isEditing = false;
        let currentCalendarDate = new Date();
        let currentCalendarProjectId = null;

        const workIcons = {
            name: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`,
            property: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>`,
            status: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>`,
            industry: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="M3 21h18M5 21V5l4-4h6l4 4v16"></path><path d="M9 21v-4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v4"></path><path d="M15 7H9"></path></svg>`,
            description: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>`,
            startDate: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>`,
            updatedAt: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`
        };

        const studentIcons = {
            name: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>`,
            curriculum: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="M22 10v6M2 10v6M12 2v20M22 4H2M22 20H2"></path></svg>`,
            discipline: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="m10 10.5 2 2 2-2"></path><path d="m12 12.5 v 4"></path></svg>`,
            subject: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="M12 6.25278V19.7472"></path><path d="M17 10L12 12.5L7 10"></path><path d="M17 15L12 17.5L7 15"></path><path d="M12 2L20 6L12 10L4 6L12 2Z"></path></svg>`,
            school: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>`,
            studentProfile: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>`,
            classSchedule: `<svg xmlns="http://www.w3.org/2000/svg" class="header-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>`,
            progress: `<svg xmlns="http://www.w3.org/2000/svg" class="header-icon-svg" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>`,
            updatedAt: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`,
        };

        const projectModal = document.getElementById('project-modal');
        const configModal = document.getElementById('config-modal');
        const progressModal = document.getElementById('progress-modal');
        const calendarModal = document.getElementById('calendar-modal');
         
        // =============================================
        // =========== ä¸»æ§åˆ¶ä¸åˆ‡æ¢é€»è¾‘ ===========
        // =============================================
         
        function initializeBoard(view) {
            if (currentView === view) return;
            currentView = view;
            document.body.className = `theme-${view}`;
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.getElementById(`nav-${view}`).classList.add('active');
            loadConfig();
            loadWidths();
            loadData();
            const isWork = view === 'work';
            document.getElementById('main-title').textContent = isWork ? 'é¡¹ç›®ç®¡ç†' : 'æ•™å­¦è¿›åº¦';
            document.getElementById('add-btn').textContent = isWork ? '+ æ–°é¡¹ç›®' : '+ æ–°å¢å­¦ç”Ÿ';
            const primaryColor = getComputedStyle(document.body).getPropertyValue('--primary-color');
            const textColor = getComputedStyle(document.body).getPropertyValue('--pill-text-color');
            const deleteColor = currentView === 'work' ? '#991b1b' : '#e74c3c';
            document.getElementById('save-project-btn').style.backgroundColor = primaryColor;
            document.getElementById('save-project-btn').style.color = textColor || 'white';
            document.getElementById('delete-btn').style.backgroundColor = deleteColor;
            document.getElementById('delete-btn').style.color = 'white';
            document.getElementById('save-config-btn').style.borderColor = primaryColor;
            document.getElementById('save-progress-btn').style.backgroundColor = primaryColor;
            document.getElementById('save-progress-btn').style.color = textColor || 'white';
            renderBoard();
        }

        // =============================================
        // =========== æ•°æ®åŠ è½½/ä¿å­˜ (å·²é€‚é…) ===========
        // =============================================

        function getStorageKey(type) { return `${currentView}_kanban_${type}`; }
        function loadConfig() {
            const configJSON = localStorage.getItem(getStorageKey('config'));
            const defaultConfig = currentView === 'work' ? getWorkDefaultColumnConfig() : getStudentDefaultColumnConfig();
            if (configJSON) {
                try {
                    const savedConfig = JSON.parse(configJSON);
                    const defaultConfigMap = new Map(defaultConfig.map(c => [c.key, c]));
                    const migratedConfig = savedConfig.map(savedCol => {
                        const defaultCol = defaultConfigMap.get(savedCol.key);
                        if (defaultCol) return { ...defaultCol, visible: savedCol.visible };
                        return null;
                    }).filter(Boolean);
                    defaultConfig.forEach(defaultCol => {
                        if (!migratedConfig.some(c => c.key === defaultCol.key)) migratedConfig.push(defaultCol);
                    });
                    columnConfig = migratedConfig;
                } catch (e) { columnConfig = defaultConfig; }
            } else { columnConfig = defaultConfig; }
        }
        function saveConfig() { localStorage.setItem(getStorageKey('config'), JSON.stringify(columnConfig)); }
        function loadWidths() {
            const widthsJSON = localStorage.getItem(getStorageKey('widths'));
            const defaultWidths = currentView === 'work' ? getWorkDefaultWidths() : getStudentDefaultWidths();
            const defaultKeys = Object.keys(defaultWidths);

            if (widthsJSON) {
                try {
                    const savedWidths = JSON.parse(widthsJSON);
                    const savedKeys = Object.keys(savedWidths);
                    // æ£€æŸ¥ç¼“å­˜çš„é…ç½®æ˜¯å¦åŒ…å«äº†ä»£ç ä¸­å®šä¹‰çš„æ‰€æœ‰åˆ—
                    if (defaultKeys.every(key => savedKeys.includes(key))) {
                        // å¦‚æœæ˜¯ï¼Œåˆ™ä½¿ç”¨ç¼“å­˜
                        columnWidths = savedWidths;
                    } else {
                        // å¦‚æœä¸æ˜¯ï¼ˆè¯´æ˜ç¼“å­˜æ˜¯æ—§ç‰ˆçš„ï¼‰ï¼Œåˆ™å¼ºåˆ¶ä½¿ç”¨ä»£ç ä¸­çš„æ–°é»˜è®¤å€¼
                        columnWidths = defaultWidths;
                    }
                } catch(e) {
                    columnWidths = defaultWidths;
                }
            } else {
                columnWidths = defaultWidths;
            }
        }
        function saveWidths() { localStorage.setItem(getStorageKey('widths'), JSON.stringify(columnWidths)); }
        function loadData() {
            const dataJSON = localStorage.getItem(getStorageKey('data'));
            const defaultData = currentView === 'work' ? getWorkDefaultData() : getStudentDefaultData();
            if (dataJSON) {
                try { data = JSON.parse(dataJSON); } catch (e) { data = defaultData; }
            } else { data = defaultData; }
        }
        function saveData() { localStorage.setItem(getStorageKey('data'), JSON.stringify(data)); }

        // =============================================
        // =========== å„çœ‹æ¿çš„é»˜è®¤é…ç½®å®šä¹‰ ===========
        // =============================================

        function getWorkDefaultColumnConfig() { 
            return [ 
                { key: 'name', shortLabel: 'é¡¹ç›®åç§°', label: `${workIcons.name} é¡¹ç›®åç§°`, type: 'text', readonly: true, visible: true }, 
                { key: 'property', shortLabel: 'ç±»å‹', label: `${workIcons.property} ç±»å‹`, type: 'select', options: ['è‚¡æƒ', 'å¹¶è´­', 'ä¸è‰¯', 'å…¶ä»–'], visible: true }, 
                { key: 'status', shortLabel: 'é¡¹ç›®è¿›åº¦', label: `${workIcons.status} é¡¹ç›®è¿›åº¦`, type: 'select', options: ['å°šæœªå¼€å§‹', 'åˆæ­¥æ¥è§¦', 'æ­£åœ¨æ¨è¿›', 'é¡ºåˆ©å®Œæˆ', 'å·²ç»æ”¾å¼ƒ'], visible: true }, 
                { key: 'industry', shortLabel: 'è¡Œä¸š', label: `${workIcons.industry} è¡Œä¸š`, type: 'text', visible: true }, 
                { key: 'description', shortLabel: 'é¡¹ç›®ä»‹ç»', label: `${workIcons.description} é¡¹ç›®ä»‹ç»`, type: 'textarea', visible: true }, 
                { key: 'startDate', shortLabel: 'æ¥æ‰‹æ—¶é—´', label: `${workIcons.startDate} æ¥æ‰‹æ—¶é—´`, type: 'date', visible: true }, 
                { key: 'updatedAt', shortLabel: 'æ›´æ–°æ—¶é—´', label: `${workIcons.updatedAt} æ›´æ–°æ—¶é—´`, type: 'readonly', visible: true }, 
            ]; 
        }
        function getWorkDefaultData() {
            return { projects: [{ id: Date.now(), name: "ç¤ºä¾‹é¡¹ç›®ï¼šè¯ºè¯ºæ–°ææ–™", property: "å¹¶è´­", status: "åˆæ­¥æ¥è§¦", industry: "OLEDææ–™", description: "è¯¥å…¬å¸ä¸“æ³¨äºé«˜ç«¯OLEDåˆ†å­ç Œå—å’Œæ–°ææ–™çš„ç ”å‘ã€ç”Ÿäº§å’Œé”€å”®ã€‚", startDate: "2025-08-05", updatedAt: new Date().toISOString() }] };
        }
        function getWorkDefaultWidths() { 
            return { name: '2.5fr', property: '0.8fr', status: '1fr', industry: '1.2fr', description: '4fr', startDate: '1fr', updatedAt: '1.2fr' }; 
        }
        function getStudentDefaultColumnConfig() { 
            return [ 
                { key: 'studentName', shortLabel: 'å­¦ç”Ÿå§“å', label: `${studentIcons.name} å­¦ç”Ÿå§“å`, type: 'text', visible: true }, 
                { key: 'curriculum', shortLabel: 'å›½é™…è¯¾ç¨‹', label: `${studentIcons.curriculum} å›½é™…è¯¾ç¨‹`, type: 'select', options: ['ALEVEL', 'AP', 'IB', 'IGCSE'], visible: true }, 
                { key: 'discipline', shortLabel: 'å­¦ç§‘', label: `${studentIcons.discipline} å­¦ç§‘`, type: 'select', options: ['æ•°å­¦', 'ç‰©ç†', 'åŒ–å­¦', 'ç»æµ'], visible: true }, 
                { key: 'subject', shortLabel: 'ç§‘ç›®', label: `${studentIcons.subject} ç§‘ç›®`, type: 'text', visible: true }, 
                { key: 'school', shortLabel: 'å­¦æ ¡', label: `${studentIcons.school} å­¦æ ¡`, type: 'text', visible: true }, 
                { key: 'studentProfile', shortLabel: 'å­¦ç”Ÿç®€æ¡£', label: `${studentIcons.studentProfile} å­¦ç”Ÿç®€æ¡£`, type: 'textarea', visible: true },
                { key: 'classTime', shortLabel: 'ä¸Šè¯¾æ—¶é—´', label: `ğŸ•’ ä¸Šè¯¾æ—¶é—´`, type: 'action', visible: true },
                { key: 'progress', shortLabel: 'æ•™å­¦è¿›åº¦', label: `${studentIcons.progress} æ•™å­¦è¿›åº¦`, type: 'action', visible: true },
                { key: 'classSchedule', shortLabel: 'ä¸Šè¯¾æ—¥å†', label: `${studentIcons.classSchedule} ä¸Šè¯¾æ—¥å†`, type: 'action', visible: true },
                { key: 'updatedAt', shortLabel: 'æ›´æ–°æ—¶é—´', label: `${studentIcons.updatedAt} æ›´æ–°æ—¶é—´`, type: 'readonly', visible: false }, 
            ]; 
        }
        function getStudentDefaultData() {
            return {
                projects: [{
                    id: Date.now(), studentName: "ç¤ºä¾‹å­¦ç”Ÿ", curriculum: "ALEVEL", discipline: "ç‰©ç†", subject: "åŠ›å­¦å…¥é—¨",
                    school: "XXå›½é™…é«˜ä¸­", studentProfile: "è¯¥åŒå­¦åŸºç¡€è¾ƒå¥½ï¼Œç›®æ ‡G5å¤§å­¦ã€‚",
                    updatedAt: new Date().toISOString(), 
                    progressLog: [{ date: new Date().toISOString(), duration: 1.5, content: "å­¦ä¹ äº†ç‰›é¡¿ç¬¬äºŒå®šå¾‹ F=ma çš„åº”ç”¨åœºæ™¯ã€‚", feedback: "å­¦ç”Ÿå¯¹åŸºæœ¬æ¦‚å¿µæŒæ¡ç‰¢å›ºï¼Œä½†å¤„ç†å¤æ‚å—åŠ›åˆ†ææ—¶ç•¥æœ‰çŠ¹è±«ã€‚", homeworkAssigned: "å®Œæˆç»ƒä¹ å†Œ P25-P28 çš„æ‰€æœ‰é¢˜ç›®ã€‚", homeworkStatus: "å·²å®Œæˆ" }],
                    classDates: [new Date().toISOString().slice(0,10)]
                }]
            };
        }
        function getStudentDefaultWidths() { 
            return { 
                studentName: '130px',
                curriculum: '120px',
                discipline: '100px',
                subject: '100px',
                school: '100px',
                studentProfile: '1fr',
                classTime: '160px',
                classSchedule: '120px',
                progress: '120px',
                updatedAt: '140px'
            }; 
        }

        // =============================================
        // =========== æ¸²æŸ“ä¸äº¤äº’ (æ ¸å¿ƒé€»è¾‘) ===========
        // =============================================
         
        function formatDisplayDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'æ— æ•ˆæ—¥æœŸ';
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (e) { return ''; }
        }
         
        function getGridTemplateColumns() { 
            const visibleColumns = columnConfig.filter(c => c.visible).map(c => columnWidths[c.key] || '1fr');
            return ['50px', ...visibleColumns, '60px'].join(' '); 
        }
         
        function renderBoard() {
            const boardContainer = document.getElementById('board-container');
            boardContainer.innerHTML = '';
            const gridColumns = getGridTemplateColumns();
            const headerRow = document.createElement('div');
            headerRow.className = 'project-header-row';
            headerRow.style.gridTemplateColumns = gridColumns;
            const seqHeader = document.createElement('div');
            seqHeader.className = 'header-cell';
            seqHeader.dataset.key = 'åºå·';
            seqHeader.style.justifyContent = 'center';
            seqHeader.textContent = 'åºå·';
            headerRow.appendChild(seqHeader);
            const visibleColumnConfig = columnConfig.filter(c => c.visible);
            const studentColsToCenter = ['studentName', 'curriculum', 'discipline', 'school', 'progress', 'classTime', 'classSchedule'];
            visibleColumnConfig.forEach(col => { 
                const headerCell = document.createElement('div'); 
                headerCell.className = 'header-cell'; 
                headerCell.innerHTML = col.label;
                headerCell.dataset.key = col.key; 
                headerCell.draggable = true;
                if (currentView === 'student' && studentColsToCenter.includes(col.key)) {
                    headerCell.style.justifyContent = 'center';
                }
                const resizeHandle = document.createElement('div'); 
                resizeHandle.className = 'resize-handle'; 
                headerCell.appendChild(resizeHandle); 
                headerRow.appendChild(headerCell); 
            });
            headerRow.innerHTML += '<div class="header-cell" data-key="actions" style="justify-content:center;">æ“ä½œ</div>';
            boardContainer.appendChild(headerRow);
            initColumnDragAndDrop(headerRow);
            data.projects.forEach((project, index) => { 
                const projectRow = createProjectRow(project, gridColumns, index + 1);
                boardContainer.appendChild(projectRow);
            });
        }

        function createProjectRow(project, gridColumns, rowNumber) {
            const projectRow = document.createElement('div');
            projectRow.className = 'project-row';
            projectRow.dataset.projectId = project.id;
            projectRow.style.gridTemplateColumns = gridColumns;
            const sequenceCell = document.createElement('div');
            sequenceCell.className = 'cell drag-handle-cell';
            sequenceCell.style.textAlign = 'center';
            sequenceCell.textContent = rowNumber;
            projectRow.appendChild(sequenceCell);
            const visibleColumnConfig = columnConfig.filter(c => c.visible);
            const studentColsToCenter = ['studentName', 'curriculum', 'discipline', 'subject', 'school', 'progress', 'classSchedule']; // æ–°å¢ 'subject'
            visibleColumnConfig.forEach(col => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.key = col.key;
                let value = project[col.key] || '';
                const nameKey = currentView === 'work' ? 'name' : 'studentName';
                if (currentView === 'student' && studentColsToCenter.includes(col.key)) {
                    cell.style.textAlign = 'center';
                }
                if (['updatedAt', 'startDate', 'enrollmentDate'].includes(col.key)) {
                    value = formatDisplayDate(value); 
                }
                if (col.type === 'select') {
                    cell.innerHTML = `<span class="pill" data-value="${value}">${value}</span>`;
                } else if (col.key === nameKey) {
                    cell.innerHTML = `<span class="cell-name-span">${value}</span>`;

                } else if (col.key === 'classTime') {
                    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                    if (project.classTime && project.classTime.day != null) {
                        const dayName = dayNames[project.classTime.day] || '';
                        const startTime = project.classTime.start || '';
                        const endTime = project.classTime.end || '';
                        // ç¡®ä¿åœ¨æ—¶é—´ä¸å®Œæ•´çš„æƒ…å†µä¸‹ä¹Ÿèƒ½ä¼˜é›…æ˜¾ç¤º
                        cell.textContent = `${dayName} ${startTime && endTime ? `${startTime}-${endTime}` : (startTime || endTime)}`;
                    } else {
                        cell.textContent = '';
                    }

                } else if (col.key === 'progress' || col.key === 'classSchedule') {
                    const emoji = col.key === 'progress' ? 'ğŸ’¬' : 'ğŸ—“ï¸';
                    const title = col.key === 'progress' ? 'æŸ¥çœ‹/ç¼–è¾‘æ•™å­¦è¿›åº¦' : 'æŸ¥çœ‹/ç¼–è¾‘ä¸Šè¯¾æ—¥å†';
                    cell.innerHTML = `<span class="action-btn" title="${title}">${emoji}</span>`;
                }
                else {
                    cell.textContent = value;
                }
                cell.title = project[col.key] || '';
                projectRow.appendChild(cell);
            });
            const actionCell = document.createElement('div');
            actionCell.className = 'cell action-cell';
            actionCell.style.textAlign = 'center';
            const editBtn = document.createElement('button');
            editBtn.className = 'edit-btn action-btn';
            editBtn.innerHTML = 'â€¢â€¢â€¢';
            editBtn.title = `ç¼–è¾‘${currentView === 'work' ? 'é¡¹ç›®' : 'å­¦ç”Ÿ'}ä¿¡æ¯`;
            editBtn.style.background = 'none';
            editBtn.style.border = 'none';
            actionCell.appendChild(editBtn);
            projectRow.appendChild(actionCell);
            editBtn.addEventListener('click', e => { e.stopPropagation(); openProjectModal(project.id); });
            const progressBtn = projectRow.querySelector('[title*="æ•™å­¦è¿›åº¦"]');
            if(progressBtn) {
                progressBtn.addEventListener('click', e => { e.stopPropagation(); openProgressModal(project.id); });
            }
            const calendarBtn = projectRow.querySelector('[title*="ä¸Šè¯¾æ—¥å†"]');
            if(calendarBtn) {
                calendarBtn.addEventListener('click', e => { e.stopPropagation(); openCalendarModal(project.id); });
            }
            projectRow.querySelectorAll('.cell[data-key]').forEach(cell => {
                const key = cell.dataset.key;
                const config = columnConfig.find(c => c.key === key);
                if (config && !config.readonly && config.type !== 'action') {
                    cell.addEventListener('click', () => createInPlaceEditor(cell, project, key));
                }
            });
            return projectRow;
        }

        function openProjectModal(projectId = null) {
            const formFields = document.getElementById('project-form-fields');
            formFields.innerHTML = '';
            const editableColumns = columnConfig.filter(c => c.type !== 'readonly' && c.type !== 'action' && c.key !== 'classTime');
            editableColumns.forEach(col => {
                const label = document.createElement('label');
                label.textContent = `${col.shortLabel}:`;
                let input;
                if (col.type === 'select') {
                    input = document.createElement('select');
                    col.options.forEach(opt => { input.innerHTML += `<option value="${opt}">${opt}</option>`; });
                } else if (col.type === 'textarea') {
                    input = document.createElement('textarea');
                    input.rows = 4;
                } else {
                    input = document.createElement('input');
                    input.type = col.type;
                }
                input.id = `form-${col.key}`;
                formFields.appendChild(label);
                formFields.appendChild(input);
            });
            // --- ä»è¿™é‡Œå¼€å§‹æ’å…¥ ---
            if (currentView === 'student') {
                const dayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
                formFields.innerHTML += `
                    <label>ä¸Šè¯¾æ—¶é—´:</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <select id="form-classTime-day">
                            <option value="">é€‰æ‹©æ˜ŸæœŸ</option>
                            ${dayNames.map((day, index) => `<option value="${index}">${day}</option>`).join('')}
                        </select>
                        <input type="time" id="form-classTime-start">
                        <input type="time" id="form-classTime-end">
                    </div>
                `;
            }
                    // --- ä»è¿™é‡Œå¼€å§‹æ’å…¥ ---
                    if (currentView === 'student' && project.classTime) {
                        document.getElementById('form-classTime-day').value = project.classTime.day;
                        document.getElementById('form-classTime-start').value = project.classTime.start;
                        document.getElementById('form-classTime-end').value = project.classTime.end;
                    }
                    // --- æ’å…¥ç»“æŸ ---

            
            const deleteBtn = document.getElementById('delete-btn');
            deleteBtn.style.display = 'none';
            const form = document.getElementById('project-form');
            form.reset();
            if (projectId) {
                const project = data.projects.find(p => p.id == projectId);
                document.getElementById('modal-title').textContent = `ç¼–è¾‘${currentView === 'work' ? 'é¡¹ç›®' : 'å­¦ç”Ÿ'}ä¿¡æ¯`;
                document.getElementById('project-id').value = projectId;
                editableColumns.forEach(col => { document.getElementById(`form-${col.key}`).value = project[col.key] || ''; });
                    // --- ä»è¿™é‡Œå¼€å§‹æ’å…¥ ---
                    if (currentView === 'student' && project.classTime) {
                        document.getElementById('form-classTime-day').value = project.classTime.day;
                        document.getElementById('form-classTime-start').value = project.classTime.start;
                        document.getElementById('form-classTime-end').value = project.classTime.end;
                    }
                    // --- æ’å…¥ç»“æŸ ---
                deleteBtn.style.display = 'inline-block';
            } else {
                document.getElementById('modal-title').textContent = `æ–°å¢${currentView === 'work' ? 'é¡¹ç›®' : 'å­¦ç”Ÿ'}`;
                document.getElementById('project-id').value = '';
            }
            projectModal.style.display = 'flex';
        }

        function openProgressModal(projectId) {
            if (currentView !== 'student') return;
            const project = data.projects.find(p => p.id == projectId);
            if (!project) return;
            if (!Array.isArray(project.progressLog)) { project.progressLog = []; }
            const modalBody = document.getElementById('progress-modal-body');
            const modalContent = progressModal.querySelector('.modal-content');
            modalBody.classList.remove('side-by-side');
            modalContent.classList.remove('side-by-side-mode');
            document.getElementById('progress-modal-title').textContent = `${project.studentName} - æ•™å­¦è¿›åº¦`;
            const logList = document.getElementById('progress-log-list');
            logList.innerHTML = '';
            const logsWithOriginalIndex = project.progressLog.map((log, index) => ({ ...log, originalIndex: index }));
            const sortedLogs = logsWithOriginalIndex.sort((a, b) => new Date(b.date) - new Date(a.date));
            sortedLogs.forEach(log => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'progress-log-entry';
                entryDiv.innerHTML = `<div class="log-entry-header"><span class="log-entry-date" data-key="date">${formatDisplayDate(log.date)}</span><span class="log-entry-duration" data-key="duration">æ—¶é•¿: ${log.duration || 'N/A'} å°æ—¶</span></div><dl class="log-entry-body"><dt>ä¸Šè¯¾å†…å®¹:</dt><dd data-key="content">${log.content || 'æœªè®°å½•'}</dd><dt>åé¦ˆä¸è¡¨ç°:</dt><dd data-key="feedback">${log.feedback || 'æœªè®°å½•'}</dd><dt>ä½œä¸šå¸ƒç½®:</dt><dd data-key="homeworkAssigned">${log.homeworkAssigned || 'æ— '}</dd><dt>ä½œä¸šå®Œæˆæƒ…å†µ:</dt><dd data-key="homeworkStatus" data-homework-status="${log.homeworkStatus || ''}">${log.homeworkStatus || 'æœªè®°å½•'}</dd></dl><button class="delete-log-btn" title="åˆ é™¤æ­¤æ¡è®°å½•">Ã—</button>`;                logList.appendChild(entryDiv);
                entryDiv.querySelectorAll('[data-key]').forEach(elem => {
                    elem.addEventListener('click', (e) => createLogEntryEditor(e.currentTarget, project, log.originalIndex, elem.dataset.key));
                });

                entryDiv.querySelector('.delete-log-btn').addEventListener('click', () => {
                    if (confirm('ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡æ•™å­¦è®°å½•å—ï¼Ÿ')) {
                        project.progressLog.splice(log.originalIndex, 1);
                        project.updatedAt = new Date().toISOString();
                        saveData();
                        openProgressModal(project.id);
                    }
                });
            });
            document.getElementById('progress-log-form').dataset.projectId = projectId;
            document.getElementById('progress-log-form').reset();
            document.getElementById('new-log-date').valueAsDate = new Date();
            document.getElementById('new-log-homework-status').value = 'å¾…æ£€æŸ¥';
            progressModal.style.display = 'flex';
        }

        function createLogEntryEditor(element, project, logIndex, key) {
            const modalBody = document.getElementById('progress-modal-body');
            // å¦‚æœæ˜¯åˆ†æ æ¨¡å¼ï¼Œåˆ™ä¸å…è®¸ç¼–è¾‘ï¼Œç›´æ¥é€€å‡ºå‡½æ•°
            if (modalBody.classList.contains('side-by-side')) {
                return; 
            }

            if (element.querySelector('.log-inline-editor')) return;
            isEditing = true;
            const logEntry = project.progressLog[logIndex];
            if (!logEntry) { isEditing = false; return; }
            
            element.childNodes.forEach(node => { if(node.style) node.style.visibility = 'hidden' });

            const computedStyle = window.getComputedStyle(element);
            
            const editorContainer = document.createElement('div');
            editorContainer.className = 'log-inline-editor';
            let editor;

            switch (key) {
                case 'homeworkStatus':
                    editor = document.createElement('select');
                    ['å·²å®Œæˆ', 'éƒ¨åˆ†å®Œæˆ', 'æœªæäº¤', 'å¾…æ£€æŸ¥'].forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt; option.textContent = opt;
                        if (opt === logEntry.homeworkStatus) option.selected = true;
                        editor.appendChild(option);
                    });
                    break;
                case 'content': case 'feedback':
                    editor = document.createElement('textarea');
                    editor.value = logEntry[key] || '';
                    break;
                default:
                    editor = document.createElement('input');
                    editor.type = (key === 'date') ? 'date' : (key === 'duration' ? 'number' : 'text');
                    if (key === 'duration') { editor.step = '0.5'; editor.min = '0'; }
                    editor.value = (key === 'date' && logEntry[key]) ? new Date(logEntry[key]).toISOString().slice(0, 10) : (logEntry[key] || '');
                    break;
            }
            editor.style.width = computedStyle.width;
            editor.style.height = computedStyle.height;

            const cleanupAndRefresh = (shouldSave) => {
                if (shouldSave) {
                    logEntry[key] = (key === 'duration') ? (parseFloat(editor.value) || null) : editor.value;
                    project.updatedAt = new Date().toISOString();
                    saveData();
                }
                isEditing = false;
                openProgressModal(project.id);
            };

            editor.addEventListener('blur', () => cleanupAndRefresh(true));
            editor.addEventListener('keydown', e => {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); editor.blur(); } 
                else if (e.key === 'Escape') { cleanupAndRefresh(false); }
            });

            editorContainer.appendChild(editor);
            element.appendChild(editorContainer);
            editor.focus();
        }

        function createInPlaceEditor(cell, project, key) {
            const config = columnConfig.find(c => c.key === key);
            if (!config || cell.querySelector('.inline-editor')) return;
            isEditing = true;
            Array.from(cell.childNodes).forEach(node => {
                if (node.style) {
                    node.style.visibility = 'hidden';
                } else if (node.nodeType === Node.TEXT_NODE) {
                    // å¯¹äºçº¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªç©ºçš„spanæ¥åŒ…è£¹å®ƒä»¥ä¾¿éšè—
                    const span = document.createElement('span');
                    span.textContent = node.textContent;
                    span.style.visibility = 'hidden';
                    cell.replaceChild(span, node);
                }
            });
            
            const editorContainer = document.createElement('div');
            editorContainer.className = 'inline-editor';
            let editor;

            if (config.type === 'select') {
                editor = document.createElement('select');
                config.options.forEach(opt => { 
                    const option = document.createElement('option'); 
                    option.value = opt; option.textContent = opt; 
                    if (opt === project[key]) option.selected = true; 
                    editor.appendChild(option); 
                });
            } else {
                editor = document.createElement('input');
                editor.type = config.type;
                editor.value = project[key] || '';
            }
            
            const cleanup = (shouldSave) => {
                if (shouldSave) {
                    project[key] = editor.value;
                    project.updatedAt = new Date().toISOString();
                    saveData();
                }
                isEditing = false;
                renderBoard();
            };

            editor.addEventListener('blur', () => cleanup(true));
            editor.addEventListener('keydown', e => {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); editor.blur(); } 
                else if (e.key === 'Escape') { cleanup(false); }
            });
            
            editorContainer.appendChild(editor);
            cell.appendChild(editorContainer);
            editor.focus();
        }
        
        function initColumnDragAndDrop(headerRow) {
            const headers = Array.from(headerRow.querySelectorAll('.header-cell[draggable="true"]'));
            let draggedItem = null;
            headers.forEach(header => {
                header.addEventListener('dragstart', (e) => {
                    draggedItem = e.target.closest('.header-cell');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', draggedItem.dataset.key);
                });
                header.addEventListener('dragover', (e) => { e.preventDefault(); });
                header.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const targetItem = e.target.closest('.header-cell');
                    if (!targetItem || !targetItem.draggable) return;
                    const draggedKey = e.dataTransfer.getData('text/plain');
                    const targetKey = targetItem.dataset.key;
                    if (draggedKey && targetKey && draggedKey !== targetKey) {
                        const draggedIndex = columnConfig.findIndex(col => col.key === draggedKey);
                        const targetIndex = columnConfig.findIndex(col => col.key === targetKey);
                        if (draggedIndex > -1 && targetIndex > -1) {
                            const [removed] = columnConfig.splice(draggedIndex, 1);
                            columnConfig.splice(targetIndex, 0, removed);
                            saveConfig();
                            renderBoard();
                        }
                    }
                });
            });
        }
        
        // =============================================
        // =========== æ—¥å†åŠŸèƒ½ ===========
        // =============================================
        function openCalendarModal(projectId) {
            currentCalendarProjectId = projectId;
            currentCalendarDate = new Date();
            calendarModal.classList.remove('calendar-editing');
            document.getElementById('edit-schedule-btn').classList.remove('active');
            renderCalendar();
            calendarModal.style.display = 'flex';
        }

        function renderCalendar() {
            const project = data.projects.find(p => p.id == currentCalendarProjectId);
            if (!project) return;
            if (!Array.isArray(project.classDates)) { project.classDates = []; }
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            document.getElementById('calendar-month-year').textContent = `${year} å¹´ ${month + 1} æœˆ`;
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].forEach(day => {
                grid.innerHTML += `<div class="day-header">${day}</div>`;
            });
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDayOfMonth; i++) {
                grid.innerHTML += `<div class="day-cell"></div>`;
            }
            for (let i = 1; i <= daysInMonth; i++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell current-month-day';
                dayCell.textContent = i;
                const fullDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                dayCell.dataset.date = fullDate;
                if (project.classDates.includes(fullDate)) {
                    dayCell.classList.add('taught');
                }
                dayCell.addEventListener('click', () => {
                    if (!calendarModal.classList.contains('calendar-editing')) return;
                    if (project.classDates.includes(fullDate)) {
                        project.classDates = project.classDates.filter(d => d !== fullDate);
                    } else {
                        project.classDates.push(fullDate);
                    }
                    project.updatedAt = new Date().toISOString();
                    saveData();
                    renderCalendar();
                });
                grid.appendChild(dayCell);
            }
        }

        // =============================================
        // =========== äº‹ä»¶ç›‘å¬ä¸åˆå§‹åŒ– ===========
        // =============================================
         
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('nav-work').addEventListener('click', () => initializeBoard('work'));
            document.getElementById('nav-student').addEventListener('click', () => initializeBoard('student'));
             
            [projectModal, configModal, progressModal, calendarModal].forEach(modal => {
                modal.addEventListener('click', e => { if (e.target === modal && !isEditing) modal.style.display = 'none'; });
            });
            document.getElementById('add-btn').addEventListener('click', () => openProjectModal(null));

            document.getElementById('project-form').addEventListener('submit', e => {
                e.preventDefault();
                const projectId = document.getElementById('project-id').value;
                const projectData = {};
                // åŒæ ·åœ¨è¿™é‡Œè¿‡æ»¤æ‰ classTimeï¼Œå› ä¸ºå®ƒéœ€è¦ç‰¹æ®Šå¤„ç†
                columnConfig.filter(c => c.type !== 'readonly' && c.type !== 'action' && c.key !== 'classTime').forEach(col => {
                    const input = document.getElementById(`form-${col.key}`);
                    if(input) projectData[col.key] = input.value;
                });

                // --- ä»è¿™é‡Œå¼€å§‹æ’å…¥ä¿å­˜â€œä¸Šè¯¾æ—¶é—´â€çš„é€»è¾‘ ---
                if (currentView === 'student') {
                    const day = document.getElementById('form-classTime-day').value;
                    const start = document.getElementById('form-classTime-start').value;
                    const end = document.getElementById('form-classTime-end').value;

                    if (day !== "") { // åªæœ‰åœ¨é€‰æ‹©äº†æ˜ŸæœŸæ—¶æ‰ä¿å­˜
                        projectData.classTime = {
                            day: parseInt(day, 10), // å°†æ˜ŸæœŸçš„å€¼è½¬æ¢ä¸ºæ•°å­—
                            start: start,
                            end: end
                        };
                    } else {
                        projectData.classTime = null; // å¦‚æœæœªé€‰æ‹©ï¼Œåˆ™å­˜ä¸º null
                    }
                }
                // --- æ’å…¥ç»“æŸ ---

                projectData.updatedAt = new Date().toISOString();
                if (projectId) {
                    const pIndex = data.projects.findIndex(p => p.id == projectId);
                    data.projects[pIndex] = { ...data.projects[pIndex], ...projectData };
                } else {
                    projectData.id = Date.now();
                    if(currentView === 'student'){
                       projectData.classDates = [];
                    }
                    data.projects.unshift(projectData);
                }
                saveData();
                renderBoard();
                projectModal.style.display = 'none';
            });

            document.getElementById('delete-btn').addEventListener('click', () => {
                const projectId = document.getElementById('project-id').value;
                const typeText = currentView === 'work' ? 'é¡¹ç›®' : 'å­¦ç”Ÿ';
                if (confirm(`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤æ­¤${typeText}çš„æ‰€æœ‰è®°å½•å—ï¼Ÿ`)) {
                    data.projects = data.projects.filter(p => p.id != projectId);
                    saveData();
                    renderBoard();
                    projectModal.style.display = 'none';
                }
            });

            document.getElementById('show-add-log-form-btn').addEventListener('click', (e) => {
                const modalBody = document.getElementById('progress-modal-body');
                const modalContent = e.target.closest('.modal-content');
                modalBody.classList.add('side-by-side');
                modalContent.classList.add('side-by-side-mode');
            });

            document.getElementById('return-to-log-list-btn').addEventListener('click', (e) => {
                const modalBody = document.getElementById('progress-modal-body');
                const modalContent = e.target.closest('.modal-content');
                modalBody.classList.remove('side-by-side');
                modalContent.classList.remove('side-by-side-mode');
            });
            
            document.getElementById('progress-log-form').addEventListener('submit', e => {
                e.preventDefault();
                if (currentView !== 'student') return;
                const projectId = e.currentTarget.dataset.projectId;
                if (!projectId) return;
                const project = data.projects.find(p => p.id == projectId);
                if (project) {
                    const newLog = {
                        date: document.getElementById('new-log-date').value,
                        duration: parseFloat(document.getElementById('new-log-duration').value) || null,
                        content: document.getElementById('new-log-content').value.trim(),
                        feedback: document.getElementById('new-log-feedback').value.trim(),
                        homeworkAssigned: document.getElementById('new-log-homework').value.trim(),
                        homeworkStatus: document.getElementById('new-log-homework-status').value
                    };
                    if (!Array.isArray(project.progressLog)) { project.progressLog = []; }
                    project.progressLog.push(newLog);
                    project.updatedAt = new Date().toISOString();
                    saveData(); 
                    renderBoard(); 
                    openProgressModal(projectId);
                }
            });

            document.getElementById('config-btn').addEventListener('click', () => {
                const container = document.getElementById('config-form-fields');
                container.innerHTML = '';
                columnConfig.forEach(col => {
                    const row = document.createElement('div');
                    row.className = 'config-row';
                    row.style.display = 'grid';
                    row.style.gridTemplateColumns = '1fr 60px';
                    row.style.alignItems = 'center';
                    const label = document.createElement('label');
                    label.htmlFor = `config-check-${col.key}`;
                    label.innerHTML = col.label;
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `config-check-${col.key}`;
                    checkbox.checked = col.visible;
                    row.appendChild(label);
                    row.appendChild(checkbox);
                    container.appendChild(row);
                });
                configModal.style.display = 'flex';
            });
            document.getElementById('save-config-btn').addEventListener('click', () => {
                columnConfig.forEach(col => {
                    const checkbox = document.getElementById(`config-check-${col.key}`);
                    if (checkbox) col.visible = checkbox.checked;
                });
                saveConfig();
                renderBoard();
                configModal.style.display = 'none';
            });

            document.getElementById('export-btn').addEventListener('click', () => {
                const exportData = { config: columnConfig, widths: columnWidths, data: data };
                const dataStr = JSON.stringify(exportData, null, 2);
                const link = document.createElement('a');
                link.download = `${currentView}_kanban_backup_${new Date().toISOString().slice(0,10)}.json`;
                link.href = URL.createObjectURL(new Blob([dataStr], {type: "application/json"}));
                link.click();
                URL.revokeObjectURL(link.href);
            });
            const importInput = document.getElementById('import-input');
            document.getElementById('import-btn').addEventListener('click', () => importInput.click());
            importInput.addEventListener('change', e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if (imported.data && imported.data.projects && imported.config && imported.widths) {
                            if (confirm('å¯¼å…¥æ•°æ®å°†ä¼šè¦†ç›–å½“å‰çœ‹æ¿çš„æ‰€æœ‰å†…å®¹ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
                                data = imported.data;
                                columnConfig = imported.config;
                                columnWidths = imported.widths;
                                saveData(); saveConfig(); saveWidths();
                                renderBoard();
                                alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                            }
                        } else { alert('å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ã€‚'); }
                    } catch (err) { alert('å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„JSONã€‚'); }
                };
                reader.readAsText(file);
                e.target.value = '';
            });

            // æ—¥å†æŒ‰é’®äº‹ä»¶
            document.getElementById('prev-month-btn').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar();
            });
            document.getElementById('next-month-btn').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar();
            });
            document.getElementById('edit-schedule-btn').addEventListener('click', (e) => {
                calendarModal.classList.toggle('calendar-editing');
                e.currentTarget.classList.toggle('active');
            });
            
            initializeBoard('work');
        });
    })();
    </script>

</body>
</html>