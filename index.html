<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœ‹æ¿</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ============================================= */
        /* =========== åŸºç¡€å¸ƒå±€ & ä¾§è¾¹æ æ ·å¼ =========== */
        /* ============================================= */
        body {
            margin: 0;
            font-size: 14px;
            user-select: none;
            overflow-x: hidden; /* é˜²æ­¢æ°´å¹³æ»šåŠ¨æ¡ */
        }
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 220px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            padding: 1.5rem 0;
            transition: all 0.3s ease;
        }
        .sidebar-header {
            padding: 0 1.5rem;
            margin-bottom: 2.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .sidebar-logo {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
        }
        .sidebar-title {
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: 1px;
        }
        .sidebar-nav {
            padding: 0 1rem;
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.85rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .nav-icon {
            width: 20px;
            height: 20px;
            margin-right: 1rem;
            stroke-width: 2;
        }
        .main-content {
            flex-grow: 1;
            padding: 2rem 4rem;
            transition: background-color 0.3s ease;
        }
        #main-title {
              margin: 0;
              font-weight: 600;
        }

        /* é€šç”¨UIç»„ä»¶æ ·å¼ */
        .controls { display: flex; align-items: center; gap: 1.25rem; }
        .header-btn {
            display: inline-flex; align-items: center; justify-content: center; height: 40px; padding: 0;
            border: none; font-weight: 500; font-size: 14px; cursor: pointer; transition: all 0.2s ease-in-out;
            overflow: hidden; color: white;
        }
        .header-btn:hover { transform: translateY(-2px); }
        .btn-text { padding: 0 0.75rem 0 1rem; letter-spacing: 0.5px; }
        .btn-icon { width: 40px; height: 100%; display: flex; align-items: center; justify-content: center; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; justify-content: center; align-items: center; }
        .modal-content { padding: 2rem; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .modal-actions { margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 1rem; }
         
        .project-table-wrapper { overflow-x: auto; }
        .project-table { border-collapse: collapse; width: 100%;}
        .project-row, .project-header-row { display: grid; align-items: center; border-bottom: 1px solid var(--border-color); min-height: 58px; }
        .project-table .project-row:last-child { border-bottom: none; }
        .project-header-row { position: sticky; top: 0; z-index: 20; font-size: 14px; font-weight: 600; }
        .cell, .header-cell { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding: 1rem 1rem; position: relative; border-right: 1px solid var(--border-color); min-width: 30px; }
        .cell:last-child, .header-cell:last-child { border-right: none; }
        .header-cell { cursor: grab; display: flex; align-items: center; gap: 8px; }
        .action-cell, .header-cell[data-key="actions"] { position: sticky; right: 0; z-index: 15; }
        .resize-handle { display: none; } /* ç¦ç”¨è°ƒæ•´å®½åº¦åŠŸèƒ½ */
        .header-icon-svg { width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; flex-shrink: 0; }
        .bottom-controls-container { padding-top: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .add-project-btn { padding: 0.5rem; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; border-radius: 6px; }
        .inline-editor { position: absolute; top: 2px; left: 2px; right: 2px; bottom: 2px; z-index: 10; }
        .inline-editor input, .inline-editor select { width: 100%; height: 100%; border-radius: 3px; font-size: 14px; box-sizing: border-box; }

        /* æ–°å¢ï¼šæ‹–æ‹½æ’åºç›¸å…³æ ·å¼ */
        .project-row.dragging {
            opacity: 0.5;
            background: var(--hover-bg);
        }
        .drag-over {
            border-top: 2px solid var(--primary-color);
        }
        .seq-cell { /* ä¸ºåºå·å•å…ƒæ ¼å¢åŠ å¯æ‹–æ‹½çš„å…‰æ ‡ */
            cursor: move;
        }

        /* ============================================= */
        /* =========== ä¸»é¢˜ä¸€: æ·±ç©ºå•†åŠ¡ (å·¥ä½œ) =========== */
        /* ============================================= */
        .theme-work {
            --bg-color: #111827; --text-color: #d1d5db; --text-color-secondary: #9ca3af;
            --border-color: #374151; --header-bg: #1f2937; --hover-bg: #2b3a50;
            --primary-color: #3b82f6; --sidebar-bg: #0f172a; --sidebar-text: #94a3b8;
            --sidebar-hover-bg: #1e293b; --sidebar-active-bg: #3b82f6; --sidebar-active-text: #ffffff;
            --modal-bg: #1f2937;
            --pill-text-color: white;
            --btn-config-color: #8b5cf6; --btn-export-color: #10b981; --btn-import-color: #6b7280;
        }
        .theme-work .sidebar { background-color: var(--sidebar-bg); }
        .theme-work .sidebar-logo { background-color: var(--primary-color); color: white; }
        .theme-work .sidebar-title { color: #f1f5f9; }
        .theme-work .nav-item { color: var(--sidebar-text); }
        .theme-work .nav-item:hover { background-color: var(--sidebar-hover-bg); color: #e2e8f0; }
        .theme-work .nav-item.active { background-color: var(--sidebar-active-bg); color: var(--sidebar-active-text); font-weight: 600;}
        .theme-work .main-content { background-color: var(--bg-color); color: var(--text-color); font-family: 'Inter', sans-serif;}
        .theme-work #main-title { color: #f9fafb; }
        .theme-work .header-btn { border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2); }
        .theme-work .btn-icon { background-color: rgba(255,255,255,0.05); }
        .theme-work #config-btn { background-color: var(--btn-config-color); }
        .theme-work #export-btn { background-color: var(--btn-export-color); }
        .theme-work #import-btn { background-color: var(--btn-import-color); }
        .theme-work .project-table-wrapper { border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); background-color: var(--header-bg); }
        .theme-work .project-header-row { color: #e5e7eb; background-color: #2b3a50; border-bottom: 2px solid var(--border-color); }
        .theme-work .modal { background-color: rgba(17, 24, 39, 0.6); backdrop-filter: blur(4px); }
        .theme-work .modal-content { background-color: var(--modal-bg); border-radius: 8px; border: 1px solid var(--border-color); color: var(--text-color); }
        .theme-work .cell-name-span { font-weight: 500; color: #f9fafb; }
        .theme-work .pill { padding: 3px 12px; font-size: 12px; font-weight: 500; display: inline-block; border-radius: 999px; }
        .theme-work .pill[data-value="å°šæœªå¼€å§‹"] { background-color: #374151; color: #d1d5db; }
        .theme-work .pill[data-value="åˆæ­¥æ¥è§¦"] { background-color: #1e3a8a; color: #dbeafe; }
        .theme-work .pill[data-value="æ­£åœ¨æ¨è¿›"] { background-color: #92400e; color: #fef3c7; }
        .theme-work .pill[data-value="é¡ºåˆ©å®Œæˆ"] { background-color: #064e3b; color: #d1fae5; }
        .theme-work .pill[data-value="å·²ç»æ”¾å¼ƒ"] { background-color: #4b5563; color: #9ca3af; }
        .theme-work .pill[data-value="è‚¡æƒ"] { background-color: #115e59; color: #ccfbf1; }
        .theme-work .pill[data-value="å¹¶è´­"] { background-color: #4c1d95; color: #ede9fe; }
        .theme-work .pill[data-value="ä¸è‰¯"] { background-color: #7c2d12; color: #ffedd5; }
        .theme-work .pill[data-value="å…¶ä»–"] { background-color: #334155; color: #e2e8f0; }
        .theme-work #project-form-fields input, .theme-work #project-form-fields select, .theme-work #project-form-fields textarea { background-color: #2b3a50; color: var(--text-color); border: 1px solid var(--border-color); border-radius: 6px; padding: 0.75rem;}
        .theme-work .add-project-btn { color: var(--text-color-secondary); font-weight: 500; }
        .theme-work .add-project-btn:hover { background-color: var(--header-bg); color: #f9fafb; }
        .theme-work .inline-editor input, .theme-work .inline-editor select { font-family: 'Inter', sans-serif; background-color: #111827; color: var(--text-color); border: 2px solid var(--primary-color);}
        .theme-work .action-btn { color: #6b7280; }

        /* ============================================= */
        /* =========== ä¸»é¢˜äºŒ: å­¦é™¢ç»¿èŒµ (æ•™å­¦) =========== */
        /* ============================================= */
        .theme-student {
            --bg-color: #f4f8f7; --text-color: #2c3e50; --border-color: #dce4e1;
            --header-bg: #eaf3f0; --hover-bg: #f0f5f3; --primary-color: #27ae60;
            --sidebar-bg: #ffffff; --sidebar-text: #34495e;
            --sidebar-hover-bg: #f3f9f6; --sidebar-active-bg: #27ae60; --sidebar-active-text: #ffffff;
            --modal-bg: #ffffff;
            --btn-config-color: #8e44ad; --btn-export-color: #2980b9; --btn-import-color: #7f8c8d;
        }
        .theme-student .sidebar { background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); }
        .theme-student .sidebar-logo { background-color: var(--primary-color); color: white; }
        .theme-student .sidebar-title { color: #16a085; }
        .theme-student .nav-item { color: var(--sidebar-text); }
        .theme-student .nav-item:hover { background-color: var(--sidebar-hover-bg); color: var(--primary-color); }
        .theme-student .nav-item.active { background-color: var(--sidebar-active-bg); color: var(--sidebar-active-text); font-weight: 600; }
        .theme-student .main-content {
            background-color: var(--bg-color); color: var(--text-color); font-family: 'Noto Sans SC', sans-serif;
            background-image: linear-gradient(rgba(45, 174, 96, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(45, 174, 96, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .theme-student #main-title { color: #16a085; }
        .theme-student .header-btn { border-radius: 99px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
        .theme-student .btn-icon { background-color: rgba(0,0,0,0.1); }
        .theme-student #config-btn { background-color: var(--btn-config-color); }
        .theme-student #export-btn { background-color: var(--btn-export-color); }
        .theme-student #import-btn { background-color: var(--btn-import-color); }
        .theme-student .project-table-wrapper { border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .theme-student .project-header-row { color: #34495e; background-color: var(--header-bg); border-bottom: 2px solid #b2d8c4; border-top-left-radius: 12px; border-top-right-radius: 12px; }
        .theme-student .action-cell, .theme-student .header-cell[data-key="actions"] { background-color: var(--bg-color); border-left: 1px solid #c8d5d1;}
        .theme-student .project-header-row .header-cell[data-key="actions"] { background-color: var(--header-bg); }
        .theme-student .modal { background-color: rgba(44, 62, 80, 0.4); }
        .theme-student .modal-content { background-color: var(--modal-bg); border-radius: 12px; }
        
        /* --- æ–°å¢ï¼šä¸ºå­¦ç”Ÿç¼–è¾‘å¼¹çª—è®¾ç½®æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢è¿‡åˆ†æ‹‰ä¼¸ --- */
        .theme-student #project-modal .modal-content {
            max-width: 650px;
        }
        
        #config-modal .modal-content { max-width: 500px; width: 100%; }
        
        /* --- ä¸ºâ€œä¿å­˜é…ç½®â€æŒ‰é’®å®šä¹‰ä¸¤ç§ä¸»é¢˜ä¸‹çš„ä¸åŒæ ·å¼ --- */

        /* 1. å·¥ä½œçœ‹æ¿ (æ·±è‰²ä¸»é¢˜)ä¸‹çš„â€œä¿å­˜é…ç½®â€æŒ‰é’®ï¼šä¿æŒå®å¿ƒã€æœ‰è´¨æ„Ÿçš„æ ·å¼ */
        .theme-work #save-config-btn {
            background-color: var(--primary-color);
            color: #ffffff;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .theme-work #save-config-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            filter: brightness(1.1);
        }

        /* æœ€ç»ˆç‰ˆï¼šâ€œå¹½çµâ€æŒ‰é’® v2 - å¼ºè°ƒå‘¼å¸æ„Ÿå’Œè½»ç›ˆæ„Ÿ */
        .theme-student #save-config-btn {
            background-color: transparent;
            /* --- æ ¸å¿ƒæ”¹åŠ¨ï¼šè¿›ä¸€æ­¥é™ä½é€æ˜åº¦ï¼Œæ›´åƒâ€œå¹½çµâ€ --- */
            border: 1px solid rgba(39, 174, 96, 0.3); 
            color: rgba(39, 174, 96, 0.65);
            
            box-shadow: 0 2px 4px rgba(39, 174, 96, 0.35);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.25s ease-in-out;
            
            /* --- æ ¸å¿ƒæ”¹åŠ¨ï¼šè§£å†³æ‹¥æŒ¤ï¼Œè¥é€ â€œå‘¼å¸æ„Ÿâ€ --- */
            font-size: 11px; /* å­—ä½“å†å°ä¸€ç‚¹ */
            font-weight: 500; /* å­—é‡é™ä½ï¼Œæ›´æ˜¾è½»ç›ˆ */
            letter-spacing: 0.5px; /* æ‹‰å¼€å­—ç¬¦é—´è· */
            padding: 6px 20px; /* å‚ç›´å˜çª„ï¼Œæ°´å¹³å˜å®½ï¼Œè®©æ–‡å­—èˆ’å±• */
        }

        /* æ‚¬åœæ—¶çš„â€œæ‰å®â€æ„Ÿä¿æŒä¸å˜ */
        .theme-student #save-config-btn:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: #ffffff;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(39, 174, 96, 0.25);
        }

        #config-form-fields label { display: inline-flex; align-items: center; gap: 8px; }
        .theme-student .cell { font-weight: 500; }
        .theme-student .cell-name-span { color: #2c3e50; }
        
        .theme-student .pill { padding: 4px 14px; font-size: 12px; display: inline-block; border-radius: 16px; border: 1px solid transparent; }
        .theme-student .pill[data-value="ALEVEL"] { background-color: #eafaf1; color: #1e8449; border-color: #a3d9b8; }
        .theme-student .pill[data-value="AP"] { background-color: #e8f6f3; color: #117864; border-color: #9edad8; }
        .theme-student .pill[data-value="IB"] { background-color: #fef5e7; color: #d35400; border-color: #f5cba7; }
        .theme-student .pill[data-value="IGCSE"] { background-color: #f4ecf7; color: #884ea0; border-color: #d7bde2; }
        .theme-student .pill[data-value="æ•°å­¦"] { background-color: #eaf2f8; color: #2980b9; border-color: #a9cce3; }
        .theme-student .pill[data-value="ç‰©ç†"] { background-color: #fdedec; color: #c0392b; border-color: #f5b7b1; }
        .theme-student .pill[data-value="åŒ–å­¦"] { background-color: #ebf5fb; color: #2471a3; border-color: #aed6f1; }
        .theme-student .pill[data-value="ç»æµ"] { background-color: #f6eefc; color: #7d3c98; border-color: #dcbbf4; }

        .theme-student #project-form-fields input, .theme-student #project-form-fields select, .theme-student #project-form-fields textarea {
            /* æ–°å¢ä¸‹é¢è¿™ä¸¤è¡Œ */
            box-sizing: border-box; /* å…³é”®ï¼šç¡®ä¿ padding å’Œ border ä¸ä¼šæ’‘å¤§ç›’å­ */
            height: 44px;           /* å…³é”®ï¼šå¼ºåˆ¶æ‰€æœ‰è¾“å…¥æ¡†é«˜åº¦ç»Ÿä¸€ */

            /* ä»¥ä¸‹æ˜¯åŸæœ‰æ ·å¼ï¼Œä¿æŒä¸å˜ */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
        }

        .theme-student .add-project-btn { color: #34495e; font-weight: 500;}
        .theme-student .add-project-btn:hover { background-color: #eaf3f0; color: #16a085; }
        .theme-student .inline-editor input, .theme-student .inline-editor select { font-family: 'Noto Sans SC', sans-serif; border: 2px solid var(--primary-color);}
        .theme-student .action-btn { cursor: pointer; padding: 2px; border-radius: 8px; transition: all 0.2s; vertical-align: middle; display: inline-flex; align-items: center; color: #95a5a6; flex-shrink: 0; font-size: 18px;}
        .theme-student .action-btn:hover { background-color: #ecf0f1; color: var(--primary-color); }
        
        /* æ•™å­¦è¿›åº¦å¼¹çª—æ ·å¼ */
        .theme-student #progress-modal .modal-content { max-width: 800px; transition: max-width 0.4s ease; }
        .theme-student #progress-modal-body.side-by-side ~ .modal-content, .theme-student #progress-modal .modal-content.side-by-side-mode { max-width: 1200px; }
        .theme-student #progress-modal-body { display: flex; gap: 2rem; }
        .theme-student #progress-log-list-wrapper { width: 100%; transition: width 0.4s ease; position: relative; padding-bottom: 50px; }
        .theme-student #progress-modal-body.side-by-side #progress-log-list-wrapper { width: 50%; padding-bottom: 0;}
        .theme-student #progress-log-list { max-height: 60vh; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; background-color: #fdfefe; }
        .theme-student #progress-log-list:empty::after { content: 'æš‚æ— æ•™å­¦è®°å½•ï¼Œè¯·åœ¨ä¸‹æ–¹æ·»åŠ ç¬¬ä¸€æ¡ã€‚'; color: #95a5a6; text-align: center; display: block; padding: 3rem 0; }
        .theme-student #show-add-log-form-btn { position: absolute; bottom: 0; right: 0; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; padding: 0.6rem 1.2rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .theme-student #show-add-log-form-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .theme-student #progress-modal-body.side-by-side #show-add-log-form-btn { display: none; }
        .theme-student #progress-log-form { display: none; width: 0; transition: width 0.4s ease; }
        .theme-student #progress-modal-body.side-by-side #progress-log-form { display: block; width: 50%; }
        .theme-student .progress-log-entry { position: relative; border-bottom: 1px solid var(--border-color); padding: 1.5rem 0.5rem; }
        .theme-student .progress-log-entry:last-child { border-bottom: none; }
        .theme-student .log-entry-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; }
        .theme-student .log-entry-date { position: relative; font-weight: 700; font-size: 1.1em; color: var(--text-color); }
        .theme-student .log-entry-duration { position: relative; font-size: 13px; color: #7f8c8d; background-color: #ecf0f1; padding: 3px 10px; border-radius: 12px; }
        .theme-student .log-entry-body { display: grid; grid-template-columns: 115px 1fr; gap: 0.8rem 1rem; font-size: 14px; }
        .theme-student .log-entry-body dt { font-weight: 500; color: #34495e; text-align: right; padding-right: 1rem; border-right: 2px solid var(--header-bg);}
        .theme-student .log-entry-body dd { position: relative; margin: 0; white-space: pre-wrap; word-break: break-word; line-height: 1.6; }
        .theme-student dd[data-homework-status="å·²å®Œæˆ"] { color: #27ae60; font-weight: 500; }
        .theme-student dd[data-homework-status="éƒ¨åˆ†å®Œæˆ"] { color: #f39c12; font-weight: 500; }
        .theme-student dd[data-homework-status="æœªæäº¤"] { color: #e74c3c; font-weight: 500; }
        .theme-student dd[data-homework-status="å¾…æ£€æŸ¥"] { color: #3498db; font-weight: 500; }
        .theme-student #progress-log-form { border-left: 1px solid var(--border-color); padding-left: 2rem; max-height: 65vh; overflow-y: auto;}
        .theme-student #progress-log-form h3 { margin-top: 0; margin-bottom: 1.5rem; font-size: 16px; font-weight: 700;}
        .theme-student .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem 1.5rem; }
        .theme-student .form-field { display: flex; flex-direction: column; }
        .theme-student .form-field.full-width { grid-column: 1 / -1; }
        .theme-student .form-field label { font-weight: 500; margin-bottom: 0.5rem; font-size: 13px; color: #34495e;}
        .theme-student .form-field input, .theme-student .form-field select, .theme-student .form-field textarea {
            width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px;
            box-sizing: border-box; font-family: 'Noto Sans SC', sans-serif; font-size: 14px; transition: all 0.2s;
        }
        .theme-student .form-field input:focus, .theme-student .form-field select:focus, .theme-student .form-field textarea:focus {
            border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1); outline: none;
        }
        .theme-student .delete-log-btn {
            position: absolute;
            bottom: 1rem;
            right: 0.5rem;
            width: 28px;
            height: 28px;
            background-color: #fdedec;
            color: #c0392b;
            border: 1px solid #f5b7b1;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s ease-in-out;
            font-size: 16px;
            font-weight: bold;
        }
        .theme-student .progress-log-entry:hover .delete-log-btn { opacity: 1; }
        .theme-student .delete-log-btn:hover { background-color: #e74c3c; color: white; transform: scale(1.1); }
        .theme-student .log-inline-editor { position: absolute; top: 0; left: 0; z-index: 1010; }
        .theme-student .log-inline-editor input, 
        .theme-student .log-inline-editor select, 
        .theme-student .log-inline-editor textarea {
             box-sizing: border-box;
             font-family: 'Noto Sans SC', sans-serif;
             font-size: inherit;
             line-height: inherit;
             border-radius: 4px;
             border: 2px solid var(--primary-color);
             padding: 0 2px;
             resize: none;
        }
/* --- æ–°å¢ï¼šä¸ºå†å²è®°å½•æ¡ç›®æ·»åŠ å¯ç‚¹å‡»å…‰æ ‡ --- */
        .theme-student .log-entry-date,
        .theme-student .log-entry-duration,
        .theme-student .log-entry-body dd {
            cursor: pointer;
        }

        /* --- æ–°å¢ï¼šå½“è¿›å…¥åˆ†æ æ¨¡å¼æ—¶ï¼Œå–æ¶ˆå¯ç‚¹å‡»å…‰æ ‡ --- */
        .theme-student #progress-modal-body.side-by-side .log-entry-date,
        .theme-student #progress-modal-body.side-by-side .log-entry-duration,
        .theme-student #progress-modal-body.side-by-side .log-entry-body dd {
            cursor: default;
        }

/* ============================================= */
        /* =========== æ—¥å†ç›¸å…³æ ·å¼ (æœ€ç»ˆä¿®æ­£ç‰ˆ) ======== */
        /* ============================================= */

        /* --- å­¦ç”Ÿä¸ªäººä¸Šè¯¾æ—¥å† (#calendar-modal) --- */
        #calendar-modal .modal-content { max-width: 500px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .calendar-header h2 { margin: 0; font-size: 1.2rem; font-weight: 600; color: #34495e;}
        .calendar-header button { background: none; border: 1px solid transparent; border-radius: 6px; padding: 0.4rem 0.8rem; cursor: pointer; transition: all 0.2s; font-weight: 500; }
        .calendar-header button:hover { background-color: #ecf0f1; }
        #edit-schedule-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        #calendar-grid .day-header, #calendar-grid .day-cell { padding: 0.5rem; border-radius: 8px; }
        #calendar-grid .day-header { font-weight: 600; color: #95a5a6; font-size: 13px; }
        #calendar-grid .day-cell { color: #7f8c8d; }
        #calendar-grid .current-month-day { color: var(--text-color); }
        #calendar-grid .day-cell.taught { background-color: #a3d9b8; color: #1e8449; font-weight: bold; }
        #calendar-modal.calendar-editing .current-month-day { cursor: pointer; }
        #calendar-modal.calendar-editing .current-month-day:hover { background-color: #eafaf1; }

        /* --- æ•™å¸ˆæœˆè¡¨ (#schedule-modal) --- */
        .theme-student #weekly-schedule-btn { background-color: #1abc9c; }
        .theme-student #schedule-modal .modal-content {
            max-width: 90vw;
            width: 1200px;
            padding: 2rem 2.5rem;
        }
        #schedule-modal-header {
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 0 0.5rem;
        }
        #schedule-class-count {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            background-color: #eafaf1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #a3d9b8;
        }
        #schedule-modal-title {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-weight: 700;
            font-size: 1.5rem;
            color: #2c3e50;
            margin: 0;
        }
        #schedule-controls button {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        #schedule-controls button:hover {
            background-color: #ecf0f1;
            border-color: #bdc3c7;
        }

        #mark-dates-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .monthly-schedule-grid.marking-mode .day-cell.not-current-month {
            cursor: not-allowed;
        }
        .monthly-schedule-grid.marking-mode .day-cell {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .monthly-schedule-grid.marking-mode .day-cell:hover {
            background-color: #f0f5f3;
        }
        .monthly-schedule-grid .day-cell.holiday {
            background-color: #fef5e7; /* æ·¡é»„è‰²èƒŒæ™¯è¡¨ç¤ºå‡æ—¥ */
        }
        .monthly-schedule-grid .day-cell.special-workday {
            background-color: #eafaf1; /* æ·¡ç»¿è‰²èƒŒæ™¯è¡¨ç¤ºç‰¹æ®Šå·¥ä½œæ—¥ */
        }
        

        .monthly-schedule-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border-top: 1px solid var(--border-color);
            border-left: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }
        .monthly-schedule-grid .day-header, .monthly-schedule-grid .day-cell {
            padding: 8px;
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }
        .monthly-schedule-grid .day-header {
            font-weight: 600;
            text-align: center;
            background-color: var(--header-bg);
            color: #34495e;
        }
        .monthly-schedule-grid .day-cell {
            min-height: 120px;
            background-color: #fdfdfd;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
        }
        .monthly-schedule-grid .day-cell.not-current-month { background-color: #f9fafb; color: #bdc3c7; }
        .monthly-schedule-grid .day-number {
            font-weight: 600;
            font-size: 13px;
            color: #7f8c8d;
            margin-bottom: 4px;
        }
        .monthly-schedule-grid .day-cell.not-current-month .day-number { color: #dce4e1; }
        .class-entries-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .class-entry {
            border-left: 4px solid;
            border-radius: 4px;
            padding: 5px 8px;
            width: 100%;
            text-align: left;
            box-sizing: border-box;
            line-height: 1.4;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
        }
        
        .class-entry-content-wrapper {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .drag-handle {
            width: 10px;
            height: 16px;
            cursor: grab;
            opacity: 0.2;
            transition: opacity 0.2s;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="6" height="12" viewBox="0 0 6 12"><circle cx="2" cy="2" r="1.5" fill="%23555" /><circle cx="2" cy="6" r="1.5" fill="%23555" /><circle cx="2" cy="10" r="1.5" fill="%23555" /></svg>');
            background-repeat: no-repeat;
            background-position: center;
            flex-shrink: 0;
            margin-right: 6px;
        }

        .class-entry:hover .drag-handle {
            opacity: 0.8;
        }
        
        .drag-handle:active {
            cursor: grabbing;
        }
        
        .class-entry.inactive {
            background-color: #f1f2f6 !important; /* Use !important to override inline style */
            border-left: none;
            padding-left: 12px;
            color: #a4b0be !important; /* Use !important to override inline style */
            text-decoration: line-through;
        }
        .class-entry-time {
            font-weight: 700;
            font-size: 13px;
            margin-right: 5px;
        }
        .student-name {
            font-weight: 500;
            font-size: 12px;
            padding-left: 2px;
        }
        
        /* --- æ’¤é”€æç¤ºæ¡ (Toast) ä¸ æ—¶é—´ç¼–è¾‘å™¨ --- */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background-color: #2c3e50;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            opacity: 0;
            transform: translateY(20px);
            animation: toast-in 0.5s forwards;
        }
        @keyframes toast-in { to { opacity: 1; transform: translateY(0); } }
        .toast-undo-btn {
            background: none;
            border: none;
            color: #3498db;
            font-weight: 600;
            cursor: pointer;
            padding: 5px;
            font-size: 14px;
        }
        .time-editor {
            position: absolute;
            background-color: white;
            border: 2px solid var(--primary-color);
            border-radius: 6px;
            padding: 8px;
            z-index: 1010;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .time-editor input[type="time"] {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 4px;
            font-size: 13px;
            width: 90px;
        }



/* --- æ–°å¢ï¼šé¡µè„šç‰ˆæœ¬ä¸æ—¶é—´ä¿¡æ¯æ ·å¼ --- */
        #info-footer {
            /* é»˜è®¤é¢œè‰²ï¼Œé€‚ç”¨äºäº®è‰²ä¸»é¢˜ */
            color: #6b7280;
            z-index: 999;
        }
        #time-line {
            color: #9ca3af;
        }
        /* åœ¨æ·±è‰²ä¸»é¢˜ä¸‹è‡ªåŠ¨åè½¬é¢œè‰² */
        .theme-work #info-footer {
            color: #9ca3af;
        }
        .theme-work #time-line {
            color: #6b7280;
        }

    </style>
</head>
<body>

    <div class="dashboard-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">K</div>
                <div class="sidebar-title">çœ‹æ¿</div>
            </div>
            <nav class="sidebar-nav">
                <a class="nav-item" id="nav-work">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
                    <span>é¡¹ç›®çœ‹æ¿</span>
                </a>
                <a class="nav-item" id="nav-student">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                    <span>æ•™è‚²çœ‹æ¿</span>
                </a>
                <a class="nav-item" id="instructions-btn" style="margin-top: 2rem;">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    <span>ä½¿ç”¨è¯´æ˜</span>
                </a>
            </nav>
        </div>

        <main class="main-content">
            <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h1 id="main-title"></h1>
                <div class="controls">
                    <button class="header-btn" id="config-btn">
                        <span class="btn-text">çœ‹æ¿é…ç½®</span>
                        <span class="btn-icon">
                            <svg style="width: 20px; height: 20px; stroke-width: 1.5;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19-.15-.24-.42-.12-.64l2 3.46c.12-.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69-.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65z"></path><circle cx="12" cy="12" r="3.5"></circle></svg>
                        </span>
                    </button>
                    <button class="header-btn" id="export-btn">
                        <span class="btn-text">å¤‡ä»½æ•°æ®</span>
                        <span class="btn-icon">
                            <svg style="width: 20px; height: 20px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M5 20h14v-2H5v2zm7-18L5.33 9h3.58v6h6.18V9h3.58L12 2z"></path></svg>
                        </span>
                    </button>
                    <input type="file" id="import-input" accept=".json" style="display: none;">
                    <button class="header-btn" id="import-btn">
                        <span class="btn-text">æ¢å¤æ•°æ®</span>
                        <span class="btn-icon">
                            <svg style="width: 20px; height: 20px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M5 20h14v-2H5v2zM12 2l6.67 7h-3.58v6h-6.18V9H5.33L12 2z" transform="rotate(180 12 12)"></path></svg>
                        </span>
                    </button>
                    <button class="header-btn" id="weekly-schedule-btn" style="display: none;"> 
                        <span class="btn-text">ç”Ÿæˆæœˆè¡¨</span>
                        <span class="btn-icon">
                            <svg style="width: 20px; height: 20px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line><path d="M7 14h.01"></path><path d="M12 14h.01"></path><path d="M17 14h.01"></path><path d="M7 18h.01"></path><path d="M12 18h.01"></path><path d="M17 18h.01"></path></svg>
                        </span>
                    </button>
                </div>
            </header>

            <div class="project-table-wrapper">
                <div class="project-table" id="board-container"></div>
            </div>
            <div class="bottom-controls-container">
                <a class="add-project-btn" id="add-btn"></a>
            </div>
        </main>
    </div>

    <div id="project-modal" class="modal">
        <div class="modal-content">
            <form id="project-form">
                <h2 id="modal-title"></h2>
                <input type="hidden" id="project-id" value="">
                <div id="project-form-fields" style="display: grid; grid-template-columns: 100px 1fr; gap: 1.5rem; align-items: center; margin-top: 2.5rem;"></div>
                <div class="modal-actions">
                    <button type="submit" id="save-project-btn" style="border: none; padding: 0.6rem 1.2rem; border-radius: 6px; font-weight: 500; cursor: pointer;">ä¿å­˜</button>
                    <button type="button" id="delete-btn" style="border: none; padding: 0.6rem 1.2rem; border-radius: 6px; font-weight: 500; display: none; cursor: pointer;">åˆ é™¤</button>
                </div>
            </form>
        </div>
    </div>
    <div id="config-modal" class="modal">
         <div class="modal-content">
            <h2 style="font-weight: 600;">çœ‹æ¿é…ç½®</h2>
            <div id="config-form-fields" style="display: flex; flex-direction: column; gap: 1rem; padding: 2rem 1rem;"></div>
            <div class="modal-actions">
                <button type="button" id="save-config-btn" >ä¿å­˜é…ç½®</button>
            </div>
        </div>
    </div>
    <div id="progress-modal" class="modal">
        <div class="modal-content">
            <h2 id="progress-modal-title" style="font-weight: 600;"></h2>
            <div id="progress-modal-body">
                <div id="progress-log-list-wrapper">
                    <div id="progress-log-list"></div>
                    <button id="show-add-log-form-btn">+ æ·»åŠ æ–°è®°å½•</button>
                </div>
                <form id="progress-log-form">
                    <h3>æ·»åŠ æ–°æ•™å­¦è®°å½•</h3>
                    <div class="form-grid">
                        <div class="form-field">
                            <label for="new-log-date">ä¸Šè¯¾æ—¥æœŸ</label>
                            <input type="date" id="new-log-date" required>
                        </div>
                        <div class="form-field">
                            <label for="new-log-duration">ä¸Šè¯¾æ—¶é•¿ (å°æ—¶)</label>
                            <input type="number" id="new-log-duration" step="0.5" min="0" placeholder="ä¾‹å¦‚: 1.5">
                        </div>
                        <div class="form-field full-width">
                            <label for="new-log-content">ä¸Šè¯¾å†…å®¹</label>
                            <textarea id="new-log-content" rows="3" placeholder="ç®€è¿°æœ¬æ¬¡è¯¾çš„æ ¸å¿ƒå†…å®¹..."></textarea>
                        </div>
                        <div class="form-field full-width">
                            <label for="new-log-feedback">åé¦ˆä¸è¡¨ç°</label>
                            <textarea id="new-log-feedback" rows="2" placeholder="è®°å½•å­¦ç”Ÿçš„äº®ç‚¹ä¸å¾…æ”¹è¿›ä¹‹å¤„..."></textarea>
                        </div>
                        <div class="form-field">
                            <label for="new-log-homework">ä½œä¸šå¸ƒç½®</label>
                            <input type="text" id="new-log-homework" placeholder="ä¾‹å¦‚: å®Œæˆç»ƒä¹ å†ŒP25-28">
                        </div>
                        <div class="form-field">
                            <label for="new-log-homework-status">ä½œä¸šå®Œæˆæƒ…å†µ</label>
                            <select id="new-log-homework-status">
                                <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                                <option value="éƒ¨åˆ†å®Œæˆ">éƒ¨åˆ†å®Œæˆ</option>
                                <option value="æœªæäº¤">æœªæäº¤</option>
                                <option value="å¾…æ£€æŸ¥" selected>å¾…æ£€æŸ¥</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-actions" style="margin-top: 1.5rem;">
                        <button type="button" id="return-to-log-list-btn" style="background-color: #f0f0f0; padding: 0.6rem 1.2rem; border-radius: 6px; font-weight: 500; cursor: pointer; border: 1px solid #ccc;">è¿”å›</button>
                        <button type="submit" id="save-progress-btn" style="border: none; padding: 0.6rem 1.2rem; border-radius: 6px; font-weight: 500; cursor: pointer;">ä¿å­˜è®°å½•</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="calendar-modal" class="modal">
        <div class="modal-content">
            <div class="calendar-header">
                <div>
                    <button id="prev-month-btn">â—€</button>
                    <button id="next-month-btn">â–¶</button>
                </div>
                <h2 id="calendar-month-year"></h2>
                <button id="edit-schedule-btn">ç¼–è¾‘</button>
            </div>
            <div id="calendar-grid"></div>
        </div>
    </div>

    <div id="calendar-modal" class="modal">
        {...}
    </div>
    
    <div id="schedule-modal" class="modal">
        <div class="modal-content">
            <div id="schedule-modal-header">
                <div id="schedule-class-count"></div>
                <h2 id="schedule-modal-title"></h2>
                <div id="schedule-controls">
                    <button id="mark-dates-btn">æ ‡è®°</button>
                    <button id="schedule-prev-month-btn">â—€</button>
                    <button id="schedule-next-month-btn">â–¶</button>
                </div>
            </div>
            <div id="schedule-grid-container">
                </div>
        </div>
    </div>

    <div id="info-footer" style="position: fixed; left: 50%; bottom: 12px; transform: translateX(-50%); z-index: 999; text-align: center;">
        <div id="version-line" style="font-size: 12px; margin-bottom: 6px;"></div>
        <div id="time-line" style="font-size: 11px;"></div>
    </div>    
    <div id="toast-container"></div>
    <div id="instructions-modal" class="modal">
        
        <div class="modal-content" style="max-width: 800px; width: 90%;">
            <h2 style="text-align: center; font-weight: 600; margin-top: 0; margin-bottom: 2rem;">æ•™å­¦çœ‹æ¿ä½¿ç”¨è¯´æ˜</h2>
            <div id="instructions-content" style="line-height: 1.8; max-height: 70vh; overflow-y: auto; padding-right: 1rem;">
                <p>æ¬¢è¿ä½¿ç”¨æ•™å­¦çœ‹æ¿ï¼è¿™æ˜¯ä¸€ä¸ªä¸“ä¸ºæ‚¨è¿›è¡Œä¸ªæ€§åŒ–æ•™å­¦ç®¡ç†è€Œè®¾è®¡çš„æœ¬åœ°åŒ–å·¥å…·ã€‚æ‚¨çš„æ‰€æœ‰æ•°æ®éƒ½å®‰å…¨åœ°å­˜å‚¨åœ¨æ‚¨è‡ªå·±çš„æµè§ˆå™¨ä¸­ï¼Œä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨ã€‚</p>
                
                <h3 style="font-weight: 600; margin-top: 2rem;">ä¸€ã€ ä¸»ç•Œé¢æ ¸å¿ƒåŠŸèƒ½</h3>
                <ul style="padding-left: 20px; margin-bottom: 0;">
                    <li><strong>å­¦ç”Ÿåˆ—è¡¨</strong>ï¼šä¸»ç•Œé¢ä»¥è¡¨æ ¼å½¢å¼å±•ç¤ºæ‚¨æ‰€æœ‰çš„å­¦ç”Ÿè®°å½•ã€‚</li>
                    <li><strong>æ‹–æ‹½æ’åº</strong>ï¼š<strong>é•¿æŒ‰</strong>æ¯è¡Œæœ€å·¦ä¾§çš„<strong>åºå·</strong>å•å…ƒæ ¼ï¼Œä¸Šä¸‹æ‹–åŠ¨ï¼Œå³å¯è°ƒæ•´å­¦ç”Ÿè®°å½•çš„æ˜¾ç¤ºé¡ºåºã€‚</li>
                    <li><strong>è¡Œå†…ç¼–è¾‘</strong>ï¼šå•å‡»è¡¨æ ¼ä¸­çš„å¤§éƒ¨åˆ†å­—æ®µï¼ˆå¦‚å­¦ç”Ÿå§“åã€å¹´çº§ã€å­¦æ ¡ç­‰ï¼‰ï¼Œå³å¯ç›´æ¥åœ¨è¡¨æ ¼å†…è¿›è¡Œä¿®æ”¹ã€‚ä¿®æ”¹åæŒ‰ <code>Enter</code> ä¿å­˜ï¼ŒæŒ‰ <code>Esc</code> å–æ¶ˆã€‚</li>
                    <li><strong>æ·»åŠ /ç¼–è¾‘å­¦ç”Ÿ</strong>ï¼šç‚¹å‡»å·¦ä¸‹è§’çš„â€œ<strong>+ æ–°å¢å­¦ç”Ÿ</strong>â€æŒ‰é’®æ¥åˆ›å»ºæ–°å­¦ç”Ÿï¼›ç‚¹å‡»æ¯è¡Œæœ€å³ä¾§çš„â€œ<strong>â€¢â€¢â€¢</strong>â€æŒ‰é’®æ¥ç¼–è¾‘è¯¦ç»†ä¿¡æ¯ã€‚</li>
                </ul>
                <div style="border-bottom: 1px solid var(--border-color); margin-top: 2rem;"></div>

                <h3 style="font-weight: 600; margin-top: 2rem;">äºŒã€ å­¦ç”Ÿä¸“å±åŠŸèƒ½æ¨¡å—</h3>
                <p>åœ¨ä¸»çœ‹æ¿çš„æ¯ä¸€è¡Œï¼Œéƒ½æœ‰ä¸¤ä¸ªé‡è¦çš„åŠŸèƒ½å…¥å£ï¼š</p>
                <ul style="padding-left: 20px; margin-bottom: 0;">
                    <li><strong>æ•™å­¦è¿›åº¦ (ğŸ’¬)</strong>ï¼šç‚¹å‡»å¯æ‰“å¼€è¯¥å­¦ç”Ÿçš„ä¸“å±æ•™å­¦æ—¥å¿—ï¼Œæ”¯æŒæ–°å¢ã€æŸ¥çœ‹å’Œä¿®æ”¹ã€‚</li>
                    <li><strong>ä¸Šè¯¾æ—¥å† (ğŸ—“ï¸)</strong>ï¼šç‚¹å‡»å¯æ‰“å¼€ä¸ªäººæ—¥å†ï¼Œç”¨äºæ‰‹åŠ¨æ ‡è®°<strong>å®é™…å·²ä¸Š</strong>çš„è¯¾ç¨‹ã€‚</li>
                </ul>
                <div style="border-bottom: 1px solid var(--border-color); margin-top: 2rem;"></div>

                <h3 style="font-weight: 600; margin-top: 2rem;">ä¸‰ã€ å…¨å±€æ•™å­¦æœˆå† (æ ¸å¿ƒåŠŸèƒ½)</h3>
                <p>ç‚¹å‡»é¡µé¢å³ä¸Šè§’çš„â€œ<strong>ç”Ÿæˆæœˆè¡¨</strong>â€æŒ‰é’®ï¼Œå¯ä»¥æ‰“å¼€æ±‡æ€»äº†æ‰€æœ‰å­¦ç”Ÿå‘¨æœŸæ€§è¯¾ç¨‹çš„å…¨å±€æœˆå†ã€‚</p>
                <ul style="padding-left: 20px; margin-bottom: 0;">
                    <li><strong>æŸ¥çœ‹è¯¾æ—¶</strong>ï¼šå·¦ä¸Šè§’çš„æ•°å­—ä»£è¡¨å½“å‰æœˆä»½çš„æ€»è¯¾æ—¶æ•°ã€‚</li>
                    <li><strong>ä¿®æ”¹æ—¶é—´ | å·¦é”®å•å‡»</strong>ï¼š<strong>å•å‡»</strong>ä»»æ„è¯¾ç¨‹ï¼Œä¼šå¼¹å‡ºæ—¶é—´ç¼–è¾‘å™¨ã€‚åœ¨ç¼–è¾‘å™¨ä¸­ï¼Œç”¨é¼ æ ‡<strong>æ»šè½®</strong>å¯å¿«é€Ÿè°ƒæ•´æ—¶é—´ã€‚</li>
                    <li><strong>ç§»åŠ¨è¯¾ç¨‹ | æ‹–æ‹½æ‰‹æŸ„</strong>ï¼šé¼ æ ‡æ‚¬åœåœ¨è¯¾ç¨‹ä¸Šï¼Œ<strong>æŒ‰ä½</strong>å…¶æœ€å·¦ä¾§æµ®ç°çš„ <strong>â ¿</strong> å›¾æ ‡å¹¶æ‹–åŠ¨ï¼Œå¯å°†è¯¾ç¨‹ç§»åŠ¨åˆ°æ–°æ—¥æœŸã€‚</li>
                    <li><strong>éšè—è¯¾ç¨‹ | ä¸­é”®å•å‡»</strong>ï¼šç”¨<strong>é¼ æ ‡ä¸­é”®</strong>ï¼ˆæ»šè½®ï¼‰å•å‡»ä»»æ„è¯¾ç¨‹ï¼Œå¯å°†å…¶éšè—ã€‚</li>
                    <li><strong>æ’¤é”€æ“ä½œ</strong>ï¼šéšè—è¯¾ç¨‹åï¼Œå³ä¸‹è§’ä¼šå¼¹å‡ºå¸¦ã€æ’¤é”€ã€‘æŒ‰é’®çš„æç¤ºã€‚æ‚¨ä¹Ÿå¯ä»¥éšæ—¶ä½¿ç”¨é”®ç›˜ <code>Ctrl+Z</code> æ¥æ’¤é”€ã€‚</li>
                    <li><strong>æ ‡è®°å‡æ—¥/å·¥ä½œæ—¥</strong>ï¼šç‚¹å‡»æœˆå†å³ä¸Šè§’çš„â€œ<strong>æ ‡è®°</strong>â€æŒ‰é’®è¿›å…¥æ ‡è®°æ¨¡å¼ï¼Œç„¶åå•å‡»æ—¥æœŸå³å¯åœ¨â€œå¸¸è§„â€â†’â€œå‡æ—¥â€(é»„)â†’â€œç‰¹æ®Šå·¥ä½œæ—¥â€(ç»¿)ä¸‰ç§çŠ¶æ€é—´åˆ‡æ¢ã€‚</li>
                </ul>
                <div style="border-bottom: 1px solid var(--border-color); margin-top: 2rem;"></div>

                 <h3 style="font-weight: 600; margin-top: 2rem;">å››ã€ æ•°æ®ç®¡ç†</h3>
                 <p>åˆ©ç”¨å³ä¸Šè§’çš„ã€çœ‹æ¿é…ç½®ã€‘ã€ã€å¤‡ä»½æ•°æ®ã€‘ã€ã€æ¢å¤æ•°æ®ã€‘æŒ‰é’®ï¼Œå¯ä»¥ç®¡ç†çœ‹æ¿çš„æ˜¾ç¤ºåˆ—å’Œè¿›è¡Œæ•°æ®å®‰å…¨å¤‡ä»½ã€‚</p>
            </div>
        </div>
    </div>
    <script>
    
    (() => {
        // =============================================
        // =========== çŠ¶æ€ç®¡ç†ä¸æ•°æ®å®šä¹‰ ===========
        // =============================================

        function displayVersionAndTime() {
            // 1. ç‰ˆæœ¬ä¿¡æ¯ (å¯åœ¨æ­¤æ‰‹åŠ¨ä¿®æ”¹)
            const versionInfo = {
                version: "æ•™å­¦çœ‹æ¿ v1.1.2",
                last_updated: "[2025-09-04]"
            };
            const versionLine = document.getElementById('version-line');
            if (versionLine) {
                versionLine.innerHTML = `${versionInfo.version} &nbsp; ${versionInfo.last_updated}`;
            }

            // 2. åŠ¨æ€æœ¬åœ°æ—¶é’Ÿ
            const timeLine = document.getElementById('time-line');
            function updateClock() {
                if (!timeLine) return;
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth() + 1;
                const day = now.getDate();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const timezoneOffset = -now.getTimezoneOffset() / 60;
                const timezoneSign = timezoneOffset >= 0 ? '+' : '-';
                const timezoneStr = `UTC${timezoneSign}${Math.abs(timezoneOffset)}`;
                const timestamp = `${year}/${month}/${day} ${hours}:${minutes}`;
                timeLine.textContent = `${timestamp} ${timezoneStr}`;
            }
            updateClock();
            setInterval(updateClock, 60000);
        }
        
        let currentView = '';
        let data, columnConfig, columnWidths;
        let isEditing = false;
        let currentCalendarDate = new Date();
        let currentCalendarProjectId = null;
        let currentScheduleDate = new Date();
        
        const workIcons = {
            name: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`,
            property: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>`,
            status: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>`,
            industry: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="M3 21h18M5 21V5l4-4h6l4 4v16"></path><path d="M9 21v-4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v4"></path><path d="M15 7H9"></path></svg>`,
            description: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>`,
            startDate: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>`,
            updatedAt: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`
        };

        const studentIcons = {
            name: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>`,
            curriculum: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="M22 10v6M2 10v6M12 2v20M22 4H2M22 20H2"></path></svg>`,
            discipline: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="m10 10.5 2 2 2-2"></path><path d="m12 12.5 v 4"></path></svg>`,
            subject: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="M12 6.25278V19.7472"></path><path d="M17 10L12 12.5L7 10"></path><path d="M17 15L12 17.5L7 15"></path><path d="M12 2L20 6L12 10L4 6L12 2Z"></path></svg>`,
            school: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>`,
            studentProfile: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>`,
            classSchedule: `<svg xmlns="http://www.w3.org/2000/svg" class="header-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>`,
            progress: `<svg xmlns="http://www.w3.org/2000/svg" class="header-icon-svg" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>`,
            updatedAt: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`,
        };

        const projectModal = document.getElementById('project-modal');
        const configModal = document.getElementById('config-modal');
        const progressModal = document.getElementById('progress-modal');
        const calendarModal = document.getElementById('calendar-modal');
        const scheduleModal = document.getElementById('schedule-modal');
        const instructionsModal = document.getElementById('instructions-modal')      
        
        
        // =============================================
        // =========== ä¸»æ§åˆ¶ä¸åˆ‡æ¢é€»è¾‘ ===========
        // =============================================
         
        function initializeBoard(view) {
            if (currentView === view) return;
            currentView = view;
            document.body.className = `theme-${view}`;
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.getElementById(`nav-${view}`).classList.add('active');
            loadConfig();
            loadWidths();
            loadData();
            const isWork = view === 'work';
            document.getElementById('main-title').textContent = isWork ? 'é¡¹ç›®ç®¡ç†' : 'æ•™å­¦è¿›åº¦';
            document.getElementById('add-btn').textContent = isWork ? '+ æ–°é¡¹ç›®' : '+ æ–°å¢å­¦ç”Ÿ';

            const scheduleBtn = document.getElementById('weekly-schedule-btn');
            if (isWork) {
                scheduleBtn.style.display = 'none';
            } else {
                scheduleBtn.style.display = 'inline-flex';
            }

            const primaryColor = getComputedStyle(document.body).getPropertyValue('--primary-color');
            const textColor = getComputedStyle(document.body).getPropertyValue('--pill-text-color');
            const deleteColor = currentView === 'work' ? '#991b1b' : '#e74c3c';
            document.getElementById('save-project-btn').style.backgroundColor = primaryColor;
            document.getElementById('save-project-btn').style.color = textColor || 'white';
            document.getElementById('delete-btn').style.backgroundColor = deleteColor;
            document.getElementById('delete-btn').style.color = 'white';
            document.getElementById('save-config-btn').style.borderColor = primaryColor;
            document.getElementById('save-progress-btn').style.backgroundColor = primaryColor;
            document.getElementById('save-progress-btn').style.color = textColor || 'white';
            renderBoard();
        }

        // =============================================
        // =========== æ•°æ®åŠ è½½/ä¿å­˜ (å·²é€‚é…) ===========
        // =============================================

        function getStorageKey(type) { return `${currentView}_kanban_${type}`; }
        function loadConfig() {
            const configJSON = localStorage.getItem(getStorageKey('config'));
            const defaultConfig = currentView === 'work' ? getWorkDefaultColumnConfig() : getStudentDefaultColumnConfig();
            if (configJSON) {
                try {
                    const savedConfig = JSON.parse(configJSON);
                    const defaultConfigMap = new Map(defaultConfig.map(c => [c.key, c]));
                    const migratedConfig = savedConfig.map(savedCol => {
                        const defaultCol = defaultConfigMap.get(savedCol.key);
                        if (defaultCol) return { ...defaultCol, visible: savedCol.visible };
                        return null;
                    }).filter(Boolean);
                    defaultConfig.forEach(defaultCol => {
                        if (!migratedConfig.some(c => c.key === defaultCol.key)) migratedConfig.push(defaultCol);
                    });
                    columnConfig = migratedConfig;
                } catch (e) { columnConfig = defaultConfig; }
            } else { columnConfig = defaultConfig; }
        }
        function saveConfig() { localStorage.setItem(getStorageKey('config'), JSON.stringify(columnConfig)); }
        function loadWidths() {
            const widthsJSON = localStorage.getItem(getStorageKey('widths'));
            const defaultWidths = currentView === 'work' ? getWorkDefaultWidths() : getStudentDefaultWidths();
            const defaultKeys = Object.keys(defaultWidths);

            if (widthsJSON) {
                try {
                    const savedWidths = JSON.parse(widthsJSON);
                    const savedKeys = Object.keys(savedWidths);
                    // æ£€æŸ¥ç¼“å­˜çš„é…ç½®æ˜¯å¦åŒ…å«äº†ä»£ç ä¸­å®šä¹‰çš„æ‰€æœ‰åˆ—
                    if (defaultKeys.every(key => savedKeys.includes(key))) {
                        // å¦‚æœæ˜¯ï¼Œåˆ™ä½¿ç”¨ç¼“å­˜
                        columnWidths = savedWidths;
                    } else {
                        // å¦‚æœä¸æ˜¯ï¼ˆè¯´æ˜ç¼“å­˜æ˜¯æ—§ç‰ˆçš„ï¼‰ï¼Œåˆ™å¼ºåˆ¶ä½¿ç”¨ä»£ç ä¸­çš„æ–°é»˜è®¤å€¼
                        columnWidths = defaultWidths;
                    }
                } catch(e) {
                    columnWidths = defaultWidths;
                }
            } else {
                columnWidths = defaultWidths;
            }
        }
        function saveWidths() { localStorage.setItem(getStorageKey('widths'), JSON.stringify(columnWidths)); }
        function loadData() {
            const dataJSON = localStorage.getItem(getStorageKey('data'));
            const defaultData = currentView === 'work' ? getWorkDefaultData() : getStudentDefaultData();
            let loadedData = null;

            if (dataJSON) {
                try {
                    loadedData = JSON.parse(dataJSON);
                } catch (e) {
                    loadedData = null; // å¦‚æœJSONæ ¼å¼æŸåï¼Œåˆ™è§†ä¸ºç©º
                }
            }

            // æ ¸å¿ƒä¿®æ­£ï¼šåªæœ‰å½“åŠ è½½çš„æ•°æ®çœŸå®æœ‰æ•ˆï¼Œå¹¶ä¸”åŒ…å«è‡³å°‘ä¸€ä¸ªé¡¹ç›®æ—¶ï¼Œæ‰ä½¿ç”¨å®ƒ
            if (loadedData && loadedData.projects && loadedData.projects.length > 0) {
                data = loadedData;
                if (!data.specialDates) {
                    data.specialDates = {}; // ç¡®ä¿ specialDates å­˜åœ¨
                }
            } else {
                // å¦åˆ™ï¼ˆåŒ…æ‹¬localStorageä¸ºç©ºã€JSONæŸåã€æˆ–é¡¹ç›®åˆ—è¡¨ä¸ºç©ºï¼‰ï¼Œä¸€å¾‹åŠ è½½é»˜è®¤æ•°æ®
                data = defaultData;
            }
        }
        function saveData() { localStorage.setItem(getStorageKey('data'), JSON.stringify(data)); }

        // =============================================
        // =========== å„çœ‹æ¿çš„é»˜è®¤é…ç½®å®šä¹‰ ===========
        // =============================================

        function getWorkDefaultColumnConfig() { 
            return [ 
                { key: 'name', shortLabel: 'é¡¹ç›®åç§°', label: `${workIcons.name} é¡¹ç›®åç§°`, type: 'text', readonly: true, visible: true }, 
                { key: 'property', shortLabel: 'ç±»å‹', label: `${workIcons.property} ç±»å‹`, type: 'select', options: ['è‚¡æƒ', 'å¹¶è´­', 'ä¸è‰¯', 'å…¶ä»–'], visible: true }, 
                { key: 'status', shortLabel: 'é¡¹ç›®è¿›åº¦', label: `${workIcons.status} é¡¹ç›®è¿›åº¦`, type: 'select', options: ['å°šæœªå¼€å§‹', 'åˆæ­¥æ¥è§¦', 'æ­£åœ¨æ¨è¿›', 'é¡ºåˆ©å®Œæˆ', 'å·²ç»æ”¾å¼ƒ'], visible: true }, 
                { key: 'industry', shortLabel: 'è¡Œä¸š', label: `${workIcons.industry} è¡Œä¸š`, type: 'text', visible: true }, 
                { key: 'description', shortLabel: 'é¡¹ç›®ä»‹ç»', label: `${workIcons.description} é¡¹ç›®ä»‹ç»`, type: 'textarea', visible: true }, 
                { key: 'startDate', shortLabel: 'æ¥æ‰‹æ—¶é—´', label: `${workIcons.startDate} æ¥æ‰‹æ—¶é—´`, type: 'date', visible: true }, 
                { key: 'updatedAt', shortLabel: 'æ›´æ–°æ—¶é—´', label: `${workIcons.updatedAt} æ›´æ–°æ—¶é—´`, type: 'readonly', visible: true }, 
            ]; 
        }
        function getWorkDefaultData() {
            return { projects: [{ id: Date.now(), name: "ç¤ºä¾‹é¡¹ç›®ï¼šè¯ºè¯ºæ–°ææ–™", property: "å¹¶è´­", status: "åˆæ­¥æ¥è§¦", industry: "OLEDææ–™", description: "è¯¥å…¬å¸ä¸“æ³¨äºé«˜ç«¯OLEDåˆ†å­ç Œå—å’Œæ–°ææ–™çš„ç ”å‘ã€ç”Ÿäº§å’Œé”€å”®ã€‚", startDate: "2025-08-05", updatedAt: new Date().toISOString() }] };
        }
        function getWorkDefaultWidths() { 
            return { name: '2.5fr', property: '0.8fr', status: '1fr', industry: '1.2fr', description: '4fr', startDate: '1fr', updatedAt: '1.2fr' }; 
        }
        function getStudentDefaultColumnConfig() { 
            return [ 
                { key: 'studentName', shortLabel: 'å­¦ç”Ÿå§“å', label: `${studentIcons.name} å­¦ç”Ÿå§“å`, type: 'text', visible: true }, 
                { key: 'curriculum', shortLabel: 'å›½é™…è¯¾ç¨‹', label: `${studentIcons.curriculum} å›½é™…è¯¾ç¨‹`, type: 'select', options: ['ALEVEL', 'AP', 'IB', 'IGCSE'], visible: true }, 
                { key: 'discipline', shortLabel: 'å­¦ç§‘', label: `${studentIcons.discipline} å­¦ç§‘`, type: 'select', options: ['æ•°å­¦', 'ç‰©ç†', 'åŒ–å­¦', 'ç»æµ'], visible: true }, 
                { key: 'subject', shortLabel: 'å¹´çº§', label: `${studentIcons.subject} å¹´çº§`, type: 'text', visible: true }, 
                { key: 'school', shortLabel: 'å­¦æ ¡', label: `${studentIcons.school} å­¦æ ¡`, type: 'text', visible: true }, 
                { key: 'studentProfile', shortLabel: 'å­¦ç”Ÿç®€æ¡£', label: `${studentIcons.studentProfile} å­¦ç”Ÿç®€æ¡£`, type: 'textarea', visible: true },
                { key: 'classTime', shortLabel: 'ä¸Šè¯¾æ—¶é—´', label: `ğŸ•’ ä¸Šè¯¾æ—¶é—´`, type: 'action', visible: true },
                { key: 'progress', shortLabel: 'æ•™å­¦è¿›åº¦', label: `${studentIcons.progress} æ•™å­¦è¿›åº¦`, type: 'action', visible: true },
                { key: 'classSchedule', shortLabel: 'ä¸Šè¯¾æ—¥å†', label: `${studentIcons.classSchedule} ä¸Šè¯¾æ—¥å†`, type: 'action', visible: true },
                { key: 'updatedAt', shortLabel: 'æ›´æ–°æ—¶é—´', label: `${studentIcons.updatedAt} æ›´æ–°æ—¶é—´`, type: 'readonly', visible: false }, 
            ]; 
        }

        function getStudentDefaultData() {
            const now = new Date();

            // --- æ–°å¢ä»£ç å¼€å§‹ï¼šåŠ¨æ€ç”Ÿæˆâ€œä»Šå¤©â€å’Œâ€œåå¤©â€çš„æ—¥æœŸ ---
            const today = new Date();
            const dayAfterTomorrow = new Date();
            dayAfterTomorrow.setDate(today.getDate() + 2);

            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const todayKey = formatDate(today);
            const dayAfterTomorrowKey = formatDate(dayAfterTomorrow);
            // --- æ–°å¢ä»£ç ç»“æŸ ---

            return {
                projects: [
                    { 
                        id: 1725454800001, studentName: "èŠ³ä¸€å¼¦", curriculum: "ALEVEL", discipline: "ç‰©ç†", subject: "A2",
                        school: "è‹å›½å¤–", studentProfile: "ç›®æ ‡ç‰›æ´¥ç‰©ç†ç³»ï¼Œéœ€è¦åŠ å¼ºç”µç£å­¦éƒ¨åˆ†çš„è§£é¢˜èƒ½åŠ›ã€‚",
                        updatedAt: now.toISOString(), classTime: [ { day: 6, start: "13:00", end: "15:00" } ],
                        progressLog: [
                            { date: "2025-09-06", duration: 2, content: "å¤ä¹ ç‰›é¡¿è¿åŠ¨å®šå¾‹ï¼Œè®²è§£å…¸å‹ä¾‹é¢˜ã€‚", feedback: "æ¦‚å¿µæŒæ¡ç‰¢å›ºï¼Œä½†å¤æ‚å—åŠ›åˆ†æä»æœ‰å›°éš¾ã€‚", homeworkAssigned: "å®Œæˆç»ƒä¹ å†ŒP1-5", homeworkStatus: "å¾…æ£€æŸ¥" },
                            { date: "2025-08-30", duration: 2, content: "é¦–æ¬¡è¯¾è¯„ä¼°ï¼Œæ‘¸åº•æµ‹è¯•ã€‚", feedback: "è¿åŠ¨å­¦åŸºç¡€è‰¯å¥½ï¼Œéœ€åŠ å¼ºåŠ¨åŠ›å­¦éƒ¨åˆ†ã€‚", homeworkAssigned: "é¢„ä¹ ç¬¬ä¸€ç« ", homeworkStatus: "å·²å®Œæˆ" }
                        ], 
                        classDates: [], startDate: "2025-08-30"
                    },
                    { 
                        id: 1725454800002, studentName: "ç‹çš“è½©", curriculum: "ALEVEL", discipline: "æ•°å­¦", subject: "AS",
                        school: "æ˜†åŸå¤–", studentProfile: "åŸºç¡€è¾ƒå¥½ï¼Œä½†è®¡ç®—å®¹æ˜“ç²—å¿ƒï¼Œéœ€è¦é’ˆå¯¹æ€§è®­ç»ƒã€‚",
                        updatedAt: now.toISOString(), classTime: [ { day: 3, start: "18:30", end: "20:30" } ],
                        progressLog: [
                            { date: "2025-09-03", duration: 2, content: "è®²è§£å‡½æ•°å®šä¹‰åŸŸä¸å€¼åŸŸæ±‚æ³•ã€‚", feedback: "æ–¹æ³•ç†è§£å¿«ï¼Œä½†è®¡ç®—è¿‡ç¨‹å®¹æ˜“å‡ºé”™ã€‚", homeworkAssigned: "å®Œæˆè®²ä¹‰ä¾‹é¢˜", homeworkStatus: "éƒ¨åˆ†å®Œæˆ" }
                        ], 
                        classDates: [], startDate: "2025-09-01"
                    }
                ],
                // --- æ ¸å¿ƒæ”¹åŠ¨ï¼šä½¿ç”¨åŠ¨æ€ç”Ÿæˆçš„æ—¥æœŸä½œä¸ºé”® ---
                specialDates: {
                    [todayKey]: "holiday",
                    [dayAfterTomorrowKey]: "workday"
                }
            };
        }

        
        function getStudentDefaultWidths() { 
            return { 
                studentName: '130px',
                curriculum: '120px',
                discipline: '100px',
                subject: '100px',
                school: '100px',
                studentProfile: '1fr',
                classTime: '160px',
                classSchedule: '120px',
                progress: '120px',
                updatedAt: '140px'
            }; 
        }

        // =============================================
        // =========== æ¸²æŸ“ä¸äº¤äº’ (æ ¸å¿ƒé€»è¾‘) ===========
        // =============================================
         
        function formatDisplayDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'æ— æ•ˆæ—¥æœŸ';
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (e) { return ''; }
        }
         
        function getGridTemplateColumns() { 
            const visibleColumns = columnConfig.filter(c => c.visible).map(c => columnWidths[c.key] || '1fr');
            return ['50px', ...visibleColumns, '60px'].join(' '); 
        }
         
        function renderBoard() {
            const boardContainer = document.getElementById('board-container');
            boardContainer.innerHTML = '';
            const gridColumns = getGridTemplateColumns();
            const headerRow = document.createElement('div');
            headerRow.className = 'project-header-row';
            headerRow.style.gridTemplateColumns = gridColumns;
            const seqHeader = document.createElement('div');
            seqHeader.className = 'header-cell';
            seqHeader.dataset.key = 'åºå·';
            seqHeader.style.justifyContent = 'center';
            seqHeader.textContent = 'åºå·';
            headerRow.appendChild(seqHeader);
            const visibleColumnConfig = columnConfig.filter(c => c.visible);
            const studentColsToCenter = ['studentName', 'curriculum', 'discipline', 'school', 'progress', 'classTime', 'classSchedule'];
            visibleColumnConfig.forEach(col => { 
                const headerCell = document.createElement('div'); 
                headerCell.className = 'header-cell'; 
                headerCell.innerHTML = col.label;
                headerCell.dataset.key = col.key; 
                headerCell.draggable = true;
                if (currentView === 'student' && studentColsToCenter.includes(col.key)) {
                    headerCell.style.justifyContent = 'center';
                }
                const resizeHandle = document.createElement('div'); 
                resizeHandle.className = 'resize-handle'; 
                headerCell.appendChild(resizeHandle); 
                headerRow.appendChild(headerCell); 
            });
            headerRow.innerHTML += '<div class="header-cell" data-key="actions" style="justify-content:center;">æ“ä½œ</div>';
            boardContainer.appendChild(headerRow);

            initColumnDragAndDrop(headerRow);
            data.projects.forEach((project, index) => { 
                const projectRow = createProjectRow(project, gridColumns, index + 1);
                boardContainer.appendChild(projectRow);
            });
            // --- é‡æ„ä»£ç å¼€å§‹ï¼šå®ç°é•¿æŒ‰â€œåºå·â€å•å…ƒæ ¼è¿›è¡Œæ‹–æ‹½æ’åº ---
            let draggedItem = null;
            let longPressTimer = null;

            boardContainer.querySelectorAll('.seq-cell').forEach(cell => {
                const row = cell.closest('.project-row');
                if (!row) return;

                const clearLongPress = () => {
                    clearTimeout(longPressTimer);
                    row.draggable = false;
                };

                // ç›‘å¬é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶ï¼Œå‡†å¤‡å¯åŠ¨é•¿æŒ‰è®¡æ—¶å™¨
                cell.addEventListener('mousedown', (e) => {
                    // åªå“åº”å·¦é”®
                    if (e.button !== 0) return;
                    longPressTimer = setTimeout(() => {
                        row.draggable = true; // é•¿æŒ‰æˆåŠŸï¼Œä½¿è¡Œå¯æ‹–æ‹½
                    }, 300); // é•¿æŒ‰300æ¯«ç§’åè§¦å‘
                });
                
                cell.addEventListener('mouseup', clearLongPress);
                cell.addEventListener('mouseleave', clearLongPress);
                // å¦‚æœåœ¨cellä¸Šå¼€å§‹æ‹–æ‹½ï¼ˆè¯´æ˜é•¿æŒ‰æˆåŠŸï¼‰ï¼Œä¹Ÿæ¸…é™¤è®¡æ—¶å™¨
                cell.addEventListener('dragstart', () => clearTimeout(longPressTimer));
            });

            boardContainer.querySelectorAll('.project-row').forEach(row => {
                row.addEventListener('dragstart', () => {
                    draggedItem = row;
                    setTimeout(() => row.classList.add('dragging'), 0);
                });

                row.addEventListener('dragend', () => {
                    if (draggedItem) {
                        draggedItem.classList.remove('dragging');
                        draggedItem.draggable = false;
                    }
                    draggedItem = null;
                    clearTimeout(longPressTimer);
                    boardContainer.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                });

                row.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (row !== draggedItem) {
                        boardContainer.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                        row.classList.add('drag-over');
                    }
                });
            });
            
            const dropHandler = (e) => {
                e.preventDefault();
                boardContainer.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                const targetRow = e.target.closest('.project-row');

                if (draggedItem && targetRow && draggedItem !== targetRow) {
                    const draggedId = draggedItem.dataset.projectId;
                    const targetId = targetRow.dataset.projectId;
                    const draggedIndex = data.projects.findIndex(p => p.id == draggedId);
                    const targetIndex = data.projects.findIndex(p => p.id == targetId);

                    if (draggedIndex > -1 && targetIndex > -1) {
                        const [removed] = data.projects.splice(draggedIndex, 1);
                        data.projects.splice(targetIndex, 0, removed);
                        saveData();
                        renderBoard();
                    }
                }
            };
            
            // ç§»é™¤æ—§çš„ drop ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œå†æ·»åŠ æ–°çš„ï¼Œé˜²æ­¢é‡å¤ç»‘å®š
            boardContainer.removeEventListener('drop', dropHandler);
            boardContainer.addEventListener('drop', dropHandler);
            // --- é‡æ„ä»£ç ç»“æŸ ---

        }

        function createProjectRow(project, gridColumns, rowNumber) {
            const projectRow = document.createElement('div');
            projectRow.className = 'project-row';
            // æ–°å¢ï¼šå¦‚æœæ˜¯åœ¨æ•™è‚²çœ‹æ¿ï¼Œåˆ™æ ¹æ®å­¦ç”ŸIDåº”ç”¨å·¦è¾¹æ¡†é¢œè‰²
            if (currentView === 'student') {
                const colors = getClassColor(project.discipline, project.subject);
                // ä½¿ç”¨è¾¹æ¡†è‰²ï¼Œå¹¶å¢åŠ é€æ˜åº¦ï¼Œä½¿å…¶æ›´æŸ”å’Œ
                projectRow.style.borderLeft = `5px solid ${colors.border.replace('hsl', 'hsla').replace(')', ', 0.7)')}`;
            }
    
            projectRow.dataset.projectId = project.id;
            projectRow.style.gridTemplateColumns = gridColumns;

            // ä¿®æ­£ï¼šåˆå¹¶åºå·å•å…ƒæ ¼çš„åˆ›å»ºï¼Œå¹¶æ·»åŠ æ­£ç¡®çš„classå’Œtitle
            projectRow.innerHTML += `<div class="cell seq-cell" style="text-align:center;" title="æŒ‰ä½æ‹–æ‹½å¯æ’åº">${rowNumber}</div>`;
            
            const studentColsToCenter = ['studentName', 'curriculum', 'discipline', 'subject', 'school', 'progress', 'classSchedule', 'classTime'];
            columnConfig.filter(c => c.visible).forEach(col => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.key = col.key;
                if (currentView === 'student' && studentColsToCenter.includes(col.key)) {
                    cell.style.textAlign = 'center';
                }

                let value = project[col.key] || '';
                let displayHTML = '';

                switch (col.key) {
                    case 'studentName': case 'name':
                        // ä¿®æ­£ï¼šç¡®ä¿æ¢è¡Œé€»è¾‘æ­£ç¡®åº”ç”¨
                        const namesHTML = String(value).replace(/,|ï¼Œ/g, '<br>');
                        displayHTML = `<span class="cell-name-span">${namesHTML}</span>`;
                        break;
                    case 'updatedAt': case 'startDate':
                        displayHTML = formatDisplayDate(value);
                        break;
                    case 'classTime':
                        if (Array.isArray(project.classTime) && project.classTime.length > 0) {
                            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                            const timeStrings = project.classTime.map(time => {
                                if (time && time.day != null) {
                                    const dayName = dayNames[time.day] || '';
                                    return `${dayName} ${time.start || ''}-${time.end || ''}`;
                                }
                                return '';
                            }).filter(Boolean);
                            displayHTML = `<div style="display: flex; flex-direction: column; justify-content: center; line-height: 1.4; font-size: 13px; white-space: normal;">${timeStrings.join('<br>')}</div>`;
                        } else {
                            displayHTML = 'æœªè®¾ç½®';
                        }
                        break;
                    case 'progress': case 'classSchedule':
                        const emoji = col.key === 'progress' ? 'ğŸ’¬' : 'ğŸ—“ï¸';
                        const title = col.key === 'progress' ? 'æŸ¥çœ‹/ç¼–è¾‘æ•™å­¦è¿›åº¦' : 'æŸ¥çœ‹/ç¼–è¾‘ä¸Šè¯¾æ—¥å†';
                        displayHTML = `<span class="action-btn" title="${title}">${emoji}</span>`;
                        break;
                    default:
                        if (col.type === 'select') {
                            displayHTML = `<span class="pill" data-value="${value}">${value}</span>`;
                        } else {
                            displayHTML = value;
                        }
                }
                cell.innerHTML = displayHTML;
                cell.title = typeof value === 'string' ? value : '';
                projectRow.appendChild(cell);
            });

            const actionCell = document.createElement('div');
            actionCell.className = 'cell action-cell';
            actionCell.style.textAlign = 'center';
            actionCell.innerHTML = `<button class="edit-btn action-btn" title="ç¼–è¾‘${currentView === 'work' ? 'é¡¹ç›®' : 'å­¦ç”Ÿ'}ä¿¡æ¯" style="background:none; border:none;">â€¢â€¢â€¢</button>`;
            projectRow.appendChild(actionCell);

            projectRow.querySelector('.edit-btn').addEventListener('click', e => { e.stopPropagation(); openProjectModal(project.id); });

            projectRow.querySelectorAll('.cell[data-key]').forEach(cell => {
                const key = cell.dataset.key;
                const config = columnConfig.find(c => c.key === key);

                if (key === 'progress' || key === 'classSchedule') {
                    const btn = cell.querySelector('.action-btn');
                    if (btn) {
                        const modalFn = key === 'progress' ? openProgressModal : openCalendarModal;
                        btn.addEventListener('click', e => { e.stopPropagation(); modalFn(project.id); });
                    }
                } else if (config && !config.readonly && config.type !== 'action') {
                    cell.addEventListener('click', () => createInPlaceEditor(cell, project, key));
                }
            });

            return projectRow;
        }

        function openProjectModal(projectId = null) {
            const formFields = document.getElementById('project-form-fields');
            formFields.innerHTML = '';
            const project = projectId ? data.projects.find(p => p.id == projectId) : {};

            // Part 1: æ¸²æŸ“åŸºç¡€ä¿¡æ¯å­—æ®µ
            const editableColumns = columnConfig.filter(c => c.type !== 'readonly' && c.type !== 'action' && c.key !== 'classTime');
            editableColumns.forEach(col => {
                const label = document.createElement('label');
                label.textContent = `${col.shortLabel}:`;
                let input;
                if (col.type === 'select') {
                    input = document.createElement('select');
                    col.options.forEach(opt => { input.innerHTML += `<option value="${opt}">${opt}</option>`; });
                } else if (col.type === 'textarea') {
                    input = document.createElement('textarea'); input.rows = 3;
                } else {
                    input = document.createElement('input'); input.type = col.type;
                }
                input.id = `form-${col.key}`;
                input.value = project[col.key] || '';
                formFields.appendChild(label);
                formFields.appendChild(input);
            });

            // --- é‡æ„ä»£ç å¼€å§‹ï¼šå°†å¼€å§‹å’Œç»“æŸæ—¥æœŸæ”¾åœ¨åŒä¸€è¡Œ ---
            if (currentView === 'student') {
                const dateRangeLabel = document.createElement('label');
                dateRangeLabel.textContent = 'è¯¾ç¨‹æŒç»­æ—¶é—´:';
                formFields.appendChild(dateRangeLabel);

                const dateRangeWrapper = document.createElement('div');
                dateRangeWrapper.style.display = 'flex';
                dateRangeWrapper.style.alignItems = 'center';
                dateRangeWrapper.style.gap = '10px';

                const startDateInput = document.createElement('input');
                startDateInput.type = 'date';
                startDateInput.id = 'form-startDate';
                if (project.startDate) {
                    startDateInput.value = project.startDate;
                }

                const separator = document.createElement('span');
                separator.textContent = 'â€”';

                const endDateInput = document.createElement('input');
                endDateInput.type = 'date';
                endDateInput.id = 'form-endDate';
                if (project.endDate) {
                    endDateInput.value = project.endDate;
                }

                dateRangeWrapper.appendChild(startDateInput);
                dateRangeWrapper.appendChild(separator);
                dateRangeWrapper.appendChild(endDateInput);
                formFields.appendChild(dateRangeWrapper);
            }
            // --- é‡æ„ä»£ç ç»“æŸ ---

            // Part 2: æ¸²æŸ“ä¸¤ä¸ªä¸Šè¯¾æ—¶é—´è¾“å…¥æ¡†
            if (currentView === 'student') {
                const dayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
                for (let i = 1; i <= 2; i++) {
                    const label = document.createElement('label');
                    label.textContent = `ä¸Šè¯¾æ—¶é—´ ${i}:`;
                    formFields.appendChild(label);

                    // åˆ›å»ºä¸€ä¸ªç®€å•çš„ grid å®¹å™¨
                    const inputsWrapper = document.createElement('div');
                    inputsWrapper.style.display = 'grid';
                    inputsWrapper.style.gridTemplateColumns = '1.2fr 1fr 1fr';
                    inputsWrapper.style.gap = '10px';
                    inputsWrapper.style.alignItems = 'center';
                    
                    inputsWrapper.innerHTML = `
                        <select id="form-classTime-day-${i}">
                            <option value="">æ— </option>
                            ${dayNames.map((day, index) => `<option value="${index}">${day}</option>`).join('')}
                        </select>
                        <input type="time" id="form-classTime-start-${i}">
                        <input type="time" id="form-classTime-end-${i}">
                    `;
                    formFields.appendChild(inputsWrapper);
                }

                // Part 3: ç”¨å·²ä¿å­˜çš„æ•°æ®å¡«å……æ—¶é—´è¾“å…¥æ¡†
                if (Array.isArray(project.classTime)) {
                    const time1 = project.classTime[0];
                    if (time1) {
                        document.getElementById('form-classTime-day-1').value = time1.day;
                        document.getElementById('form-classTime-start-1').value = time1.start;
                        document.getElementById('form-classTime-end-1').value = time1.end;
                    }
                    const time2 = project.classTime[1];
                    if (time2) {
                        document.getElementById('form-classTime-day-2').value = time2.day;
                        document.getElementById('form-classTime-start-2').value = time2.start;
                        document.getElementById('form-classTime-end-2').value = time2.end;
                    }
                }
            }

            document.getElementById('modal-title').textContent = `${projectId ? 'ç¼–è¾‘' : 'æ–°å¢'}${currentView === 'work' ? 'é¡¹ç›®' : 'å­¦ç”Ÿ'}ä¿¡æ¯`;
            document.getElementById('project-id').value = projectId || '';
            document.getElementById('delete-btn').style.display = projectId ? 'inline-block' : 'none';
            projectModal.style.display = 'flex';
        }

        function openProgressModal(projectId) {
            if (currentView !== 'student') return;
            const project = data.projects.find(p => p.id == projectId);
            if (!project) return;
            if (!Array.isArray(project.progressLog)) { project.progressLog = []; }
            const modalBody = document.getElementById('progress-modal-body');
            const modalContent = progressModal.querySelector('.modal-content');
            modalBody.classList.remove('side-by-side');
            modalContent.classList.remove('side-by-side-mode');
            document.getElementById('progress-modal-title').textContent = `${project.studentName} - æ•™å­¦è¿›åº¦`;
            const logList = document.getElementById('progress-log-list');
            logList.innerHTML = '';
            const logsWithOriginalIndex = project.progressLog.map((log, index) => ({ ...log, originalIndex: index }));
            const sortedLogs = logsWithOriginalIndex.sort((a, b) => new Date(b.date) - new Date(a.date));
            sortedLogs.forEach(log => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'progress-log-entry';
                entryDiv.innerHTML = `<div class="log-entry-header"><span class="log-entry-date" data-key="date">${formatDisplayDate(log.date)}</span><span class="log-entry-duration" data-key="duration">æ—¶é•¿: ${log.duration || 'N/A'} å°æ—¶</span></div><dl class="log-entry-body"><dt>ä¸Šè¯¾å†…å®¹:</dt><dd data-key="content">${log.content || 'æœªè®°å½•'}</dd><dt>åé¦ˆä¸è¡¨ç°:</dt><dd data-key="feedback">${log.feedback || 'æœªè®°å½•'}</dd><dt>ä½œä¸šå¸ƒç½®:</dt><dd data-key="homeworkAssigned">${log.homeworkAssigned || 'æ— '}</dd><dt>ä½œä¸šå®Œæˆæƒ…å†µ:</dt><dd data-key="homeworkStatus" data-homework-status="${log.homeworkStatus || ''}">${log.homeworkStatus || 'æœªè®°å½•'}</dd></dl><button class="delete-log-btn" title="åˆ é™¤æ­¤æ¡è®°å½•">Ã—</button>`;                logList.appendChild(entryDiv);
                entryDiv.querySelectorAll('[data-key]').forEach(elem => {
                    elem.addEventListener('click', (e) => createLogEntryEditor(e.currentTarget, project, log.originalIndex, elem.dataset.key));
                });

                entryDiv.querySelector('.delete-log-btn').addEventListener('click', () => {
                    if (confirm('ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡æ•™å­¦è®°å½•å—ï¼Ÿ')) {
                        project.progressLog.splice(log.originalIndex, 1);
                        project.updatedAt = new Date().toISOString();
                        saveData();
                        openProgressModal(project.id);
                    }
                });
            });
            document.getElementById('progress-log-form').dataset.projectId = projectId;
            document.getElementById('progress-log-form').reset();
            document.getElementById('new-log-date').valueAsDate = new Date();
            document.getElementById('new-log-homework-status').value = 'å¾…æ£€æŸ¥';
            progressModal.style.display = 'flex';
        }

        function createLogEntryEditor(element, project, logIndex, key) {
            const modalBody = document.getElementById('progress-modal-body');
            // å¦‚æœæ˜¯åˆ†æ æ¨¡å¼ï¼Œåˆ™ä¸å…è®¸ç¼–è¾‘ï¼Œç›´æ¥é€€å‡ºå‡½æ•°
            if (modalBody.classList.contains('side-by-side')) {
                return; 
            }

            if (element.querySelector('.log-inline-editor')) return;
            isEditing = true;
            const logEntry = project.progressLog[logIndex];
            if (!logEntry) { isEditing = false; return; }
            
            element.childNodes.forEach(node => { if(node.style) node.style.visibility = 'hidden' });

            const computedStyle = window.getComputedStyle(element);
            
            const editorContainer = document.createElement('div');
            editorContainer.className = 'log-inline-editor';
            let editor;

            switch (key) {
                case 'homeworkStatus':
                    editor = document.createElement('select');
                    ['å·²å®Œæˆ', 'éƒ¨åˆ†å®Œæˆ', 'æœªæäº¤', 'å¾…æ£€æŸ¥'].forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt; option.textContent = opt;
                        if (opt === logEntry.homeworkStatus) option.selected = true;
                        editor.appendChild(option);
                    });
                    break;
                case 'content': case 'feedback':
                    editor = document.createElement('textarea');
                    editor.value = logEntry[key] || '';
                    break;
                default:
                    editor = document.createElement('input');
                    editor.type = (key === 'date') ? 'date' : (key === 'duration' ? 'number' : 'text');
                    if (key === 'duration') { editor.step = '0.5'; editor.min = '0'; }
                    editor.value = (key === 'date' && logEntry[key]) ? new Date(logEntry[key]).toISOString().slice(0, 10) : (logEntry[key] || '');
                    break;
            }
            editor.style.width = computedStyle.width;
            editor.style.height = computedStyle.height;

            const cleanupAndRefresh = (shouldSave) => {
                if (shouldSave) {
                    logEntry[key] = (key === 'duration') ? (parseFloat(editor.value) || null) : editor.value;
                    project.updatedAt = new Date().toISOString();
                    saveData();
                }
                isEditing = false;
                openProgressModal(project.id);
            };

            editor.addEventListener('blur', () => cleanupAndRefresh(true));
            editor.addEventListener('keydown', e => {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); editor.blur(); } 
                else if (e.key === 'Escape') { cleanupAndRefresh(false); }
            });

            editorContainer.appendChild(editor);
            element.appendChild(editorContainer);
            editor.focus();
        }

        function createInPlaceEditor(cell, project, key) {
            const config = columnConfig.find(c => c.key === key);
            if (!config || cell.querySelector('.inline-editor')) return;
            isEditing = true;
            Array.from(cell.childNodes).forEach(node => {
                if (node.style) {
                    node.style.visibility = 'hidden';
                } else if (node.nodeType === Node.TEXT_NODE) {
                    // å¯¹äºçº¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªç©ºçš„spanæ¥åŒ…è£¹å®ƒä»¥ä¾¿éšè—
                    const span = document.createElement('span');
                    span.textContent = node.textContent;
                    span.style.visibility = 'hidden';
                    cell.replaceChild(span, node);
                }
            });
            
            const editorContainer = document.createElement('div');
            editorContainer.className = 'inline-editor';
            let editor;

            if (config.type === 'select') {
                editor = document.createElement('select');
                config.options.forEach(opt => { 
                    const option = document.createElement('option'); 
                    option.value = opt; option.textContent = opt; 
                    if (opt === project[key]) option.selected = true; 
                    editor.appendChild(option); 
                });
            } else {
                editor = document.createElement('input');
                editor.type = config.type;
                editor.value = project[key] || '';
            }
            
            const cleanup = (shouldSave) => {
                if (shouldSave) {
                    project[key] = editor.value;
                    project.updatedAt = new Date().toISOString();
                    saveData();
                }
                isEditing = false;
                renderBoard();
            };

            editor.addEventListener('blur', () => cleanup(true));
            editor.addEventListener('keydown', e => {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); editor.blur(); } 
                else if (e.key === 'Escape') { cleanup(false); }
            });
            
            editorContainer.appendChild(editor);
            cell.appendChild(editorContainer);
            editor.focus();
        }
        
        // æœ€ç»ˆç‰ˆé¢œè‰²ç³»ç»Ÿ v3.0ï¼šåŸºäºâ€œå­¦ç§‘ x å¹´çº§â€
        const SUBJECT_THEMES = {
            'ç‰©ç†': {
                light: { background: '#fdedec', border: '#f5b7b1', text: '#c0392b' }, // æ·¡è‰² (ASç­‰)
                deep:  { background: '#f5b7b1', border: '#e74c3c', text: '#943126' }  // æ·±è‰² (A2)
            },
            'æ•°å­¦': {
                light: { background: '#eaf2f8', border: '#a9cce3', text: '#2980b9' }, // æ·¡è‰² (ASç­‰)
                deep:  { background: '#aed6f1', border: '#3498db', text: '#1f618d' }  // æ·±è‰² (A2)
            },
            'é»˜è®¤': {
                light: { background: '#f2f4f4', border: '#d5dbdb', text: '#7f8c8d' },
                deep:  { background: '#e5e7e9', border: '#b2babb', text: '#616a6b' }
            }
        };

        function getClassColor(discipline, grade = '') {
            const theme = SUBJECT_THEMES[discipline] || SUBJECT_THEMES['é»˜è®¤'];
            const gradeStr = String(grade).toUpperCase();

            // å®šä¹‰ä¸€ä¸ªåŒ…å«æ‰€æœ‰â€œæ·±è‰²â€å¹´çº§å…³é”®è¯çš„æ•°ç»„
            const deepColorKeywords = ['A2', 'ç¬¬äºŒå¹´'];

            // æ£€æŸ¥å¹´çº§å­—ç¬¦ä¸²æ˜¯å¦åŒ…å«ä»»ä½•ä¸€ä¸ªæ·±è‰²å…³é”®è¯
            if (deepColorKeywords.some(keyword => gradeStr.includes(keyword))) {
                return theme.deep;
            }
            return theme.light; // å…¶ä»–æ‰€æœ‰æƒ…å†µ (AS, ç¬¬ä¸€å¹´, IGCSEç­‰) éƒ½ä½¿ç”¨æ·¡è‰²
        }

        // =============================================
        // =========== æ–°å¢: æ•™å¸ˆæœˆå†ç”Ÿæˆå‡½æ•° v3.0 ========
        // =============================================

        function renderMonthlySchedule() {
            const container = document.getElementById('schedule-grid-container');
            const title = document.getElementById('schedule-modal-title');
            container.innerHTML = '';
            const year = currentScheduleDate.getFullYear();
            const month = currentScheduleDate.getMonth();
            title.textContent = `${year} å¹´ ${month + 1} æœˆ`;
            
            let totalClasses = 0;
            const monthScheduleData = {};

            // 1. æ•°æ®å¤„ç†
            data.projects.forEach(student => {
                if (Array.isArray(student.classTime)) {
                    student.classTime.forEach(time => {
                        if (time.day == null || !time.start) return;
                        for (let i = 1; i <= 31; i++) {
                            const date = new Date(year, month, i);
                            if (date.getMonth() !== month) break;
                            if (date.getDay() === parseInt(time.day, 10)) {
                                let isValid = true;
                                const checkDate = new Date(date); checkDate.setHours(0, 0, 0, 0);
                                if (student.startDate && new Date(student.startDate) > checkDate) isValid = false;
                                if (student.endDate && new Date(student.endDate) < checkDate) isValid = false;
                                if (isValid) {
                                    const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                                    if (!monthScheduleData[dateKey]) monthScheduleData[dateKey] = [];
                                    monthScheduleData[dateKey].push({ 
                                        studentId: student.id, studentName: student.studentName, 
                                        start: time.start, end: time.end, 
                                        discipline: student.discipline, grade: student.subject
                                    });
                                }
                            }
                        }
                    });
                }
            });

            // 2. æ¸²æŸ“UI
            const grid = document.createElement('div');
            grid.className = 'monthly-schedule-grid';
            
            if (document.getElementById('mark-dates-btn').classList.contains('active')) {
                grid.classList.add('marking-mode');
            }

            const dayNames = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
            dayNames.forEach(day => grid.innerHTML += `<div class="day-header">${day}</div>`);
            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dayOffset = (firstDayOfMonth.getDay() + 6) % 7;

            for (let i = 0; i < dayOffset; i++) { grid.innerHTML += `<div class="day-cell not-current-month"><div class="day-number">${new Date(year, month, 0).getDate() - dayOffset + i + 1}</div></div>`; }

            for (let i = 1; i <= daysInMonth; i++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                
                const dailyClassMap = new Map();
                (monthScheduleData[dateKey] || []).forEach(c => {
                    const eventKey = `${dateKey}_${c.start}`;
                    dailyClassMap.set(eventKey, { ...c, isOverride: false, originalStart: c.start });
                });
                data.projects.forEach(student => {
                    if (Array.isArray(student.overriddenClasses)) {
                        student.overriddenClasses.forEach(override => {
                            if (override.key.slice(0, 10) === dateKey) {
                                dailyClassMap.set(override.key, {
                                    studentId: student.id, studentName: student.studentName,
                                    start: override.newStart, end: override.newEnd,
                                    discipline: student.discipline, grade: student.subject,
                                    isOverride: true, originalStart: override.key.split('_')[1]
                                });
                            }
                        });
                    }
                });

                let finalClasses = Array.from(dailyClassMap.values()).filter(c => {
                    const student = data.projects.find(p => p.id === c.studentId);
                    const eventKey = `${dateKey}_${c.isOverride ? c.originalStart : c.start}`;
                    return !(student && student.inactiveClasses && student.inactiveClasses.includes(eventKey));
                });
                finalClasses.sort((a, b) => a.start.localeCompare(b.start));
                
                const specialStatus = data.specialDates[dateKey];
                let dayCellClass = 'day-cell';
                if (specialStatus === 'holiday') dayCellClass += ' holiday';
                if (specialStatus === 'workday') dayCellClass += ' special-workday';
                let cellHTML = `<div class="${dayCellClass}" data-date="${dateKey}"><div class="day-number">${i}</div><div class="class-entries-container">`;

                finalClasses.forEach(c => {
                    totalClasses++;
                    const colors = getClassColor(c.discipline, c.grade);
                    const styleAttribute = `style="background-color: ${colors.background}; border-left-color: ${colors.border}; color: ${colors.text};"`;
                    
                    // --- æ ¸å¿ƒæ”¹åŠ¨ï¼šæ— è®ºåå­—å¤šé•¿ï¼Œåªæ˜¾ç¤ºå‰ä¸‰ä¸ªå­— ---
                    let displayName = c.studentName;
                    if (displayName.length > 3) {
                        displayName = displayName.substring(0, 3) + '...';
                    }
                    
                    // é¼ æ ‡æ‚¬åœçš„titleä¾ç„¶æ˜¾ç¤ºå…¨åï¼Œæ˜¾ç¤ºçš„åå­—(displayName)æ˜¯æˆªæ–­åçš„
                    cellHTML += `<div class="class-entry" ${styleAttribute} data-student-id="${c.studentId}" data-date-key="${dateKey}" data-start-time="${c.isOverride ? c.originalStart : c.start}"><div class="drag-handle"></div><div class="class-entry-content-wrapper" title="${c.start}-${c.end} ${c.studentName}"><span class="class-entry-time">${c.start} - ${c.end}</span><span class="student-name">${displayName}</span></div></div>`;                });
                cellHTML += `</div></div>`;
                grid.innerHTML += cellHTML;
            }

            for (let i = 1; i <= (7 - (dayOffset + daysInMonth) % 7) % 7; i++) { grid.innerHTML += `<div class="day-cell not-current-month"><div class="day-number">${i}</div></div>`; }
            
            container.appendChild(grid);
            document.getElementById('schedule-class-count').textContent = totalClasses;
        }

        function initColumnDragAndDrop(headerRow) {
            const headers = Array.from(headerRow.querySelectorAll('.header-cell[draggable="true"]'));
            let draggedItem = null;
            headers.forEach(header => {
                header.addEventListener('dragstart', (e) => {
                    draggedItem = e.target.closest('.header-cell');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', draggedItem.dataset.key);
                });
                header.addEventListener('dragover', (e) => { e.preventDefault(); });
                header.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const targetItem = e.target.closest('.header-cell');
                    if (!targetItem || !targetItem.draggable) return;
                    const draggedKey = e.dataTransfer.getData('text/plain');
                    const targetKey = targetItem.dataset.key;
                    if (draggedKey && targetKey && draggedKey !== targetKey) {
                        const draggedIndex = columnConfig.findIndex(col => col.key === draggedKey);
                        const targetIndex = columnConfig.findIndex(col => col.key === targetKey);
                        if (draggedIndex > -1 && targetIndex > -1) {
                            const [removed] = columnConfig.splice(draggedIndex, 1);
                            columnConfig.splice(targetIndex, 0, removed);
                            saveConfig();
                            renderBoard();
                        }
                    }
                });
            });
        }
        
        // =============================================
        // =========== æ—¥å†åŠŸèƒ½ ===========
        // =============================================
        function openCalendarModal(projectId) {
            currentCalendarProjectId = projectId;
            currentCalendarDate = new Date();
            calendarModal.classList.remove('calendar-editing');
            document.getElementById('edit-schedule-btn').classList.remove('active');
            renderCalendar();
            calendarModal.style.display = 'flex';
        }

        function renderCalendar() {
            const project = data.projects.find(p => p.id == currentCalendarProjectId);
            if (!project) return;
            if (!Array.isArray(project.classDates)) { project.classDates = []; }
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            document.getElementById('calendar-month-year').textContent = `${year} å¹´ ${month + 1} æœˆ`;
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].forEach(day => {
                grid.innerHTML += `<div class="day-header">${day}</div>`;
            });
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDayOfMonth; i++) {
                grid.innerHTML += `<div class="day-cell"></div>`;
            }
            for (let i = 1; i <= daysInMonth; i++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell current-month-day';
                dayCell.textContent = i;
                const fullDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                dayCell.dataset.date = fullDate;
                if (project.classDates.includes(fullDate)) {
                    dayCell.classList.add('taught');
                }
                dayCell.addEventListener('click', () => {
                    if (!calendarModal.classList.contains('calendar-editing')) return;
                    if (project.classDates.includes(fullDate)) {
                        project.classDates = project.classDates.filter(d => d !== fullDate);
                    } else {
                        project.classDates.push(fullDate);
                    }
                    project.updatedAt = new Date().toISOString();
                    saveData();
                    renderCalendar();
                });
                grid.appendChild(dayCell);
            }
        }

        // =============================================
        // =========== äº‹ä»¶ç›‘å¬ä¸åˆå§‹åŒ– ===========
        // =============================================
         
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('nav-work').addEventListener('click', () => initializeBoard('work'));
            document.getElementById('nav-student').addEventListener('click', () => initializeBoard('student'));
            document.getElementById('instructions-btn').addEventListener('click', () => {
                document.getElementById('instructions-modal').style.display = 'flex';
            });

            [projectModal, configModal, progressModal, calendarModal,scheduleModal, instructionsModal ].forEach(modal => {
                modal.addEventListener('click', e => { if (e.target === modal && !isEditing) modal.style.display = 'none'; });
            });
            document.getElementById('add-btn').addEventListener('click', () => openProjectModal(null));

            document.getElementById('project-form').addEventListener('submit', e => {
Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  const projectId = document.getElementById('project-id').value;
Â  Â  Â  Â  Â  Â  Â  Â  const projectData = {};
Â  Â  Â  Â  Â  Â  Â  Â  columnConfig.filter(c => c.type !== 'readonly' && c.type !== 'action' && c.key !== 'classTime').forEach(col => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const input = document.getElementById(`form-${col.key}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (input) projectData[col.key] = input.value;
Â  Â  Â  Â  Â  Â  Â  Â  });
                // --- æ–°å¢ä»£ç å¼€å§‹ï¼šä¿å­˜å¼€å§‹å’Œç»“æŸæ—¥æœŸ ---
                if (currentView === 'student') {
                    projectData.startDate = document.getElementById('form-startDate').value || null;
                    projectData.endDate = document.getElementById('form-endDate').value || null;
                }
                // --- æ–°å¢ä»£ç ç»“æŸ ---

Â  Â  Â  Â  Â  Â  Â  Â  if (currentView === 'student') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newClassTimes = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for(let i = 1; i <= 2; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const day = document.getElementById(`form-classTime-day-${i}`).value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (day !== "") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newClassTimes.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  day: parseInt(day, 10),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  start: document.getElementById(`form-classTime-start-${i}`).value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  end: document.getElementById(`form-classTime-end-${i}`).value
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  projectData.classTime = newClassTimes;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  projectData.updatedAt = new Date().toISOString();
Â  Â  Â  Â  Â  Â  Â  Â  if (projectId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const pIndex = data.projects.findIndex(p => p.id == projectId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (pIndex > -1) data.projects[pIndex] = { ...data.projects[pIndex], ...projectData };
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  projectData.id = Date.now();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentView === 'student') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  projectData.classDates = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!projectData.classTime || projectData.classTime.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  projectData.classTime = [{ day: 1, start: '13:00', end: '15:00' }];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data.projects.unshift(projectData);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  saveData();
Â  Â  Â  Â  Â  Â  Â  Â  renderBoard();
Â  Â  Â  Â  Â  Â  Â  Â  projectModal.style.display = 'none';
Â  Â  Â  Â  Â  Â  });

            document.getElementById('delete-btn').addEventListener('click', () => {
                const projectId = document.getElementById('project-id').value;
                const typeText = currentView === 'work' ? 'é¡¹ç›®' : 'å­¦ç”Ÿ';
                if (confirm(`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤æ­¤${typeText}çš„æ‰€æœ‰è®°å½•å—ï¼Ÿ`)) {
                    data.projects = data.projects.filter(p => p.id != projectId);
                    saveData();
                    renderBoard();
                    projectModal.style.display = 'none';
                }
            });

            document.getElementById('show-add-log-form-btn').addEventListener('click', (e) => {
                const modalBody = document.getElementById('progress-modal-body');
                const modalContent = e.target.closest('.modal-content');
                modalBody.classList.add('side-by-side');
                modalContent.classList.add('side-by-side-mode');
            });

            document.getElementById('return-to-log-list-btn').addEventListener('click', (e) => {
                const modalBody = document.getElementById('progress-modal-body');
                const modalContent = e.target.closest('.modal-content');
                modalBody.classList.remove('side-by-side');
                modalContent.classList.remove('side-by-side-mode');
            });
            
            document.getElementById('progress-log-form').addEventListener('submit', e => {
                e.preventDefault();
                if (currentView !== 'student') return;
                const projectId = e.currentTarget.dataset.projectId;
                if (!projectId) return;
                const project = data.projects.find(p => p.id == projectId);
                if (project) {
                    const newLog = {
                        date: document.getElementById('new-log-date').value,
                        duration: parseFloat(document.getElementById('new-log-duration').value) || null,
                        content: document.getElementById('new-log-content').value.trim(),
                        feedback: document.getElementById('new-log-feedback').value.trim(),
                        homeworkAssigned: document.getElementById('new-log-homework').value.trim(),
                        homeworkStatus: document.getElementById('new-log-homework-status').value
                    };
                    if (!Array.isArray(project.progressLog)) { project.progressLog = []; }
                    project.progressLog.push(newLog);
                    project.updatedAt = new Date().toISOString();
                    saveData(); 
                    renderBoard(); 
                    openProgressModal(projectId);
                }
            });

            document.getElementById('config-btn').addEventListener('click', () => {
                const container = document.getElementById('config-form-fields');
                container.innerHTML = '';
                columnConfig.forEach(col => {
                    const row = document.createElement('div');
                    row.className = 'config-row';
                    row.style.display = 'grid';
                    row.style.gridTemplateColumns = '1fr 60px';
                    row.style.alignItems = 'center';
                    const label = document.createElement('label');
                    label.htmlFor = `config-check-${col.key}`;
                    label.innerHTML = col.label;
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `config-check-${col.key}`;
                    checkbox.checked = col.visible;
                    row.appendChild(label);
                    row.appendChild(checkbox);
                    container.appendChild(row);
                });
                configModal.style.display = 'flex';
            });
            document.getElementById('save-config-btn').addEventListener('click', () => {
                columnConfig.forEach(col => {
                    const checkbox = document.getElementById(`config-check-${col.key}`);
                    if (checkbox) col.visible = checkbox.checked;
                });
                saveConfig();
                renderBoard();
                configModal.style.display = 'none';
            });

            document.getElementById('export-btn').addEventListener('click', () => {
                const exportData = { config: columnConfig, widths: columnWidths, data: data };
                const dataStr = JSON.stringify(exportData, null, 2);
                const link = document.createElement('a');
                link.download = `${currentView}_kanban_backup_${new Date().toISOString().slice(0,10)}.json`;
                link.href = URL.createObjectURL(new Blob([dataStr], {type: "application/json"}));
                link.click();
                URL.revokeObjectURL(link.href);
            });
            const importInput = document.getElementById('import-input');
            document.getElementById('import-btn').addEventListener('click', () => importInput.click());
            importInput.addEventListener('change', e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if (imported.data && imported.data.projects && imported.config && imported.widths) {
                            if (confirm('å¯¼å…¥æ•°æ®å°†ä¼šè¦†ç›–å½“å‰çœ‹æ¿çš„æ‰€æœ‰å†…å®¹ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
                                data = imported.data;
                                columnConfig = imported.config;
                                columnWidths = imported.widths;
                                saveData(); saveConfig(); saveWidths();
                                renderBoard();
                                alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                            }
                        } else { alert('å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ã€‚'); }
                    } catch (err) { alert('å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„JSONã€‚'); }
                };
                reader.readAsText(file);
                e.target.value = '';
            });

            // æ—¥å†æŒ‰é’®äº‹ä»¶
            document.getElementById('prev-month-btn').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar();
            });
            document.getElementById('next-month-btn').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar();
            });
            document.getElementById('edit-schedule-btn').addEventListener('click', (e) => {
                calendarModal.classList.toggle('calendar-editing');
                e.currentTarget.classList.toggle('active');
            });

            // æœˆå†å¼¹çª—äº‹ä»¶
            document.getElementById('weekly-schedule-btn').addEventListener('click', () => {
                if (currentView === 'student') {
                    currentScheduleDate = new Date(); // æ¯æ¬¡æ‰“å¼€éƒ½é‡ç½®åˆ°å½“å‰æœˆä»½
                    renderMonthlySchedule();
                    scheduleModal.style.display = 'flex';
                }
            });

            document.getElementById('schedule-prev-month-btn').addEventListener('click', () => {
                currentScheduleDate.setMonth(currentScheduleDate.getMonth() - 1);
                renderMonthlySchedule();
            });

            document.getElementById('schedule-next-month-btn').addEventListener('click', () => {
                currentScheduleDate.setMonth(currentScheduleDate.getMonth() + 1);
                renderMonthlySchedule();
            });

            // --- æœ€ç»ˆç‰ˆä»£ç  v6.1 (Stable Refactor) å¼€å§‹ ---
            let activeTimeEditor = null;
            let actionHistory = [];
            
            function showToast(message, onUndo) {
                const container = document.getElementById('toast-container');
                container.innerHTML = '';
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.innerHTML = `<span>${message}</span>`;
                if (onUndo) {
                    const undoBtn = document.createElement('button');
                    undoBtn.className = 'toast-undo-btn';
                    undoBtn.textContent = 'æ’¤é”€';
                    undoBtn.onclick = () => { onUndo(); toast.remove(); };
                    toast.appendChild(undoBtn);
                }
                container.appendChild(toast);
                setTimeout(() => toast.remove(), 5000);
            }

            function undoLastAction() {
                if (actionHistory.length === 0) return;
                const lastAction = actionHistory.pop();
                const student = data.projects.find(p => p.id == lastAction.studentId);
                if (!student || !student.inactiveClasses) return;
                const keyIndex = student.inactiveClasses.indexOf(lastAction.eventKey);
                if (keyIndex > -1) {
                    student.inactiveClasses.splice(keyIndex, 1);
                    saveData();
                    renderMonthlySchedule();
                }
            }

            function removeTimeEditor(shouldSaveChanges = false) {
                if (!activeTimeEditor) return;
                if (shouldSaveChanges) {
                    const { studentId, eventKey } = activeTimeEditor.dataset;
                    const student = data.projects.find(p => p.id == studentId);
                    if (student) {
                        const newStart = activeTimeEditor.querySelectorAll('input')[0].value;
                        const newEnd = activeTimeEditor.querySelectorAll('input')[1].value;
                        if (!Array.isArray(student.overriddenClasses)) student.overriddenClasses = [];
                        const existingOverrideIndex = student.overriddenClasses.findIndex(o => o.key === eventKey);
                        if (existingOverrideIndex > -1) student.overriddenClasses.splice(existingOverrideIndex, 1);
                        const originalStartTime = eventKey.split('_')[1];
                        const originalClass = student.classTime.find(ct => ct.start === originalStartTime);
                        if (!originalClass || newStart !== originalClass.start || newEnd !== originalClass.end) {
                           student.overriddenClasses.push({ key: eventKey, newStart, newEnd });
                        }
                        saveData();
                        renderMonthlySchedule();
                    }
                }
                document.removeEventListener('mousedown', handleOutsideClick, true);
                activeTimeEditor.remove();
                activeTimeEditor = null;
            }

            function handleOutsideClick(e) {
                if (activeTimeEditor && !activeTimeEditor.contains(e.target)) {
                    removeTimeEditor(true);
                }
            }
            
            const gridContainer = document.getElementById('schedule-grid-container');

            // 1. ã€æ¢å¤ã€‘æ‰‹åŠ¨æ ‡è®°å‡æ—¥/å·¥ä½œæ—¥åŠŸèƒ½
            document.getElementById('mark-dates-btn').addEventListener('click', (e) => {
                const grid = gridContainer.querySelector('.monthly-schedule-grid');
                if (!grid) return;
                grid.classList.toggle('marking-mode');
                e.currentTarget.classList.toggle('active');
            });

            gridContainer.addEventListener('click', (e) => {
                const dayCell = e.target.closest('.day-cell');
                const grid = dayCell?.parentElement;
                if (!grid || !grid.classList.contains('marking-mode') || e.target.closest('.class-entry')) {
                    return;
                }
                const dateKey = dayCell.dataset.date;
                if (!dateKey || dayCell.classList.contains('not-current-month')) return;
                const currentStatus = data.specialDates[dateKey];
                if (!currentStatus) { data.specialDates[dateKey] = 'holiday'; } 
                else if (currentStatus === 'holiday') { data.specialDates[dateKey] = 'workday'; } 
                else if (currentStatus === 'workday') { delete data.specialDates[dateKey]; }
                saveData();
                renderMonthlySchedule();
            });

            //2. æœˆè¡¨ä¸­è¯¾ç¨‹æ¡ç›®mousedownç»Ÿä¸€å¤„ç†å™¨ (v2, ç»“æ„åŠ å›ºç‰ˆ)
            gridContainer.addEventListener('mousedown', (e) => {
                const classEntry = e.target.closest('.class-entry');
                if (!classEntry) {
                    if (activeTimeEditor) removeTimeEditor(true);
                    return;
                }

                // --- ä¿®å¤ä¸€ï¼šå½“å¤„äºâ€œæ ‡è®°æ¨¡å¼â€æ—¶ï¼Œç¦æ­¢å¯¹è¯¾ç¨‹æ¡ç›®è¿›è¡Œä»»ä½•æ“ä½œ ---
                const grid = gridContainer.querySelector('.monthly-schedule-grid');
                if (grid && grid.classList.contains('marking-mode')) {
                    return; // ç›´æ¥é€€å‡ºï¼Œä¸å“åº”ä»»ä½•è¯¾ç¨‹æ¡ç›®çš„ç‚¹å‡»
                }
                
                // æ‹–æ‹½æ‰‹æŸ„çš„é€»è¾‘ä¿æŒä¸å˜
                if (e.target.classList.contains('drag-handle')) {
                    if (e.button === 0) { classEntry.draggable = true; }
                    return;
                }

                // æ–°å¢æ£€æŸ¥ï¼šç¡®ä¿åªæœ‰ç‚¹å‡»å†…å®¹åŒºæ‰ä¼šè§¦å‘åç»­äº‹ä»¶
                const contentWrapper = e.target.closest('.class-entry-content-wrapper');
                if (!contentWrapper) {
                    return; // è‹¥ç‚¹å‡»çš„ä¸æ˜¯å†…å®¹åŒºï¼ˆå¦‚è¾¹æ¡†ã€æ‰‹æŸ„å·¦ä¾§ç©ºç™½ï¼‰ï¼Œåˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
                }

                const { studentId, dateKey, startTime } = classEntry.dataset;

                const student = data.projects.find(p => p.id == studentId);
                if (!student) return;
                const eventKey = `${dateKey}_${startTime}`;

                // --- ä¿®å¤äºŒï¼šä½¿ç”¨ if...else if ç»“æ„ï¼Œç¡®ä¿å·¦é”®å’Œä¸­é”®åŠŸèƒ½ç»å¯¹äº’æ–¥ ---
                if (e.button === 0) { // å·¦é”®: ç¼–è¾‘æ—¶é—´
                    if (activeTimeEditor) { removeTimeEditor(true); return; }
                    const currentTimeText = classEntry.querySelector('.class-entry-time').textContent;
                    const [currentStart, currentEnd] = currentTimeText.split(' - ');
                    const editor = document.createElement('div');
                    editor.className = 'time-editor';
                    editor.innerHTML = `<input type="time" value="${currentStart}"><span>-</span><input type="time" value="${currentEnd}">`;
                    editor.querySelectorAll('input[type="time"]').forEach(input => {
                        input.addEventListener('wheel', wheelEvent => {
                            wheelEvent.preventDefault();
                            const time = input.value.split(':');
                            let h = parseInt(time[0]), m = parseInt(time[1]);
                            if (wheelEvent.deltaY < 0) m += 15; else m -= 15;
                            if (m >= 60) { h += Math.floor(m / 60); m %= 60; } 
                            else if (m < 0) { h += Math.floor(m / 60); m = 60 + (m % 60); }
                            h = (h + 24) % 24;
                            input.value = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                        });
                    });
                    document.body.appendChild(editor);
                    const rect = classEntry.getBoundingClientRect();
                    editor.style.top = `${window.scrollY + rect.top}px`;
                    editor.style.left = `${window.scrollX + rect.left}px`;
                    activeTimeEditor = editor;
                    activeTimeEditor.dataset.studentId = studentId;
                    activeTimeEditor.dataset.eventKey = eventKey;
                    const firstInput = editor.querySelector('input');
                    firstInput.focus();
                    editor.addEventListener('keydown', (keyEvent) => {
                        if (keyEvent.key === 'Enter') { keyEvent.preventDefault(); removeTimeEditor(true); } 
                        else if (keyEvent.key === 'Escape') { keyEvent.preventDefault(); removeTimeEditor(false); }
                    });
                    setTimeout(() => document.addEventListener('mousedown', handleOutsideClick, true), 0);
                
                } else if (e.button === 1) { // ä¸­é”®: éšè—/åˆ é™¤
                    e.preventDefault();
                    if (!Array.isArray(student.inactiveClasses)) student.inactiveClasses = [];
                    if (student.inactiveClasses.includes(eventKey)) return;
                    student.inactiveClasses.push(eventKey);
                    saveData();
                    renderMonthlySchedule();
                    actionHistory.push({ type: 'inactivate', studentId, eventKey });
                    showToast('è¯¾ç¨‹å·²éšè—', undoLastAction);
                }
            });

            //3. æ‹–æ‹½ç”Ÿå‘½å‘¨æœŸæ—¶é—´
            gridContainer.addEventListener('dragstart', (e) => {
                const classEntry = e.target.closest('.class-entry');
                if (!classEntry || !classEntry.draggable) { e.preventDefault(); return; }
                setTimeout(() => classEntry.style.opacity = '0.5', 0);
                const currentTimeText = classEntry.querySelector('.class-entry-time').textContent;
                const [, currentEnd] = currentTimeText.split(' - ');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('application/json', JSON.stringify({ studentId: classEntry.dataset.studentId, originalDate: classEntry.dataset.dateKey, originalStart: classEntry.dataset.startTime, currentEnd: currentEnd }));
            });
            gridContainer.addEventListener('dragend', (e) => {
                const classEntry = e.target.closest('.class-entry');
                if (classEntry) {
                    classEntry.style.opacity = '1';
                    classEntry.draggable = false;
                }
                gridContainer.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            });
            gridContainer.addEventListener('dragover', (e) => { e.preventDefault(); const dayCell = e.target.closest('.day-cell'); if (dayCell) { gridContainer.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); dayCell.classList.add('drag-over'); } });
            gridContainer.addEventListener('dragleave', (e) => { const dayCell = e.target.closest('.day-cell'); if (dayCell) dayCell.classList.remove('drag-over'); });
            gridContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                const dayCell = e.target.closest('.day-cell');
                if (!dayCell) return;
                dayCell.classList.remove('drag-over');
                try {
                    const droppedData = JSON.parse(e.dataTransfer.getData('application/json'));
                    const targetDate = dayCell.dataset.date;
                    if (!droppedData || !targetDate || targetDate === droppedData.originalDate) return;
                    const student = data.projects.find(p => p.id == droppedData.studentId);
                    if (!student) return;
                    const originalKey = `${droppedData.originalDate}_${droppedData.originalStart}`;
                    const newKey = `${targetDate}_${droppedData.originalStart}`;
                    if (!student.overriddenClasses) student.overriddenClasses = [];
                    const movedOverrideIndex = student.overriddenClasses.findIndex(o => o.key === originalKey);
                    if (movedOverrideIndex > -1) { student.overriddenClasses.splice(movedOverrideIndex, 1); }
                    if (!student.inactiveClasses) student.inactiveClasses = [];
                    const originalRecurringIndex = student.inactiveClasses.indexOf(newKey);
                    if (originalRecurringIndex > -1) { student.inactiveClasses.splice(originalRecurringIndex, 1); }
                    if (movedOverrideIndex === -1) {
                         if (!student.inactiveClasses.includes(originalKey)) { student.inactiveClasses.push(originalKey); }
                    }
                    const existingOverrideIndex = student.overriddenClasses.findIndex(o => o.key === newKey);
                    if (existingOverrideIndex > -1) student.overriddenClasses.splice(existingOverrideIndex, 1);
                    student.overriddenClasses.push({ key: newKey, newStart: droppedData.originalStart, newEnd: droppedData.currentEnd });
                    saveData();
                    renderMonthlySchedule();
                } catch (err) { console.error("Drop error:", err); }
            });
            
            // 4. å…¨å±€é”®ç›˜ç›‘å¬
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                    e.preventDefault();
                    undoLastAction();
                }
            });
            // --- æœ€ç»ˆç‰ˆä»£ç  v6.1 (Stable Refactor) ç»“æŸ ---
            
            displayVersionAndTime(); // åˆå§‹åŒ–ç‰ˆæœ¬å’Œæ—¶é—´æ˜¾ç¤º
            initializeBoard('work');
        });
    })();
    </script>

</body>
</html>