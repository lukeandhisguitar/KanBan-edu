<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>看板</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ============================================= */
        /* =========== 基础布局 & 侧边栏样式 =========== */
        /* ============================================= */
        body {
            margin: 0;
            font-size: 14px;
            user-select: none;
            overflow-x: hidden; /* 防止水平滚动条 */
        }
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 220px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            padding: 1.5rem 0;
            transition: all 0.3s ease;
        }
        .sidebar-header {
            padding: 0 1.5rem;
            margin-bottom: 2.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .sidebar-logo {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
        }
        .sidebar-title {
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: 1px;
        }
        .sidebar-nav {
            padding: 0 1rem;
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.85rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .nav-icon {
            width: 20px;
            height: 20px;
            margin-right: 1rem;
            stroke-width: 2;
        }
        .main-content {
            flex-grow: 1;
            padding: 2rem 4rem;
            transition: background-color 0.3s ease;
        }
        #main-title {
              margin: 0;
              font-weight: 600;
        }

        /* 通用UI组件样式 */
        .controls { display: flex; align-items: center; gap: 1.25rem; }
        .header-btn {
            display: inline-flex; align-items: center; justify-content: center; height: 40px; padding: 0;
            border: none; font-weight: 500; font-size: 14px; cursor: pointer; transition: all 0.2s ease-in-out;
            overflow: hidden; color: white;
        }
        .header-btn:hover { transform: translateY(-2px); }
        .btn-text { padding: 0 0.75rem 0 1rem; letter-spacing: 0.5px; }
        .btn-icon { width: 40px; height: 100%; display: flex; align-items: center; justify-content: center; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; justify-content: center; align-items: center; }
        .modal-content { padding: 2rem; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .modal-actions { margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 1rem; }
         
        .project-table-wrapper { overflow-x: auto; }
        .project-table { border-collapse: collapse; width: 100%;}
        .project-row, .project-header-row { display: grid; align-items: center; border-bottom: 1px solid var(--border-color); min-height: 58px; }
        .project-table .project-row:last-child { border-bottom: none; }
        .project-header-row { position: sticky; top: 0; z-index: 20; font-size: 14px; font-weight: 600; }
        .cell, .header-cell { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding: 1rem 1rem; position: relative; border-right: 1px solid var(--border-color); min-width: 30px; }
        .cell:last-child, .header-cell:last-child { border-right: none; }
        .header-cell { cursor: grab; display: flex; align-items: center; gap: 8px; }
        .action-cell, .header-cell[data-key="actions"] { position: sticky; right: 0; z-index: 15; }
        .resize-handle { display: none; } /* 禁用调整宽度功能 */
        .header-icon-svg { width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; flex-shrink: 0; }
        .bottom-controls-container { padding-top: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .add-project-btn { padding: 0.5rem; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; border-radius: 6px; }
        .inline-editor { position: absolute; top: 2px; left: 2px; right: 2px; bottom: 2px; z-index: 10; }
        .inline-editor input, .inline-editor select { width: 100%; height: 100%; border-radius: 3px; font-size: 14px; box-sizing: border-box; }

        /* 新增：拖拽排序相关样式 */
        .project-row.dragging {
            opacity: 0.5;
            background: var(--hover-bg);
        }
        .drag-over {
            border-top: 2px solid var(--primary-color);
        }
        .seq-cell { /* 为序号单元格增加可拖拽的光标 */
            cursor: move;
        }

        /* ============================================= */
        /* =========== 主题一: 深空商务 (工作) =========== */
        /* ============================================= */
        .theme-work {
            --bg-color: #111827; --text-color: #d1d5db; --text-color-secondary: #9ca3af;
            --border-color: #374151; --header-bg: #1f2937; --hover-bg: #2b3a50;
            --primary-color: #3b82f6; --sidebar-bg: #0f172a; --sidebar-text: #94a3b8;
            --sidebar-hover-bg: #1e293b; --sidebar-active-bg: #3b82f6; --sidebar-active-text: #ffffff;
            --modal-bg: #1f2937;
            --pill-text-color: white;
            --btn-config-color: #8b5cf6; --btn-export-color: #10b981; --btn-import-color: #6b7280;
        }
        .theme-work .sidebar { background-color: var(--sidebar-bg); }
        .theme-work .sidebar-logo { background-color: var(--primary-color); color: white; }
        .theme-work .sidebar-title { color: #f1f5f9; }
        .theme-work .nav-item { color: var(--sidebar-text); }
        .theme-work .nav-item:hover { background-color: var(--sidebar-hover-bg); color: #e2e8f0; }
        .theme-work .nav-item.active { background-color: var(--sidebar-active-bg); color: var(--sidebar-active-text); font-weight: 600;}
        .theme-work .main-content { background-color: var(--bg-color); color: var(--text-color); font-family: 'Inter', sans-serif;}
        .theme-work #main-title { color: #f9fafb; }
        .theme-work .header-btn { border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2); }
        .theme-work .btn-icon { background-color: rgba(255,255,255,0.05); }
        .theme-work #config-btn { background-color: var(--btn-config-color); }
        .theme-work #export-btn { background-color: var(--btn-export-color); }
        .theme-work #import-btn { background-color: var(--btn-import-color); }
        .theme-work .project-table-wrapper { border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); background-color: var(--header-bg); }
        .theme-work .project-header-row { color: #e5e7eb; background-color: #2b3a50; border-bottom: 2px solid var(--border-color); }
        .theme-work .modal { background-color: rgba(17, 24, 39, 0.6); backdrop-filter: blur(4px); }
        .theme-work .modal-content { background-color: var(--modal-bg); border-radius: 8px; border: 1px solid var(--border-color); color: var(--text-color); }
        .theme-work .cell-name-span { font-weight: 500; color: #f9fafb; }
        .theme-work .pill { padding: 3px 12px; font-size: 12px; font-weight: 500; display: inline-block; border-radius: 999px; }
        .theme-work .pill[data-value="尚未开始"] { background-color: #374151; color: #d1d5db; }
        .theme-work .pill[data-value="初步接触"] { background-color: #1e3a8a; color: #dbeafe; }
        .theme-work .pill[data-value="正在推进"] { background-color: #92400e; color: #fef3c7; }
        .theme-work .pill[data-value="顺利完成"] { background-color: #064e3b; color: #d1fae5; }
        .theme-work .pill[data-value="已经放弃"] { background-color: #4b5563; color: #9ca3af; }
        .theme-work .pill[data-value="股权"] { background-color: #115e59; color: #ccfbf1; }
        .theme-work .pill[data-value="并购"] { background-color: #4c1d95; color: #ede9fe; }
        .theme-work .pill[data-value="不良"] { background-color: #7c2d12; color: #ffedd5; }
        .theme-work .pill[data-value="其他"] { background-color: #334155; color: #e2e8f0; }
        .theme-work #project-form-fields input, .theme-work #project-form-fields select, .theme-work #project-form-fields textarea { background-color: #2b3a50; color: var(--text-color); border: 1px solid var(--border-color); border-radius: 6px; padding: 0.75rem;}
        .theme-work .add-project-btn { color: var(--text-color-secondary); font-weight: 500; }
        .theme-work .add-project-btn:hover { background-color: var(--header-bg); color: #f9fafb; }
        .theme-work .inline-editor input, .theme-work .inline-editor select { font-family: 'Inter', sans-serif; background-color: #111827; color: var(--text-color); border: 2px solid var(--primary-color);}
        .theme-work .action-btn { color: #6b7280; }

        /* ============================================= */
        /* =========== 主题二: 学院绿茵 (教学) =========== */
        /* ============================================= */
        .theme-student {
            --bg-color: #f4f8f7; --text-color: #2c3e50; --border-color: #dce4e1;
            --header-bg: #eaf3f0; --hover-bg: #f0f5f3; --primary-color: #27ae60;
            --sidebar-bg: #ffffff; --sidebar-text: #34495e;
            --sidebar-hover-bg: #f3f9f6; --sidebar-active-bg: #27ae60; --sidebar-active-text: #ffffff;
            --modal-bg: #ffffff;
            --btn-config-color: #8e44ad; --btn-export-color: #2980b9; --btn-import-color: #7f8c8d;
        }
        .theme-student .sidebar { background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); }
        .theme-student .sidebar-logo { background-color: var(--primary-color); color: white; }
        .theme-student .sidebar-title { color: #16a085; }
        .theme-student .nav-item { color: var(--sidebar-text); }
        .theme-student .nav-item:hover { background-color: var(--sidebar-hover-bg); color: var(--primary-color); }
        .theme-student .nav-item.active { background-color: var(--sidebar-active-bg); color: var(--sidebar-active-text); font-weight: 600; }
        .theme-student .main-content {
            background-color: var(--bg-color); color: var(--text-color); font-family: 'Noto Sans SC', sans-serif;
            background-image: linear-gradient(rgba(45, 174, 96, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(45, 174, 96, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .theme-student #main-title { color: #16a085; }
        .theme-student .header-btn { border-radius: 99px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
        .theme-student .btn-icon { background-color: rgba(0,0,0,0.1); }
        .theme-student #config-btn { background-color: var(--btn-config-color); }
        .theme-student #export-btn { background-color: var(--btn-export-color); }
        .theme-student #import-btn { background-color: var(--btn-import-color); }
        .theme-student .project-table-wrapper { border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .theme-student .project-header-row { color: #34495e; background-color: var(--header-bg); border-bottom: 2px solid #b2d8c4; border-top-left-radius: 12px; border-top-right-radius: 12px; }
        .theme-student .action-cell, .theme-student .header-cell[data-key="actions"] { background-color: var(--bg-color); border-left: 1px solid #c8d5d1;}
        .theme-student .project-header-row .header-cell[data-key="actions"] { background-color: var(--header-bg); }
        .theme-student .modal { background-color: rgba(44, 62, 80, 0.4); }
        .theme-student .modal-content { background-color: var(--modal-bg); border-radius: 12px; }
        
        /* --- 新增：为学生编辑弹窗设置最大宽度，防止过分拉伸 --- */
        .theme-student #project-modal .modal-content {
            max-width: 650px;
        }
        
        #config-modal .modal-content { max-width: 500px; width: 100%; }
        
        /* --- 为“保存配置”按钮定义两种主题下的不同样式 --- */

        /* 1. 工作看板 (深色主题)下的“保存配置”按钮：保持实心、有质感的样式 */
        .theme-work #save-config-btn {
            background-color: var(--primary-color);
            color: #ffffff;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .theme-work #save-config-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            filter: brightness(1.1);
        }

        /* 最终版：“幽灵”按钮 v2 - 强调呼吸感和轻盈感 */
        .theme-student #save-config-btn {
            background-color: transparent;
            /* --- 核心改动：进一步降低透明度，更像“幽灵” --- */
            border: 1px solid rgba(39, 174, 96, 0.3); 
            color: rgba(39, 174, 96, 0.65);
            
            box-shadow: 0 2px 4px rgba(39, 174, 96, 0.35);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.25s ease-in-out;
            
            /* --- 核心改动：解决拥挤，营造“呼吸感” --- */
            font-size: 11px; /* 字体再小一点 */
            font-weight: 500; /* 字重降低，更显轻盈 */
            letter-spacing: 0.5px; /* 拉开字符间距 */
            padding: 6px 20px; /* 垂直变窄，水平变宽，让文字舒展 */
        }

        /* 悬停时的“扎实”感保持不变 */
        .theme-student #save-config-btn:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: #ffffff;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(39, 174, 96, 0.25);
        }

        #config-form-fields label { display: inline-flex; align-items: center; gap: 8px; }
        .theme-student .cell { font-weight: 500; }
        .theme-student .cell-name-span { color: #2c3e50; }
        
        .theme-student .pill { padding: 4px 14px; font-size: 12px; display: inline-block; border-radius: 16px; border: 1px solid transparent; }
        .theme-student .pill[data-value="ALEVEL"] { background-color: #eafaf1; color: #1e8449; border-color: #a3d9b8; }
        .theme-student .pill[data-value="AP"] { background-color: #e8f6f3; color: #117864; border-color: #9edad8; }
        .theme-student .pill[data-value="IB"] { background-color: #fef5e7; color: #d35400; border-color: #f5cba7; }
        .theme-student .pill[data-value="IGCSE"] { background-color: #f4ecf7; color: #884ea0; border-color: #d7bde2; }
        .theme-student .pill[data-value="数学"] { background-color: #eaf2f8; color: #2980b9; border-color: #a9cce3; }
        .theme-student .pill[data-value="物理"] { background-color: #fdedec; color: #c0392b; border-color: #f5b7b1; }
        .theme-student .pill[data-value="化学"] { background-color: #ebf5fb; color: #2471a3; border-color: #aed6f1; }
        .theme-student .pill[data-value="经济"] { background-color: #f6eefc; color: #7d3c98; border-color: #dcbbf4; }

        .theme-student #project-form-fields input, .theme-student #project-form-fields select, .theme-student #project-form-fields textarea {
            /* 新增下面这两行 */
            box-sizing: border-box; /* 关键：确保 padding 和 border 不会撑大盒子 */
            height: 44px;           /* 关键：强制所有输入框高度统一 */

            /* 以下是原有样式，保持不变 */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
        }

        .theme-student .add-project-btn { color: #34495e; font-weight: 500;}
        .theme-student .add-project-btn:hover { background-color: #eaf3f0; color: #16a085; }
        .theme-student .inline-editor input, .theme-student .inline-editor select { font-family: 'Noto Sans SC', sans-serif; border: 2px solid var(--primary-color);}
        .theme-student .action-btn { cursor: pointer; padding: 2px; border-radius: 8px; transition: all 0.2s; vertical-align: middle; display: inline-flex; align-items: center; color: #95a5a6; flex-shrink: 0; font-size: 18px;}
        .theme-student .action-btn:hover { background-color: #ecf0f1; color: var(--primary-color); }
        
        /* 教学进度弹窗样式 */
        .theme-student #progress-modal .modal-content { max-width: 800px; transition: max-width 0.4s ease; }
        .theme-student #progress-modal-body.side-by-side ~ .modal-content, .theme-student #progress-modal .modal-content.side-by-side-mode { max-width: 1200px; }
        .theme-student #progress-modal-body { display: flex; gap: 2rem; }
        .theme-student #progress-log-list-wrapper { width: 100%; transition: width 0.4s ease; position: relative; padding-bottom: 50px; }
        .theme-student #progress-modal-body.side-by-side #progress-log-list-wrapper { width: 50%; padding-bottom: 0;}
        .theme-student #progress-log-list { max-height: 60vh; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; background-color: #fdfefe; }
        .theme-student #progress-log-list:empty::after { content: '暂无教学记录，请在下方添加第一条。'; color: #95a5a6; text-align: center; display: block; padding: 3rem 0; }
        .theme-student #show-add-log-form-btn { position: absolute; bottom: 0; right: 0; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; padding: 0.6rem 1.2rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .theme-student #show-add-log-form-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .theme-student #progress-modal-body.side-by-side #show-add-log-form-btn { display: none; }
        .theme-student #progress-log-form { display: none; width: 0; transition: width 0.4s ease; }
        .theme-student #progress-modal-body.side-by-side #progress-log-form { display: block; width: 50%; }
        .theme-student .progress-log-entry { position: relative; border-bottom: 1px solid var(--border-color); padding: 1.5rem 0.5rem; }
        .theme-student .progress-log-entry:last-child { border-bottom: none; }
        .theme-student .log-entry-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; }
        .theme-student .log-entry-date { position: relative; font-weight: 700; font-size: 1.1em; color: var(--text-color); }
        .theme-student .log-entry-duration { position: relative; font-size: 13px; color: #7f8c8d; background-color: #ecf0f1; padding: 3px 10px; border-radius: 12px; }
        .theme-student .log-entry-body { display: grid; grid-template-columns: 115px 1fr; gap: 0.8rem 1rem; font-size: 14px; }
        .theme-student .log-entry-body dt { font-weight: 500; color: #34495e; text-align: right; padding-right: 1rem; border-right: 2px solid var(--header-bg);}
        .theme-student .log-entry-body dd { position: relative; margin: 0; white-space: pre-wrap; word-break: break-word; line-height: 1.6; }
        .theme-student dd[data-homework-status="已完成"] { color: #27ae60; font-weight: 500; }
        .theme-student dd[data-homework-status="部分完成"] { color: #f39c12; font-weight: 500; }
        .theme-student dd[data-homework-status="未提交"] { color: #e74c3c; font-weight: 500; }
        .theme-student dd[data-homework-status="待检查"] { color: #3498db; font-weight: 500; }
        .theme-student #progress-log-form { border-left: 1px solid var(--border-color); padding-left: 2rem; max-height: 65vh; overflow-y: auto;}
        .theme-student #progress-log-form h3 { margin-top: 0; margin-bottom: 1.5rem; font-size: 16px; font-weight: 700;}
        .theme-student .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem 1.5rem; }
        .theme-student .form-field { display: flex; flex-direction: column; }
        .theme-student .form-field.full-width { grid-column: 1 / -1; }
        .theme-student .form-field label { font-weight: 500; margin-bottom: 0.5rem; font-size: 13px; color: #34495e;}
        .theme-student .form-field input, .theme-student .form-field select, .theme-student .form-field textarea {
            width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px;
            box-sizing: border-box; font-family: 'Noto Sans SC', sans-serif; font-size: 14px; transition: all 0.2s;
        }
        .theme-student .form-field input:focus, .theme-student .form-field select:focus, .theme-student .form-field textarea:focus {
            border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1); outline: none;
        }
        .theme-student .delete-log-btn {
            position: absolute;
            bottom: 1rem;
            right: 0.5rem;
            width: 28px;
            height: 28px;
            background-color: #fdedec;
            color: #c0392b;
            border: 1px solid #f5b7b1;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s ease-in-out;
            font-size: 16px;
            font-weight: bold;
        }
        .theme-student .progress-log-entry:hover .delete-log-btn { opacity: 1; }
        .theme-student .delete-log-btn:hover { background-color: #e74c3c; color: white; transform: scale(1.1); }
        .theme-student .log-inline-editor { position: absolute; top: 0; left: 0; z-index: 1010; }
        .theme-student .log-inline-editor input, 
        .theme-student .log-inline-editor select, 
        .theme-student .log-inline-editor textarea {
             box-sizing: border-box;
             font-family: 'Noto Sans SC', sans-serif;
             font-size: inherit;
             line-height: inherit;
             border-radius: 4px;
             border: 2px solid var(--primary-color);
             padding: 0 2px;
             resize: none;
        }
/* --- 新增：为历史记录条目添加可点击光标 --- */
        .theme-student .log-entry-date,
        .theme-student .log-entry-duration,
        .theme-student .log-entry-body dd {
            cursor: pointer;
        }

        /* --- 新增：当进入分栏模式时，取消可点击光标 --- */
        .theme-student #progress-modal-body.side-by-side .log-entry-date,
        .theme-student #progress-modal-body.side-by-side .log-entry-duration,
        .theme-student #progress-modal-body.side-by-side .log-entry-body dd {
            cursor: default;
        }

/* ============================================= */
        /* =========== 日历相关样式 (最终修正版) ======== */
        /* ============================================= */

        /* --- 学生个人上课日历 (#calendar-modal) --- */
        #calendar-modal .modal-content { max-width: 500px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .calendar-header h2 { margin: 0; font-size: 1.2rem; font-weight: 600; color: #34495e;}
        .calendar-header button { background: none; border: 1px solid transparent; border-radius: 6px; padding: 0.4rem 0.8rem; cursor: pointer; transition: all 0.2s; font-weight: 500; }
        .calendar-header button:hover { background-color: #ecf0f1; }
        #edit-schedule-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        #calendar-grid .day-header, #calendar-grid .day-cell { padding: 0.5rem; border-radius: 8px; }
        #calendar-grid .day-header { font-weight: 600; color: #95a5a6; font-size: 13px; }
        #calendar-grid .day-cell { color: #7f8c8d; }
        #calendar-grid .current-month-day { color: var(--text-color); }
        #calendar-grid .day-cell.taught { background-color: #a3d9b8; color: #1e8449; font-weight: bold; }
        #calendar-modal.calendar-editing .current-month-day { cursor: pointer; }
        #calendar-modal.calendar-editing .current-month-day:hover { background-color: #eafaf1; }

        /* --- 教师月表 (#schedule-modal) --- */
        .theme-student #weekly-schedule-btn { background-color: #1abc9c; }
        .theme-student #schedule-modal .modal-content {
            max-width: 90vw;
            width: 1200px;
            padding: 2rem 2.5rem;
        }
        #schedule-modal-header {
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 0 0.5rem;
        }
        #schedule-class-count {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            background-color: #eafaf1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #a3d9b8;
        }
        #schedule-modal-title {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-weight: 700;
            font-size: 1.5rem;
            color: #2c3e50;
            margin: 0;
        }
        #schedule-controls button {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        #schedule-controls button:hover {
            background-color: #ecf0f1;
            border-color: #bdc3c7;
        }

        #mark-dates-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .monthly-schedule-grid.marking-mode .day-cell.not-current-month {
            cursor: not-allowed;
        }
        .monthly-schedule-grid.marking-mode .day-cell {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .monthly-schedule-grid.marking-mode .day-cell:hover {
            background-color: #f0f5f3;
        }
        .monthly-schedule-grid .day-cell.holiday {
            background-color: #fef5e7; /* 淡黄色背景表示假日 */
        }
        .monthly-schedule-grid .day-cell.special-workday {
            background-color: #eafaf1; /* 淡绿色背景表示特殊工作日 */
        }
        

        .monthly-schedule-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border-top: 1px solid var(--border-color);
            border-left: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }
        .monthly-schedule-grid .day-header, .monthly-schedule-grid .day-cell {
            padding: 8px;
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }
        .monthly-schedule-grid .day-header {
            font-weight: 600;
            text-align: center;
            background-color: var(--header-bg);
            color: #34495e;
        }
        .monthly-schedule-grid .day-cell {
            min-height: 120px;
            background-color: #fdfdfd;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
        }
        .monthly-schedule-grid .day-cell.not-current-month { background-color: #f9fafb; color: #bdc3c7; }
        .monthly-schedule-grid .day-number {
            font-weight: 600;
            font-size: 13px;
            color: #7f8c8d;
            margin-bottom: 4px;
        }
        .monthly-schedule-grid .day-cell.not-current-month .day-number { color: #dce4e1; }
        .class-entries-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .class-entry {
            border-left: 4px solid;
            border-radius: 4px;
            padding: 5px 8px;
            width: 100%;
            text-align: left;
            box-sizing: border-box;
            line-height: 1.4;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
        }
        
        .class-entry-content-wrapper {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .drag-handle {
            width: 10px;
            height: 16px;
            cursor: grab;
            opacity: 0.2;
            transition: opacity 0.2s;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="6" height="12" viewBox="0 0 6 12"><circle cx="2" cy="2" r="1.5" fill="%23555" /><circle cx="2" cy="6" r="1.5" fill="%23555" /><circle cx="2" cy="10" r="1.5" fill="%23555" /></svg>');
            background-repeat: no-repeat;
            background-position: center;
            flex-shrink: 0;
            margin-right: 6px;
        }

        .class-entry:hover .drag-handle {
            opacity: 0.8;
        }
        
        .drag-handle:active {
            cursor: grabbing;
        }
        
        .class-entry.inactive {
            background-color: #f1f2f6 !important; /* Use !important to override inline style */
            border-left: none;
            padding-left: 12px;
            color: #a4b0be !important; /* Use !important to override inline style */
            text-decoration: line-through;
        }
        .class-entry-time {
            font-weight: 700;
            font-size: 13px;
            margin-right: 5px;
        }
        .student-name {
            font-weight: 500;
            font-size: 12px;
            padding-left: 2px;
        }
        
        /* --- 撤销提示条 (Toast) 与 时间编辑器 --- */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background-color: #2c3e50;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            opacity: 0;
            transform: translateY(20px);
            animation: toast-in 0.5s forwards;
        }
        @keyframes toast-in { to { opacity: 1; transform: translateY(0); } }
        .toast-undo-btn {
            background: none;
            border: none;
            color: #3498db;
            font-weight: 600;
            cursor: pointer;
            padding: 5px;
            font-size: 14px;
        }
        .time-editor {
            position: absolute;
            background-color: white;
            border: 2px solid var(--primary-color);
            border-radius: 6px;
            padding: 8px;
            z-index: 1010;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .time-editor input[type="time"] {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 4px;
            font-size: 13px;
            width: 90px;
        }



/* --- 新增：页脚版本与时间信息样式 --- */
        #info-footer {
            /* 默认颜色，适用于亮色主题 */
            color: #6b7280;
            z-index: 999;
        }
        #time-line {
            color: #9ca3af;
        }
        /* 在深色主题下自动反转颜色 */
        .theme-work #info-footer {
            color: #9ca3af;
        }
        .theme-work #time-line {
            color: #6b7280;
        }

    </style>
</head>
<body>

    <div class="dashboard-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">K</div>
                <div class="sidebar-title">看板</div>
            </div>
            <nav class="sidebar-nav">
                <a class="nav-item" id="nav-work">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
                    <span>项目看板</span>
                </a>
                <a class="nav-item" id="nav-student">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                    <span>教育看板</span>
                </a>
                <a class="nav-item" id="instructions-btn" style="margin-top: 2rem;">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    <span>使用说明</span>
                </a>
            </nav>
        </div>

        <main class="main-content">
            <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h1 id="main-title"></h1>
                <div class="controls">
                    <button class="header-btn" id="config-btn">
                        <span class="btn-text">看板配置</span>
                        <span class="btn-icon">
                            <svg style="width: 20px; height: 20px; stroke-width: 1.5;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19-.15-.24-.42-.12-.64l2 3.46c.12-.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69-.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65z"></path><circle cx="12" cy="12" r="3.5"></circle></svg>
                        </span>
                    </button>
                    <button class="header-btn" id="export-btn">
                        <span class="btn-text">备份数据</span>
                        <span class="btn-icon">
                            <svg style="width: 20px; height: 20px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M5 20h14v-2H5v2zm7-18L5.33 9h3.58v6h6.18V9h3.58L12 2z"></path></svg>
                        </span>
                    </button>
                    <input type="file" id="import-input" accept=".json" style="display: none;">
                    <button class="header-btn" id="import-btn">
                        <span class="btn-text">恢复数据</span>
                        <span class="btn-icon">
                            <svg style="width: 20px; height: 20px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M5 20h14v-2H5v2zM12 2l6.67 7h-3.58v6h-6.18V9H5.33L12 2z" transform="rotate(180 12 12)"></path></svg>
                        </span>
                    </button>
                    <button class="header-btn" id="weekly-schedule-btn" style="display: none;"> 
                        <span class="btn-text">生成月表</span>
                        <span class="btn-icon">
                            <svg style="width: 20px; height: 20px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line><path d="M7 14h.01"></path><path d="M12 14h.01"></path><path d="M17 14h.01"></path><path d="M7 18h.01"></path><path d="M12 18h.01"></path><path d="M17 18h.01"></path></svg>
                        </span>
                    </button>
                </div>
            </header>

            <div class="project-table-wrapper">
                <div class="project-table" id="board-container"></div>
            </div>
            <div class="bottom-controls-container">
                <a class="add-project-btn" id="add-btn"></a>
            </div>
        </main>
    </div>

    <div id="project-modal" class="modal">
        <div class="modal-content">
            <form id="project-form">
                <h2 id="modal-title"></h2>
                <input type="hidden" id="project-id" value="">
                <div id="project-form-fields" style="display: grid; grid-template-columns: 100px 1fr; gap: 1.5rem; align-items: center; margin-top: 2.5rem;"></div>
                <div class="modal-actions">
                    <button type="submit" id="save-project-btn" style="border: none; padding: 0.6rem 1.2rem; border-radius: 6px; font-weight: 500; cursor: pointer;">保存</button>
                    <button type="button" id="delete-btn" style="border: none; padding: 0.6rem 1.2rem; border-radius: 6px; font-weight: 500; display: none; cursor: pointer;">删除</button>
                </div>
            </form>
        </div>
    </div>
    <div id="config-modal" class="modal">
         <div class="modal-content">
            <h2 style="font-weight: 600;">看板配置</h2>
            <div id="config-form-fields" style="display: flex; flex-direction: column; gap: 1rem; padding: 2rem 1rem;"></div>
            <div class="modal-actions">
                <button type="button" id="save-config-btn" >保存配置</button>
            </div>
        </div>
    </div>
    <div id="progress-modal" class="modal">
        <div class="modal-content">
            <h2 id="progress-modal-title" style="font-weight: 600;"></h2>
            <div id="progress-modal-body">
                <div id="progress-log-list-wrapper">
                    <div id="progress-log-list"></div>
                    <button id="show-add-log-form-btn">+ 添加新记录</button>
                </div>
                <form id="progress-log-form">
                    <h3>添加新教学记录</h3>
                    <div class="form-grid">
                        <div class="form-field">
                            <label for="new-log-date">上课日期</label>
                            <input type="date" id="new-log-date" required>
                        </div>
                        <div class="form-field">
                            <label for="new-log-duration">上课时长 (小时)</label>
                            <input type="number" id="new-log-duration" step="0.5" min="0" placeholder="例如: 1.5">
                        </div>
                        <div class="form-field full-width">
                            <label for="new-log-content">上课内容</label>
                            <textarea id="new-log-content" rows="3" placeholder="简述本次课的核心内容..."></textarea>
                        </div>
                        <div class="form-field full-width">
                            <label for="new-log-feedback">反馈与表现</label>
                            <textarea id="new-log-feedback" rows="2" placeholder="记录学生的亮点与待改进之处..."></textarea>
                        </div>
                        <div class="form-field">
                            <label for="new-log-homework">作业布置</label>
                            <input type="text" id="new-log-homework" placeholder="例如: 完成练习册P25-28">
                        </div>
                        <div class="form-field">
                            <label for="new-log-homework-status">作业完成情况</label>
                            <select id="new-log-homework-status">
                                <option value="已完成">已完成</option>
                                <option value="部分完成">部分完成</option>
                                <option value="未提交">未提交</option>
                                <option value="待检查" selected>待检查</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-actions" style="margin-top: 1.5rem;">
                        <button type="button" id="return-to-log-list-btn" style="background-color: #f0f0f0; padding: 0.6rem 1.2rem; border-radius: 6px; font-weight: 500; cursor: pointer; border: 1px solid #ccc;">返回</button>
                        <button type="submit" id="save-progress-btn" style="border: none; padding: 0.6rem 1.2rem; border-radius: 6px; font-weight: 500; cursor: pointer;">保存记录</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="calendar-modal" class="modal">
        <div class="modal-content">
            <div class="calendar-header">
                <div>
                    <button id="prev-month-btn">◀</button>
                    <button id="next-month-btn">▶</button>
                </div>
                <h2 id="calendar-month-year"></h2>
                <button id="edit-schedule-btn">编辑</button>
            </div>
            <div id="calendar-grid"></div>
        </div>
    </div>

    <div id="calendar-modal" class="modal">
        {...}
    </div>
    
    <div id="schedule-modal" class="modal">
        <div class="modal-content">
            <div id="schedule-modal-header">
                <div id="schedule-class-count"></div>
                <h2 id="schedule-modal-title"></h2>
                <div id="schedule-controls">
                    <button id="mark-dates-btn">标记</button>
                    <button id="schedule-prev-month-btn">◀</button>
                    <button id="schedule-next-month-btn">▶</button>
                </div>
            </div>
            <div id="schedule-grid-container">
                </div>
        </div>
    </div>

    <div id="info-footer" style="position: fixed; left: 50%; bottom: 12px; transform: translateX(-50%); z-index: 999; text-align: center;">
        <div id="version-line" style="font-size: 12px; margin-bottom: 6px;"></div>
        <div id="time-line" style="font-size: 11px;"></div>
    </div>    
    <div id="toast-container"></div>
    <div id="instructions-modal" class="modal">
        
        <div class="modal-content" style="max-width: 800px; width: 90%;">
            <h2 style="text-align: center; font-weight: 600; margin-top: 0; margin-bottom: 2rem;">教学看板使用说明</h2>
            <div id="instructions-content" style="line-height: 1.8; max-height: 70vh; overflow-y: auto; padding-right: 1rem;">
                <p>欢迎使用教学看板！这是一个专为您进行个性化教学管理而设计的本地化工具。您的所有数据都安全地存储在您自己的浏览器中，不会上传到任何服务器。</p>
                
                <h3 style="font-weight: 600; margin-top: 2rem;">一、 主界面核心功能</h3>
                <ul style="padding-left: 20px; margin-bottom: 0;">
                    <li><strong>学生列表</strong>：主界面以表格形式展示您所有的学生记录。</li>
                    <li><strong>拖拽排序</strong>：<strong>长按</strong>每行最左侧的<strong>序号</strong>单元格，上下拖动，即可调整学生记录的显示顺序。</li>
                    <li><strong>行内编辑</strong>：单击表格中的大部分字段（如学生姓名、年级、学校等），即可直接在表格内进行修改。修改后按 <code>Enter</code> 保存，按 <code>Esc</code> 取消。</li>
                    <li><strong>添加/编辑学生</strong>：点击左下角的“<strong>+ 新增学生</strong>”按钮来创建新学生；点击每行最右侧的“<strong>•••</strong>”按钮来编辑详细信息。</li>
                </ul>
                <div style="border-bottom: 1px solid var(--border-color); margin-top: 2rem;"></div>

                <h3 style="font-weight: 600; margin-top: 2rem;">二、 学生专属功能模块</h3>
                <p>在主看板的每一行，都有两个重要的功能入口：</p>
                <ul style="padding-left: 20px; margin-bottom: 0;">
                    <li><strong>教学进度 (💬)</strong>：点击可打开该学生的专属教学日志，支持新增、查看和修改。</li>
                    <li><strong>上课日历 (🗓️)</strong>：点击可打开个人日历，用于手动标记<strong>实际已上</strong>的课程。</li>
                </ul>
                <div style="border-bottom: 1px solid var(--border-color); margin-top: 2rem;"></div>

                <h3 style="font-weight: 600; margin-top: 2rem;">三、 全局教学月历 (核心功能)</h3>
                <p>点击页面右上角的“<strong>生成月表</strong>”按钮，可以打开汇总了所有学生周期性课程的全局月历。</p>
                <ul style="padding-left: 20px; margin-bottom: 0;">
                    <li><strong>查看课时</strong>：左上角的数字代表当前月份的总课时数。</li>
                    <li><strong>修改时间 | 左键单击</strong>：<strong>单击</strong>任意课程，会弹出时间编辑器。在编辑器中，用鼠标<strong>滚轮</strong>可快速调整时间。</li>
                    <li><strong>移动课程 | 拖拽手柄</strong>：鼠标悬停在课程上，<strong>按住</strong>其最左侧浮现的 <strong>⠿</strong> 图标并拖动，可将课程移动到新日期。</li>
                    <li><strong>隐藏课程 | 中键单击</strong>：用<strong>鼠标中键</strong>（滚轮）单击任意课程，可将其隐藏。</li>
                    <li><strong>撤销操作</strong>：隐藏课程后，右下角会弹出带【撤销】按钮的提示。您也可以随时使用键盘 <code>Ctrl+Z</code> 来撤销。</li>
                    <li><strong>标记假日/工作日</strong>：点击月历右上角的“<strong>标记</strong>”按钮进入标记模式，然后单击日期即可在“常规”→“假日”(黄)→“特殊工作日”(绿)三种状态间切换。</li>
                </ul>
                <div style="border-bottom: 1px solid var(--border-color); margin-top: 2rem;"></div>

                 <h3 style="font-weight: 600; margin-top: 2rem;">四、 数据管理</h3>
                 <p>利用右上角的【看板配置】、【备份数据】、【恢复数据】按钮，可以管理看板的显示列和进行数据安全备份。</p>
            </div>
        </div>
    </div>
    <script>
    
    (() => {
        // =============================================
        // =========== 状态管理与数据定义 ===========
        // =============================================

        function displayVersionAndTime() {
            // 1. 版本信息 (可在此手动修改)
            const versionInfo = {
                version: "教学看板 v1.1.2",
                last_updated: "[2025-09-04]"
            };
            const versionLine = document.getElementById('version-line');
            if (versionLine) {
                versionLine.innerHTML = `${versionInfo.version} &nbsp; ${versionInfo.last_updated}`;
            }

            // 2. 动态本地时钟
            const timeLine = document.getElementById('time-line');
            function updateClock() {
                if (!timeLine) return;
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth() + 1;
                const day = now.getDate();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const timezoneOffset = -now.getTimezoneOffset() / 60;
                const timezoneSign = timezoneOffset >= 0 ? '+' : '-';
                const timezoneStr = `UTC${timezoneSign}${Math.abs(timezoneOffset)}`;
                const timestamp = `${year}/${month}/${day} ${hours}:${minutes}`;
                timeLine.textContent = `${timestamp} ${timezoneStr}`;
            }
            updateClock();
            setInterval(updateClock, 60000);
        }
        
        let currentView = '';
        let data, columnConfig, columnWidths;
        let isEditing = false;
        let currentCalendarDate = new Date();
        let currentCalendarProjectId = null;
        let currentScheduleDate = new Date();
        
        const workIcons = {
            name: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`,
            property: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>`,
            status: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>`,
            industry: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="M3 21h18M5 21V5l4-4h6l4 4v16"></path><path d="M9 21v-4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v4"></path><path d="M15 7H9"></path></svg>`,
            description: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>`,
            startDate: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>`,
            updatedAt: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`
        };

        const studentIcons = {
            name: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>`,
            curriculum: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="M22 10v6M2 10v6M12 2v20M22 4H2M22 20H2"></path></svg>`,
            discipline: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="m10 10.5 2 2 2-2"></path><path d="m12 12.5 v 4"></path></svg>`,
            subject: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="M12 6.25278V19.7472"></path><path d="M17 10L12 12.5L7 10"></path><path d="M17 15L12 17.5L7 15"></path><path d="M12 2L20 6L12 10L4 6L12 2Z"></path></svg>`,
            school: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>`,
            studentProfile: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>`,
            classSchedule: `<svg xmlns="http://www.w3.org/2000/svg" class="header-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>`,
            progress: `<svg xmlns="http://www.w3.org/2000/svg" class="header-icon-svg" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>`,
            updatedAt: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="header-icon-svg"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`,
        };

        const projectModal = document.getElementById('project-modal');
        const configModal = document.getElementById('config-modal');
        const progressModal = document.getElementById('progress-modal');
        const calendarModal = document.getElementById('calendar-modal');
        const scheduleModal = document.getElementById('schedule-modal');
        const instructionsModal = document.getElementById('instructions-modal')      
        
        
        // =============================================
        // =========== 主控制与切换逻辑 ===========
        // =============================================
         
        function initializeBoard(view) {
            if (currentView === view) return;
            currentView = view;
            document.body.className = `theme-${view}`;
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.getElementById(`nav-${view}`).classList.add('active');
            loadConfig();
            loadWidths();
            loadData();
            const isWork = view === 'work';
            document.getElementById('main-title').textContent = isWork ? '项目管理' : '教学进度';
            document.getElementById('add-btn').textContent = isWork ? '+ 新项目' : '+ 新增学生';

            const scheduleBtn = document.getElementById('weekly-schedule-btn');
            if (isWork) {
                scheduleBtn.style.display = 'none';
            } else {
                scheduleBtn.style.display = 'inline-flex';
            }

            const primaryColor = getComputedStyle(document.body).getPropertyValue('--primary-color');
            const textColor = getComputedStyle(document.body).getPropertyValue('--pill-text-color');
            const deleteColor = currentView === 'work' ? '#991b1b' : '#e74c3c';
            document.getElementById('save-project-btn').style.backgroundColor = primaryColor;
            document.getElementById('save-project-btn').style.color = textColor || 'white';
            document.getElementById('delete-btn').style.backgroundColor = deleteColor;
            document.getElementById('delete-btn').style.color = 'white';
            document.getElementById('save-config-btn').style.borderColor = primaryColor;
            document.getElementById('save-progress-btn').style.backgroundColor = primaryColor;
            document.getElementById('save-progress-btn').style.color = textColor || 'white';
            renderBoard();
        }

        // =============================================
        // =========== 数据加载/保存 (已适配) ===========
        // =============================================

        function getStorageKey(type) { return `${currentView}_kanban_${type}`; }
        function loadConfig() {
            const configJSON = localStorage.getItem(getStorageKey('config'));
            const defaultConfig = currentView === 'work' ? getWorkDefaultColumnConfig() : getStudentDefaultColumnConfig();
            if (configJSON) {
                try {
                    const savedConfig = JSON.parse(configJSON);
                    const defaultConfigMap = new Map(defaultConfig.map(c => [c.key, c]));
                    const migratedConfig = savedConfig.map(savedCol => {
                        const defaultCol = defaultConfigMap.get(savedCol.key);
                        if (defaultCol) return { ...defaultCol, visible: savedCol.visible };
                        return null;
                    }).filter(Boolean);
                    defaultConfig.forEach(defaultCol => {
                        if (!migratedConfig.some(c => c.key === defaultCol.key)) migratedConfig.push(defaultCol);
                    });
                    columnConfig = migratedConfig;
                } catch (e) { columnConfig = defaultConfig; }
            } else { columnConfig = defaultConfig; }
        }
        function saveConfig() { localStorage.setItem(getStorageKey('config'), JSON.stringify(columnConfig)); }
        function loadWidths() {
            const widthsJSON = localStorage.getItem(getStorageKey('widths'));
            const defaultWidths = currentView === 'work' ? getWorkDefaultWidths() : getStudentDefaultWidths();
            const defaultKeys = Object.keys(defaultWidths);

            if (widthsJSON) {
                try {
                    const savedWidths = JSON.parse(widthsJSON);
                    const savedKeys = Object.keys(savedWidths);
                    // 检查缓存的配置是否包含了代码中定义的所有列
                    if (defaultKeys.every(key => savedKeys.includes(key))) {
                        // 如果是，则使用缓存
                        columnWidths = savedWidths;
                    } else {
                        // 如果不是（说明缓存是旧版的），则强制使用代码中的新默认值
                        columnWidths = defaultWidths;
                    }
                } catch(e) {
                    columnWidths = defaultWidths;
                }
            } else {
                columnWidths = defaultWidths;
            }
        }
        function saveWidths() { localStorage.setItem(getStorageKey('widths'), JSON.stringify(columnWidths)); }
        function loadData() {
            const dataJSON = localStorage.getItem(getStorageKey('data'));
            const defaultData = currentView === 'work' ? getWorkDefaultData() : getStudentDefaultData();
            let loadedData = null;

            if (dataJSON) {
                try {
                    loadedData = JSON.parse(dataJSON);
                } catch (e) {
                    loadedData = null; // 如果JSON格式损坏，则视为空
                }
            }

            // 核心修正：只有当加载的数据真实有效，并且包含至少一个项目时，才使用它
            if (loadedData && loadedData.projects && loadedData.projects.length > 0) {
                data = loadedData;
                if (!data.specialDates) {
                    data.specialDates = {}; // 确保 specialDates 存在
                }
            } else {
                // 否则（包括localStorage为空、JSON损坏、或项目列表为空），一律加载默认数据
                data = defaultData;
            }
        }
        function saveData() { localStorage.setItem(getStorageKey('data'), JSON.stringify(data)); }

        // =============================================
        // =========== 各看板的默认配置定义 ===========
        // =============================================

        function getWorkDefaultColumnConfig() { 
            return [ 
                { key: 'name', shortLabel: '项目名称', label: `${workIcons.name} 项目名称`, type: 'text', readonly: true, visible: true }, 
                { key: 'property', shortLabel: '类型', label: `${workIcons.property} 类型`, type: 'select', options: ['股权', '并购', '不良', '其他'], visible: true }, 
                { key: 'status', shortLabel: '项目进度', label: `${workIcons.status} 项目进度`, type: 'select', options: ['尚未开始', '初步接触', '正在推进', '顺利完成', '已经放弃'], visible: true }, 
                { key: 'industry', shortLabel: '行业', label: `${workIcons.industry} 行业`, type: 'text', visible: true }, 
                { key: 'description', shortLabel: '项目介绍', label: `${workIcons.description} 项目介绍`, type: 'textarea', visible: true }, 
                { key: 'startDate', shortLabel: '接手时间', label: `${workIcons.startDate} 接手时间`, type: 'date', visible: true }, 
                { key: 'updatedAt', shortLabel: '更新时间', label: `${workIcons.updatedAt} 更新时间`, type: 'readonly', visible: true }, 
            ]; 
        }
        function getWorkDefaultData() {
            return { projects: [{ id: Date.now(), name: "示例项目：诺诺新材料", property: "并购", status: "初步接触", industry: "OLED材料", description: "该公司专注于高端OLED分子砌块和新材料的研发、生产和销售。", startDate: "2025-08-05", updatedAt: new Date().toISOString() }] };
        }
        function getWorkDefaultWidths() { 
            return { name: '2.5fr', property: '0.8fr', status: '1fr', industry: '1.2fr', description: '4fr', startDate: '1fr', updatedAt: '1.2fr' }; 
        }
        function getStudentDefaultColumnConfig() { 
            return [ 
                { key: 'studentName', shortLabel: '学生姓名', label: `${studentIcons.name} 学生姓名`, type: 'text', visible: true }, 
                { key: 'curriculum', shortLabel: '国际课程', label: `${studentIcons.curriculum} 国际课程`, type: 'select', options: ['ALEVEL', 'AP', 'IB', 'IGCSE'], visible: true }, 
                { key: 'discipline', shortLabel: '学科', label: `${studentIcons.discipline} 学科`, type: 'select', options: ['数学', '物理', '化学', '经济'], visible: true }, 
                { key: 'subject', shortLabel: '年级', label: `${studentIcons.subject} 年级`, type: 'text', visible: true }, 
                { key: 'school', shortLabel: '学校', label: `${studentIcons.school} 学校`, type: 'text', visible: true }, 
                { key: 'studentProfile', shortLabel: '学生简档', label: `${studentIcons.studentProfile} 学生简档`, type: 'textarea', visible: true },
                { key: 'classTime', shortLabel: '上课时间', label: `🕒 上课时间`, type: 'action', visible: true },
                { key: 'progress', shortLabel: '教学进度', label: `${studentIcons.progress} 教学进度`, type: 'action', visible: true },
                { key: 'classSchedule', shortLabel: '上课日历', label: `${studentIcons.classSchedule} 上课日历`, type: 'action', visible: true },
                { key: 'updatedAt', shortLabel: '更新时间', label: `${studentIcons.updatedAt} 更新时间`, type: 'readonly', visible: false }, 
            ]; 
        }

        function getStudentDefaultData() {
            const now = new Date();

            // --- 新增代码开始：动态生成“今天”和“后天”的日期 ---
            const today = new Date();
            const dayAfterTomorrow = new Date();
            dayAfterTomorrow.setDate(today.getDate() + 2);

            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const todayKey = formatDate(today);
            const dayAfterTomorrowKey = formatDate(dayAfterTomorrow);
            // --- 新增代码结束 ---

            return {
                projects: [
                    { 
                        id: 1725454800001, studentName: "芳一弦", curriculum: "ALEVEL", discipline: "物理", subject: "A2",
                        school: "苏国外", studentProfile: "目标牛津物理系，需要加强电磁学部分的解题能力。",
                        updatedAt: now.toISOString(), classTime: [ { day: 6, start: "13:00", end: "15:00" } ],
                        progressLog: [
                            { date: "2025-09-06", duration: 2, content: "复习牛顿运动定律，讲解典型例题。", feedback: "概念掌握牢固，但复杂受力分析仍有困难。", homeworkAssigned: "完成练习册P1-5", homeworkStatus: "待检查" },
                            { date: "2025-08-30", duration: 2, content: "首次课评估，摸底测试。", feedback: "运动学基础良好，需加强动力学部分。", homeworkAssigned: "预习第一章", homeworkStatus: "已完成" }
                        ], 
                        classDates: [], startDate: "2025-08-30"
                    },
                    { 
                        id: 1725454800002, studentName: "王皓轩", curriculum: "ALEVEL", discipline: "数学", subject: "AS",
                        school: "昆城外", studentProfile: "基础较好，但计算容易粗心，需要针对性训练。",
                        updatedAt: now.toISOString(), classTime: [ { day: 3, start: "18:30", end: "20:30" } ],
                        progressLog: [
                            { date: "2025-09-03", duration: 2, content: "讲解函数定义域与值域求法。", feedback: "方法理解快，但计算过程容易出错。", homeworkAssigned: "完成讲义例题", homeworkStatus: "部分完成" }
                        ], 
                        classDates: [], startDate: "2025-09-01"
                    }
                ],
                // --- 核心改动：使用动态生成的日期作为键 ---
                specialDates: {
                    [todayKey]: "holiday",
                    [dayAfterTomorrowKey]: "workday"
                }
            };
        }

        
        function getStudentDefaultWidths() { 
            return { 
                studentName: '130px',
                curriculum: '120px',
                discipline: '100px',
                subject: '100px',
                school: '100px',
                studentProfile: '1fr',
                classTime: '160px',
                classSchedule: '120px',
                progress: '120px',
                updatedAt: '140px'
            }; 
        }

        // =============================================
        // =========== 渲染与交互 (核心逻辑) ===========
        // =============================================
         
        function formatDisplayDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '无效日期';
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (e) { return ''; }
        }
         
        function getGridTemplateColumns() { 
            const visibleColumns = columnConfig.filter(c => c.visible).map(c => columnWidths[c.key] || '1fr');
            return ['50px', ...visibleColumns, '60px'].join(' '); 
        }
         
        function renderBoard() {
            const boardContainer = document.getElementById('board-container');
            boardContainer.innerHTML = '';
            const gridColumns = getGridTemplateColumns();
            const headerRow = document.createElement('div');
            headerRow.className = 'project-header-row';
            headerRow.style.gridTemplateColumns = gridColumns;
            const seqHeader = document.createElement('div');
            seqHeader.className = 'header-cell';
            seqHeader.dataset.key = '序号';
            seqHeader.style.justifyContent = 'center';
            seqHeader.textContent = '序号';
            headerRow.appendChild(seqHeader);
            const visibleColumnConfig = columnConfig.filter(c => c.visible);
            const studentColsToCenter = ['studentName', 'curriculum', 'discipline', 'school', 'progress', 'classTime', 'classSchedule'];
            visibleColumnConfig.forEach(col => { 
                const headerCell = document.createElement('div'); 
                headerCell.className = 'header-cell'; 
                headerCell.innerHTML = col.label;
                headerCell.dataset.key = col.key; 
                headerCell.draggable = true;
                if (currentView === 'student' && studentColsToCenter.includes(col.key)) {
                    headerCell.style.justifyContent = 'center';
                }
                const resizeHandle = document.createElement('div'); 
                resizeHandle.className = 'resize-handle'; 
                headerCell.appendChild(resizeHandle); 
                headerRow.appendChild(headerCell); 
            });
            headerRow.innerHTML += '<div class="header-cell" data-key="actions" style="justify-content:center;">操作</div>';
            boardContainer.appendChild(headerRow);

            initColumnDragAndDrop(headerRow);
            data.projects.forEach((project, index) => { 
                const projectRow = createProjectRow(project, gridColumns, index + 1);
                boardContainer.appendChild(projectRow);
            });
            // --- 重构代码开始：实现长按“序号”单元格进行拖拽排序 ---
            let draggedItem = null;
            let longPressTimer = null;

            boardContainer.querySelectorAll('.seq-cell').forEach(cell => {
                const row = cell.closest('.project-row');
                if (!row) return;

                const clearLongPress = () => {
                    clearTimeout(longPressTimer);
                    row.draggable = false;
                };

                // 监听鼠标按下事件，准备启动长按计时器
                cell.addEventListener('mousedown', (e) => {
                    // 只响应左键
                    if (e.button !== 0) return;
                    longPressTimer = setTimeout(() => {
                        row.draggable = true; // 长按成功，使行可拖拽
                    }, 300); // 长按300毫秒后触发
                });
                
                cell.addEventListener('mouseup', clearLongPress);
                cell.addEventListener('mouseleave', clearLongPress);
                // 如果在cell上开始拖拽（说明长按成功），也清除计时器
                cell.addEventListener('dragstart', () => clearTimeout(longPressTimer));
            });

            boardContainer.querySelectorAll('.project-row').forEach(row => {
                row.addEventListener('dragstart', () => {
                    draggedItem = row;
                    setTimeout(() => row.classList.add('dragging'), 0);
                });

                row.addEventListener('dragend', () => {
                    if (draggedItem) {
                        draggedItem.classList.remove('dragging');
                        draggedItem.draggable = false;
                    }
                    draggedItem = null;
                    clearTimeout(longPressTimer);
                    boardContainer.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                });

                row.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (row !== draggedItem) {
                        boardContainer.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                        row.classList.add('drag-over');
                    }
                });
            });
            
            const dropHandler = (e) => {
                e.preventDefault();
                boardContainer.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                const targetRow = e.target.closest('.project-row');

                if (draggedItem && targetRow && draggedItem !== targetRow) {
                    const draggedId = draggedItem.dataset.projectId;
                    const targetId = targetRow.dataset.projectId;
                    const draggedIndex = data.projects.findIndex(p => p.id == draggedId);
                    const targetIndex = data.projects.findIndex(p => p.id == targetId);

                    if (draggedIndex > -1 && targetIndex > -1) {
                        const [removed] = data.projects.splice(draggedIndex, 1);
                        data.projects.splice(targetIndex, 0, removed);
                        saveData();
                        renderBoard();
                    }
                }
            };
            
            // 移除旧的 drop 监听器（如果有），再添加新的，防止重复绑定
            boardContainer.removeEventListener('drop', dropHandler);
            boardContainer.addEventListener('drop', dropHandler);
            // --- 重构代码结束 ---

        }

        function createProjectRow(project, gridColumns, rowNumber) {
            const projectRow = document.createElement('div');
            projectRow.className = 'project-row';
            // 新增：如果是在教育看板，则根据学生ID应用左边框颜色
            if (currentView === 'student') {
                const colors = getClassColor(project.discipline, project.subject);
                // 使用边框色，并增加透明度，使其更柔和
                projectRow.style.borderLeft = `5px solid ${colors.border.replace('hsl', 'hsla').replace(')', ', 0.7)')}`;
            }
    
            projectRow.dataset.projectId = project.id;
            projectRow.style.gridTemplateColumns = gridColumns;

            // 修正：合并序号单元格的创建，并添加正确的class和title
            projectRow.innerHTML += `<div class="cell seq-cell" style="text-align:center;" title="按住拖拽可排序">${rowNumber}</div>`;
            
            const studentColsToCenter = ['studentName', 'curriculum', 'discipline', 'subject', 'school', 'progress', 'classSchedule', 'classTime'];
            columnConfig.filter(c => c.visible).forEach(col => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.key = col.key;
                if (currentView === 'student' && studentColsToCenter.includes(col.key)) {
                    cell.style.textAlign = 'center';
                }

                let value = project[col.key] || '';
                let displayHTML = '';

                switch (col.key) {
                    case 'studentName': case 'name':
                        // 修正：确保换行逻辑正确应用
                        const namesHTML = String(value).replace(/,|，/g, '<br>');
                        displayHTML = `<span class="cell-name-span">${namesHTML}</span>`;
                        break;
                    case 'updatedAt': case 'startDate':
                        displayHTML = formatDisplayDate(value);
                        break;
                    case 'classTime':
                        if (Array.isArray(project.classTime) && project.classTime.length > 0) {
                            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                            const timeStrings = project.classTime.map(time => {
                                if (time && time.day != null) {
                                    const dayName = dayNames[time.day] || '';
                                    return `${dayName} ${time.start || ''}-${time.end || ''}`;
                                }
                                return '';
                            }).filter(Boolean);
                            displayHTML = `<div style="display: flex; flex-direction: column; justify-content: center; line-height: 1.4; font-size: 13px; white-space: normal;">${timeStrings.join('<br>')}</div>`;
                        } else {
                            displayHTML = '未设置';
                        }
                        break;
                    case 'progress': case 'classSchedule':
                        const emoji = col.key === 'progress' ? '💬' : '🗓️';
                        const title = col.key === 'progress' ? '查看/编辑教学进度' : '查看/编辑上课日历';
                        displayHTML = `<span class="action-btn" title="${title}">${emoji}</span>`;
                        break;
                    default:
                        if (col.type === 'select') {
                            displayHTML = `<span class="pill" data-value="${value}">${value}</span>`;
                        } else {
                            displayHTML = value;
                        }
                }
                cell.innerHTML = displayHTML;
                cell.title = typeof value === 'string' ? value : '';
                projectRow.appendChild(cell);
            });

            const actionCell = document.createElement('div');
            actionCell.className = 'cell action-cell';
            actionCell.style.textAlign = 'center';
            actionCell.innerHTML = `<button class="edit-btn action-btn" title="编辑${currentView === 'work' ? '项目' : '学生'}信息" style="background:none; border:none;">•••</button>`;
            projectRow.appendChild(actionCell);

            projectRow.querySelector('.edit-btn').addEventListener('click', e => { e.stopPropagation(); openProjectModal(project.id); });

            projectRow.querySelectorAll('.cell[data-key]').forEach(cell => {
                const key = cell.dataset.key;
                const config = columnConfig.find(c => c.key === key);

                if (key === 'progress' || key === 'classSchedule') {
                    const btn = cell.querySelector('.action-btn');
                    if (btn) {
                        const modalFn = key === 'progress' ? openProgressModal : openCalendarModal;
                        btn.addEventListener('click', e => { e.stopPropagation(); modalFn(project.id); });
                    }
                } else if (config && !config.readonly && config.type !== 'action') {
                    cell.addEventListener('click', () => createInPlaceEditor(cell, project, key));
                }
            });

            return projectRow;
        }

        function openProjectModal(projectId = null) {
            const formFields = document.getElementById('project-form-fields');
            formFields.innerHTML = '';
            const project = projectId ? data.projects.find(p => p.id == projectId) : {};

            // Part 1: 渲染基础信息字段
            const editableColumns = columnConfig.filter(c => c.type !== 'readonly' && c.type !== 'action' && c.key !== 'classTime');
            editableColumns.forEach(col => {
                const label = document.createElement('label');
                label.textContent = `${col.shortLabel}:`;
                let input;
                if (col.type === 'select') {
                    input = document.createElement('select');
                    col.options.forEach(opt => { input.innerHTML += `<option value="${opt}">${opt}</option>`; });
                } else if (col.type === 'textarea') {
                    input = document.createElement('textarea'); input.rows = 3;
                } else {
                    input = document.createElement('input'); input.type = col.type;
                }
                input.id = `form-${col.key}`;
                input.value = project[col.key] || '';
                formFields.appendChild(label);
                formFields.appendChild(input);
            });

            // --- 重构代码开始：将开始和结束日期放在同一行 ---
            if (currentView === 'student') {
                const dateRangeLabel = document.createElement('label');
                dateRangeLabel.textContent = '课程持续时间:';
                formFields.appendChild(dateRangeLabel);

                const dateRangeWrapper = document.createElement('div');
                dateRangeWrapper.style.display = 'flex';
                dateRangeWrapper.style.alignItems = 'center';
                dateRangeWrapper.style.gap = '10px';

                const startDateInput = document.createElement('input');
                startDateInput.type = 'date';
                startDateInput.id = 'form-startDate';
                if (project.startDate) {
                    startDateInput.value = project.startDate;
                }

                const separator = document.createElement('span');
                separator.textContent = '—';

                const endDateInput = document.createElement('input');
                endDateInput.type = 'date';
                endDateInput.id = 'form-endDate';
                if (project.endDate) {
                    endDateInput.value = project.endDate;
                }

                dateRangeWrapper.appendChild(startDateInput);
                dateRangeWrapper.appendChild(separator);
                dateRangeWrapper.appendChild(endDateInput);
                formFields.appendChild(dateRangeWrapper);
            }
            // --- 重构代码结束 ---

            // Part 2: 渲染两个上课时间输入框
            if (currentView === 'student') {
                const dayNames = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
                for (let i = 1; i <= 2; i++) {
                    const label = document.createElement('label');
                    label.textContent = `上课时间 ${i}:`;
                    formFields.appendChild(label);

                    // 创建一个简单的 grid 容器
                    const inputsWrapper = document.createElement('div');
                    inputsWrapper.style.display = 'grid';
                    inputsWrapper.style.gridTemplateColumns = '1.2fr 1fr 1fr';
                    inputsWrapper.style.gap = '10px';
                    inputsWrapper.style.alignItems = 'center';
                    
                    inputsWrapper.innerHTML = `
                        <select id="form-classTime-day-${i}">
                            <option value="">无</option>
                            ${dayNames.map((day, index) => `<option value="${index}">${day}</option>`).join('')}
                        </select>
                        <input type="time" id="form-classTime-start-${i}">
                        <input type="time" id="form-classTime-end-${i}">
                    `;
                    formFields.appendChild(inputsWrapper);
                }

                // Part 3: 用已保存的数据填充时间输入框
                if (Array.isArray(project.classTime)) {
                    const time1 = project.classTime[0];
                    if (time1) {
                        document.getElementById('form-classTime-day-1').value = time1.day;
                        document.getElementById('form-classTime-start-1').value = time1.start;
                        document.getElementById('form-classTime-end-1').value = time1.end;
                    }
                    const time2 = project.classTime[1];
                    if (time2) {
                        document.getElementById('form-classTime-day-2').value = time2.day;
                        document.getElementById('form-classTime-start-2').value = time2.start;
                        document.getElementById('form-classTime-end-2').value = time2.end;
                    }
                }
            }

            document.getElementById('modal-title').textContent = `${projectId ? '编辑' : '新增'}${currentView === 'work' ? '项目' : '学生'}信息`;
            document.getElementById('project-id').value = projectId || '';
            document.getElementById('delete-btn').style.display = projectId ? 'inline-block' : 'none';
            projectModal.style.display = 'flex';
        }

        function openProgressModal(projectId) {
            if (currentView !== 'student') return;
            const project = data.projects.find(p => p.id == projectId);
            if (!project) return;
            if (!Array.isArray(project.progressLog)) { project.progressLog = []; }
            const modalBody = document.getElementById('progress-modal-body');
            const modalContent = progressModal.querySelector('.modal-content');
            modalBody.classList.remove('side-by-side');
            modalContent.classList.remove('side-by-side-mode');
            document.getElementById('progress-modal-title').textContent = `${project.studentName} - 教学进度`;
            const logList = document.getElementById('progress-log-list');
            logList.innerHTML = '';
            const logsWithOriginalIndex = project.progressLog.map((log, index) => ({ ...log, originalIndex: index }));
            const sortedLogs = logsWithOriginalIndex.sort((a, b) => new Date(b.date) - new Date(a.date));
            sortedLogs.forEach(log => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'progress-log-entry';
                entryDiv.innerHTML = `<div class="log-entry-header"><span class="log-entry-date" data-key="date">${formatDisplayDate(log.date)}</span><span class="log-entry-duration" data-key="duration">时长: ${log.duration || 'N/A'} 小时</span></div><dl class="log-entry-body"><dt>上课内容:</dt><dd data-key="content">${log.content || '未记录'}</dd><dt>反馈与表现:</dt><dd data-key="feedback">${log.feedback || '未记录'}</dd><dt>作业布置:</dt><dd data-key="homeworkAssigned">${log.homeworkAssigned || '无'}</dd><dt>作业完成情况:</dt><dd data-key="homeworkStatus" data-homework-status="${log.homeworkStatus || ''}">${log.homeworkStatus || '未记录'}</dd></dl><button class="delete-log-btn" title="删除此条记录">×</button>`;                logList.appendChild(entryDiv);
                entryDiv.querySelectorAll('[data-key]').forEach(elem => {
                    elem.addEventListener('click', (e) => createLogEntryEditor(e.currentTarget, project, log.originalIndex, elem.dataset.key));
                });

                entryDiv.querySelector('.delete-log-btn').addEventListener('click', () => {
                    if (confirm('确定要永久删除这条教学记录吗？')) {
                        project.progressLog.splice(log.originalIndex, 1);
                        project.updatedAt = new Date().toISOString();
                        saveData();
                        openProgressModal(project.id);
                    }
                });
            });
            document.getElementById('progress-log-form').dataset.projectId = projectId;
            document.getElementById('progress-log-form').reset();
            document.getElementById('new-log-date').valueAsDate = new Date();
            document.getElementById('new-log-homework-status').value = '待检查';
            progressModal.style.display = 'flex';
        }

        function createLogEntryEditor(element, project, logIndex, key) {
            const modalBody = document.getElementById('progress-modal-body');
            // 如果是分栏模式，则不允许编辑，直接退出函数
            if (modalBody.classList.contains('side-by-side')) {
                return; 
            }

            if (element.querySelector('.log-inline-editor')) return;
            isEditing = true;
            const logEntry = project.progressLog[logIndex];
            if (!logEntry) { isEditing = false; return; }
            
            element.childNodes.forEach(node => { if(node.style) node.style.visibility = 'hidden' });

            const computedStyle = window.getComputedStyle(element);
            
            const editorContainer = document.createElement('div');
            editorContainer.className = 'log-inline-editor';
            let editor;

            switch (key) {
                case 'homeworkStatus':
                    editor = document.createElement('select');
                    ['已完成', '部分完成', '未提交', '待检查'].forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt; option.textContent = opt;
                        if (opt === logEntry.homeworkStatus) option.selected = true;
                        editor.appendChild(option);
                    });
                    break;
                case 'content': case 'feedback':
                    editor = document.createElement('textarea');
                    editor.value = logEntry[key] || '';
                    break;
                default:
                    editor = document.createElement('input');
                    editor.type = (key === 'date') ? 'date' : (key === 'duration' ? 'number' : 'text');
                    if (key === 'duration') { editor.step = '0.5'; editor.min = '0'; }
                    editor.value = (key === 'date' && logEntry[key]) ? new Date(logEntry[key]).toISOString().slice(0, 10) : (logEntry[key] || '');
                    break;
            }
            editor.style.width = computedStyle.width;
            editor.style.height = computedStyle.height;

            const cleanupAndRefresh = (shouldSave) => {
                if (shouldSave) {
                    logEntry[key] = (key === 'duration') ? (parseFloat(editor.value) || null) : editor.value;
                    project.updatedAt = new Date().toISOString();
                    saveData();
                }
                isEditing = false;
                openProgressModal(project.id);
            };

            editor.addEventListener('blur', () => cleanupAndRefresh(true));
            editor.addEventListener('keydown', e => {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); editor.blur(); } 
                else if (e.key === 'Escape') { cleanupAndRefresh(false); }
            });

            editorContainer.appendChild(editor);
            element.appendChild(editorContainer);
            editor.focus();
        }

        function createInPlaceEditor(cell, project, key) {
            const config = columnConfig.find(c => c.key === key);
            if (!config || cell.querySelector('.inline-editor')) return;
            isEditing = true;
            Array.from(cell.childNodes).forEach(node => {
                if (node.style) {
                    node.style.visibility = 'hidden';
                } else if (node.nodeType === Node.TEXT_NODE) {
                    // 对于纯文本节点，我们用一个空的span来包裹它以便隐藏
                    const span = document.createElement('span');
                    span.textContent = node.textContent;
                    span.style.visibility = 'hidden';
                    cell.replaceChild(span, node);
                }
            });
            
            const editorContainer = document.createElement('div');
            editorContainer.className = 'inline-editor';
            let editor;

            if (config.type === 'select') {
                editor = document.createElement('select');
                config.options.forEach(opt => { 
                    const option = document.createElement('option'); 
                    option.value = opt; option.textContent = opt; 
                    if (opt === project[key]) option.selected = true; 
                    editor.appendChild(option); 
                });
            } else {
                editor = document.createElement('input');
                editor.type = config.type;
                editor.value = project[key] || '';
            }
            
            const cleanup = (shouldSave) => {
                if (shouldSave) {
                    project[key] = editor.value;
                    project.updatedAt = new Date().toISOString();
                    saveData();
                }
                isEditing = false;
                renderBoard();
            };

            editor.addEventListener('blur', () => cleanup(true));
            editor.addEventListener('keydown', e => {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); editor.blur(); } 
                else if (e.key === 'Escape') { cleanup(false); }
            });
            
            editorContainer.appendChild(editor);
            cell.appendChild(editorContainer);
            editor.focus();
        }
        
        // 最终版颜色系统 v3.0：基于“学科 x 年级”
        const SUBJECT_THEMES = {
            '物理': {
                light: { background: '#fdedec', border: '#f5b7b1', text: '#c0392b' }, // 淡色 (AS等)
                deep:  { background: '#f5b7b1', border: '#e74c3c', text: '#943126' }  // 深色 (A2)
            },
            '数学': {
                light: { background: '#eaf2f8', border: '#a9cce3', text: '#2980b9' }, // 淡色 (AS等)
                deep:  { background: '#aed6f1', border: '#3498db', text: '#1f618d' }  // 深色 (A2)
            },
            '默认': {
                light: { background: '#f2f4f4', border: '#d5dbdb', text: '#7f8c8d' },
                deep:  { background: '#e5e7e9', border: '#b2babb', text: '#616a6b' }
            }
        };

        function getClassColor(discipline, grade = '') {
            const theme = SUBJECT_THEMES[discipline] || SUBJECT_THEMES['默认'];
            const gradeStr = String(grade).toUpperCase();

            // 定义一个包含所有“深色”年级关键词的数组
            const deepColorKeywords = ['A2', '第二年'];

            // 检查年级字符串是否包含任何一个深色关键词
            if (deepColorKeywords.some(keyword => gradeStr.includes(keyword))) {
                return theme.deep;
            }
            return theme.light; // 其他所有情况 (AS, 第一年, IGCSE等) 都使用淡色
        }

        // =============================================
        // =========== 新增: 教师月历生成函数 v3.0 ========
        // =============================================

        function renderMonthlySchedule() {
            const container = document.getElementById('schedule-grid-container');
            const title = document.getElementById('schedule-modal-title');
            container.innerHTML = '';
            const year = currentScheduleDate.getFullYear();
            const month = currentScheduleDate.getMonth();
            title.textContent = `${year} 年 ${month + 1} 月`;
            
            let totalClasses = 0;
            const monthScheduleData = {};

            // 1. 数据处理
            data.projects.forEach(student => {
                if (Array.isArray(student.classTime)) {
                    student.classTime.forEach(time => {
                        if (time.day == null || !time.start) return;
                        for (let i = 1; i <= 31; i++) {
                            const date = new Date(year, month, i);
                            if (date.getMonth() !== month) break;
                            if (date.getDay() === parseInt(time.day, 10)) {
                                let isValid = true;
                                const checkDate = new Date(date); checkDate.setHours(0, 0, 0, 0);
                                if (student.startDate && new Date(student.startDate) > checkDate) isValid = false;
                                if (student.endDate && new Date(student.endDate) < checkDate) isValid = false;
                                if (isValid) {
                                    const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                                    if (!monthScheduleData[dateKey]) monthScheduleData[dateKey] = [];
                                    monthScheduleData[dateKey].push({ 
                                        studentId: student.id, studentName: student.studentName, 
                                        start: time.start, end: time.end, 
                                        discipline: student.discipline, grade: student.subject
                                    });
                                }
                            }
                        }
                    });
                }
            });

            // 2. 渲染UI
            const grid = document.createElement('div');
            grid.className = 'monthly-schedule-grid';
            
            if (document.getElementById('mark-dates-btn').classList.contains('active')) {
                grid.classList.add('marking-mode');
            }

            const dayNames = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
            dayNames.forEach(day => grid.innerHTML += `<div class="day-header">${day}</div>`);
            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dayOffset = (firstDayOfMonth.getDay() + 6) % 7;

            for (let i = 0; i < dayOffset; i++) { grid.innerHTML += `<div class="day-cell not-current-month"><div class="day-number">${new Date(year, month, 0).getDate() - dayOffset + i + 1}</div></div>`; }

            for (let i = 1; i <= daysInMonth; i++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                
                const dailyClassMap = new Map();
                (monthScheduleData[dateKey] || []).forEach(c => {
                    const eventKey = `${dateKey}_${c.start}`;
                    dailyClassMap.set(eventKey, { ...c, isOverride: false, originalStart: c.start });
                });
                data.projects.forEach(student => {
                    if (Array.isArray(student.overriddenClasses)) {
                        student.overriddenClasses.forEach(override => {
                            if (override.key.slice(0, 10) === dateKey) {
                                dailyClassMap.set(override.key, {
                                    studentId: student.id, studentName: student.studentName,
                                    start: override.newStart, end: override.newEnd,
                                    discipline: student.discipline, grade: student.subject,
                                    isOverride: true, originalStart: override.key.split('_')[1]
                                });
                            }
                        });
                    }
                });

                let finalClasses = Array.from(dailyClassMap.values()).filter(c => {
                    const student = data.projects.find(p => p.id === c.studentId);
                    const eventKey = `${dateKey}_${c.isOverride ? c.originalStart : c.start}`;
                    return !(student && student.inactiveClasses && student.inactiveClasses.includes(eventKey));
                });
                finalClasses.sort((a, b) => a.start.localeCompare(b.start));
                
                const specialStatus = data.specialDates[dateKey];
                let dayCellClass = 'day-cell';
                if (specialStatus === 'holiday') dayCellClass += ' holiday';
                if (specialStatus === 'workday') dayCellClass += ' special-workday';
                let cellHTML = `<div class="${dayCellClass}" data-date="${dateKey}"><div class="day-number">${i}</div><div class="class-entries-container">`;

                finalClasses.forEach(c => {
                    totalClasses++;
                    const colors = getClassColor(c.discipline, c.grade);
                    const styleAttribute = `style="background-color: ${colors.background}; border-left-color: ${colors.border}; color: ${colors.text};"`;
                    
                    // --- 核心改动：无论名字多长，只显示前三个字 ---
                    let displayName = c.studentName;
                    if (displayName.length > 3) {
                        displayName = displayName.substring(0, 3) + '...';
                    }
                    
                    // 鼠标悬停的title依然显示全名，显示的名字(displayName)是截断后的
                    cellHTML += `<div class="class-entry" ${styleAttribute} data-student-id="${c.studentId}" data-date-key="${dateKey}" data-start-time="${c.isOverride ? c.originalStart : c.start}"><div class="drag-handle"></div><div class="class-entry-content-wrapper" title="${c.start}-${c.end} ${c.studentName}"><span class="class-entry-time">${c.start} - ${c.end}</span><span class="student-name">${displayName}</span></div></div>`;                });
                cellHTML += `</div></div>`;
                grid.innerHTML += cellHTML;
            }

            for (let i = 1; i <= (7 - (dayOffset + daysInMonth) % 7) % 7; i++) { grid.innerHTML += `<div class="day-cell not-current-month"><div class="day-number">${i}</div></div>`; }
            
            container.appendChild(grid);
            document.getElementById('schedule-class-count').textContent = totalClasses;
        }

        function initColumnDragAndDrop(headerRow) {
            const headers = Array.from(headerRow.querySelectorAll('.header-cell[draggable="true"]'));
            let draggedItem = null;
            headers.forEach(header => {
                header.addEventListener('dragstart', (e) => {
                    draggedItem = e.target.closest('.header-cell');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', draggedItem.dataset.key);
                });
                header.addEventListener('dragover', (e) => { e.preventDefault(); });
                header.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const targetItem = e.target.closest('.header-cell');
                    if (!targetItem || !targetItem.draggable) return;
                    const draggedKey = e.dataTransfer.getData('text/plain');
                    const targetKey = targetItem.dataset.key;
                    if (draggedKey && targetKey && draggedKey !== targetKey) {
                        const draggedIndex = columnConfig.findIndex(col => col.key === draggedKey);
                        const targetIndex = columnConfig.findIndex(col => col.key === targetKey);
                        if (draggedIndex > -1 && targetIndex > -1) {
                            const [removed] = columnConfig.splice(draggedIndex, 1);
                            columnConfig.splice(targetIndex, 0, removed);
                            saveConfig();
                            renderBoard();
                        }
                    }
                });
            });
        }
        
        // =============================================
        // =========== 日历功能 ===========
        // =============================================
        function openCalendarModal(projectId) {
            currentCalendarProjectId = projectId;
            currentCalendarDate = new Date();
            calendarModal.classList.remove('calendar-editing');
            document.getElementById('edit-schedule-btn').classList.remove('active');
            renderCalendar();
            calendarModal.style.display = 'flex';
        }

        function renderCalendar() {
            const project = data.projects.find(p => p.id == currentCalendarProjectId);
            if (!project) return;
            if (!Array.isArray(project.classDates)) { project.classDates = []; }
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            document.getElementById('calendar-month-year').textContent = `${year} 年 ${month + 1} 月`;
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            ['日', '一', '二', '三', '四', '五', '六'].forEach(day => {
                grid.innerHTML += `<div class="day-header">${day}</div>`;
            });
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDayOfMonth; i++) {
                grid.innerHTML += `<div class="day-cell"></div>`;
            }
            for (let i = 1; i <= daysInMonth; i++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell current-month-day';
                dayCell.textContent = i;
                const fullDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                dayCell.dataset.date = fullDate;
                if (project.classDates.includes(fullDate)) {
                    dayCell.classList.add('taught');
                }
                dayCell.addEventListener('click', () => {
                    if (!calendarModal.classList.contains('calendar-editing')) return;
                    if (project.classDates.includes(fullDate)) {
                        project.classDates = project.classDates.filter(d => d !== fullDate);
                    } else {
                        project.classDates.push(fullDate);
                    }
                    project.updatedAt = new Date().toISOString();
                    saveData();
                    renderCalendar();
                });
                grid.appendChild(dayCell);
            }
        }

        // =============================================
        // =========== 事件监听与初始化 ===========
        // =============================================
         
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('nav-work').addEventListener('click', () => initializeBoard('work'));
            document.getElementById('nav-student').addEventListener('click', () => initializeBoard('student'));
            document.getElementById('instructions-btn').addEventListener('click', () => {
                document.getElementById('instructions-modal').style.display = 'flex';
            });

            [projectModal, configModal, progressModal, calendarModal,scheduleModal, instructionsModal ].forEach(modal => {
                modal.addEventListener('click', e => { if (e.target === modal && !isEditing) modal.style.display = 'none'; });
            });
            document.getElementById('add-btn').addEventListener('click', () => openProjectModal(null));

            document.getElementById('project-form').addEventListener('submit', e => {
                e.preventDefault();
                const projectId = document.getElementById('project-id').value;
                const projectData = {};
                columnConfig.filter(c => c.type !== 'readonly' && c.type !== 'action' && c.key !== 'classTime').forEach(col => {
                    const input = document.getElementById(`form-${col.key}`);
                    if (input) projectData[col.key] = input.value;
                });
                // --- 新增代码开始：保存开始和结束日期 ---
                if (currentView === 'student') {
                    projectData.startDate = document.getElementById('form-startDate').value || null;
                    projectData.endDate = document.getElementById('form-endDate').value || null;
                }
                // --- 新增代码结束 ---

                if (currentView === 'student') {
                    const newClassTimes = [];
                    for(let i = 1; i <= 2; i++) {
                        const day = document.getElementById(`form-classTime-day-${i}`).value;
                        if (day !== "") {
                            newClassTimes.push({
                                day: parseInt(day, 10),
                                start: document.getElementById(`form-classTime-start-${i}`).value,
                                end: document.getElementById(`form-classTime-end-${i}`).value
                            });
                        }
                    }
                    projectData.classTime = newClassTimes;
                }

                projectData.updatedAt = new Date().toISOString();
                if (projectId) {
                    const pIndex = data.projects.findIndex(p => p.id == projectId);
                    if (pIndex > -1) data.projects[pIndex] = { ...data.projects[pIndex], ...projectData };
                } else {
                    projectData.id = Date.now();
                    if (currentView === 'student') {
                        projectData.classDates = [];
                        if (!projectData.classTime || projectData.classTime.length === 0) {
                            projectData.classTime = [{ day: 1, start: '13:00', end: '15:00' }];
                        }
                    }
                    data.projects.unshift(projectData);
                }
                saveData();
                renderBoard();
                projectModal.style.display = 'none';
            });

            document.getElementById('delete-btn').addEventListener('click', () => {
                const projectId = document.getElementById('project-id').value;
                const typeText = currentView === 'work' ? '项目' : '学生';
                if (confirm(`确定要永久删除此${typeText}的所有记录吗？`)) {
                    data.projects = data.projects.filter(p => p.id != projectId);
                    saveData();
                    renderBoard();
                    projectModal.style.display = 'none';
                }
            });

            document.getElementById('show-add-log-form-btn').addEventListener('click', (e) => {
                const modalBody = document.getElementById('progress-modal-body');
                const modalContent = e.target.closest('.modal-content');
                modalBody.classList.add('side-by-side');
                modalContent.classList.add('side-by-side-mode');
            });

            document.getElementById('return-to-log-list-btn').addEventListener('click', (e) => {
                const modalBody = document.getElementById('progress-modal-body');
                const modalContent = e.target.closest('.modal-content');
                modalBody.classList.remove('side-by-side');
                modalContent.classList.remove('side-by-side-mode');
            });
            
            document.getElementById('progress-log-form').addEventListener('submit', e => {
                e.preventDefault();
                if (currentView !== 'student') return;
                const projectId = e.currentTarget.dataset.projectId;
                if (!projectId) return;
                const project = data.projects.find(p => p.id == projectId);
                if (project) {
                    const newLog = {
                        date: document.getElementById('new-log-date').value,
                        duration: parseFloat(document.getElementById('new-log-duration').value) || null,
                        content: document.getElementById('new-log-content').value.trim(),
                        feedback: document.getElementById('new-log-feedback').value.trim(),
                        homeworkAssigned: document.getElementById('new-log-homework').value.trim(),
                        homeworkStatus: document.getElementById('new-log-homework-status').value
                    };
                    if (!Array.isArray(project.progressLog)) { project.progressLog = []; }
                    project.progressLog.push(newLog);
                    project.updatedAt = new Date().toISOString();
                    saveData(); 
                    renderBoard(); 
                    openProgressModal(projectId);
                }
            });

            document.getElementById('config-btn').addEventListener('click', () => {
                const container = document.getElementById('config-form-fields');
                container.innerHTML = '';
                columnConfig.forEach(col => {
                    const row = document.createElement('div');
                    row.className = 'config-row';
                    row.style.display = 'grid';
                    row.style.gridTemplateColumns = '1fr 60px';
                    row.style.alignItems = 'center';
                    const label = document.createElement('label');
                    label.htmlFor = `config-check-${col.key}`;
                    label.innerHTML = col.label;
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `config-check-${col.key}`;
                    checkbox.checked = col.visible;
                    row.appendChild(label);
                    row.appendChild(checkbox);
                    container.appendChild(row);
                });
                configModal.style.display = 'flex';
            });
            document.getElementById('save-config-btn').addEventListener('click', () => {
                columnConfig.forEach(col => {
                    const checkbox = document.getElementById(`config-check-${col.key}`);
                    if (checkbox) col.visible = checkbox.checked;
                });
                saveConfig();
                renderBoard();
                configModal.style.display = 'none';
            });

            document.getElementById('export-btn').addEventListener('click', () => {
                const exportData = { config: columnConfig, widths: columnWidths, data: data };
                const dataStr = JSON.stringify(exportData, null, 2);
                const link = document.createElement('a');
                link.download = `${currentView}_kanban_backup_${new Date().toISOString().slice(0,10)}.json`;
                link.href = URL.createObjectURL(new Blob([dataStr], {type: "application/json"}));
                link.click();
                URL.revokeObjectURL(link.href);
            });
            const importInput = document.getElementById('import-input');
            document.getElementById('import-btn').addEventListener('click', () => importInput.click());
            importInput.addEventListener('change', e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if (imported.data && imported.data.projects && imported.config && imported.widths) {
                            if (confirm('导入数据将会覆盖当前看板的所有内容，确定继续吗？')) {
                                data = imported.data;
                                columnConfig = imported.config;
                                columnWidths = imported.widths;
                                saveData(); saveConfig(); saveWidths();
                                renderBoard();
                                alert('数据导入成功！');
                            }
                        } else { alert('导入失败，文件格式不正确。'); }
                    } catch (err) { alert('导入失败，文件不是有效的JSON。'); }
                };
                reader.readAsText(file);
                e.target.value = '';
            });

            // 日历按钮事件
            document.getElementById('prev-month-btn').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar();
            });
            document.getElementById('next-month-btn').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar();
            });
            document.getElementById('edit-schedule-btn').addEventListener('click', (e) => {
                calendarModal.classList.toggle('calendar-editing');
                e.currentTarget.classList.toggle('active');
            });

            // 月历弹窗事件
            document.getElementById('weekly-schedule-btn').addEventListener('click', () => {
                if (currentView === 'student') {
                    currentScheduleDate = new Date(); // 每次打开都重置到当前月份
                    renderMonthlySchedule();
                    scheduleModal.style.display = 'flex';
                }
            });

            document.getElementById('schedule-prev-month-btn').addEventListener('click', () => {
                currentScheduleDate.setMonth(currentScheduleDate.getMonth() - 1);
                renderMonthlySchedule();
            });

            document.getElementById('schedule-next-month-btn').addEventListener('click', () => {
                currentScheduleDate.setMonth(currentScheduleDate.getMonth() + 1);
                renderMonthlySchedule();
            });

            // --- 最终版代码 v6.1 (Stable Refactor) 开始 ---
            let activeTimeEditor = null;
            let actionHistory = [];
            
            function showToast(message, onUndo) {
                const container = document.getElementById('toast-container');
                container.innerHTML = '';
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.innerHTML = `<span>${message}</span>`;
                if (onUndo) {
                    const undoBtn = document.createElement('button');
                    undoBtn.className = 'toast-undo-btn';
                    undoBtn.textContent = '撤销';
                    undoBtn.onclick = () => { onUndo(); toast.remove(); };
                    toast.appendChild(undoBtn);
                }
                container.appendChild(toast);
                setTimeout(() => toast.remove(), 5000);
            }

            function undoLastAction() {
                if (actionHistory.length === 0) return;
                const lastAction = actionHistory.pop();
                const student = data.projects.find(p => p.id == lastAction.studentId);
                if (!student || !student.inactiveClasses) return;
                const keyIndex = student.inactiveClasses.indexOf(lastAction.eventKey);
                if (keyIndex > -1) {
                    student.inactiveClasses.splice(keyIndex, 1);
                    saveData();
                    renderMonthlySchedule();
                }
            }

            function removeTimeEditor(shouldSaveChanges = false) {
                if (!activeTimeEditor) return;
                if (shouldSaveChanges) {
                    const { studentId, eventKey } = activeTimeEditor.dataset;
                    const student = data.projects.find(p => p.id == studentId);
                    if (student) {
                        const newStart = activeTimeEditor.querySelectorAll('input')[0].value;
                        const newEnd = activeTimeEditor.querySelectorAll('input')[1].value;
                        if (!Array.isArray(student.overriddenClasses)) student.overriddenClasses = [];
                        const existingOverrideIndex = student.overriddenClasses.findIndex(o => o.key === eventKey);
                        if (existingOverrideIndex > -1) student.overriddenClasses.splice(existingOverrideIndex, 1);
                        const originalStartTime = eventKey.split('_')[1];
                        const originalClass = student.classTime.find(ct => ct.start === originalStartTime);
                        if (!originalClass || newStart !== originalClass.start || newEnd !== originalClass.end) {
                           student.overriddenClasses.push({ key: eventKey, newStart, newEnd });
                        }
                        saveData();
                        renderMonthlySchedule();
                    }
                }
                document.removeEventListener('mousedown', handleOutsideClick, true);
                activeTimeEditor.remove();
                activeTimeEditor = null;
            }

            function handleOutsideClick(e) {
                if (activeTimeEditor && !activeTimeEditor.contains(e.target)) {
                    removeTimeEditor(true);
                }
            }
            
            const gridContainer = document.getElementById('schedule-grid-container');

            // 1. 【恢复】手动标记假日/工作日功能
            document.getElementById('mark-dates-btn').addEventListener('click', (e) => {
                const grid = gridContainer.querySelector('.monthly-schedule-grid');
                if (!grid) return;
                grid.classList.toggle('marking-mode');
                e.currentTarget.classList.toggle('active');
            });

            gridContainer.addEventListener('click', (e) => {
                const dayCell = e.target.closest('.day-cell');
                const grid = dayCell?.parentElement;
                if (!grid || !grid.classList.contains('marking-mode') || e.target.closest('.class-entry')) {
                    return;
                }
                const dateKey = dayCell.dataset.date;
                if (!dateKey || dayCell.classList.contains('not-current-month')) return;
                const currentStatus = data.specialDates[dateKey];
                if (!currentStatus) { data.specialDates[dateKey] = 'holiday'; } 
                else if (currentStatus === 'holiday') { data.specialDates[dateKey] = 'workday'; } 
                else if (currentStatus === 'workday') { delete data.specialDates[dateKey]; }
                saveData();
                renderMonthlySchedule();
            });

            //2. 月表中课程条目mousedown统一处理器 (v2, 结构加固版)
            gridContainer.addEventListener('mousedown', (e) => {
                const classEntry = e.target.closest('.class-entry');
                if (!classEntry) {
                    if (activeTimeEditor) removeTimeEditor(true);
                    return;
                }

                // --- 修复一：当处于“标记模式”时，禁止对课程条目进行任何操作 ---
                const grid = gridContainer.querySelector('.monthly-schedule-grid');
                if (grid && grid.classList.contains('marking-mode')) {
                    return; // 直接退出，不响应任何课程条目的点击
                }
                
                // 拖拽手柄的逻辑保持不变
                if (e.target.classList.contains('drag-handle')) {
                    if (e.button === 0) { classEntry.draggable = true; }
                    return;
                }

                // 新增检查：确保只有点击内容区才会触发后续事件
                const contentWrapper = e.target.closest('.class-entry-content-wrapper');
                if (!contentWrapper) {
                    return; // 若点击的不是内容区（如边框、手柄左侧空白），则不执行任何操作
                }

                const { studentId, dateKey, startTime } = classEntry.dataset;

                const student = data.projects.find(p => p.id == studentId);
                if (!student) return;
                const eventKey = `${dateKey}_${startTime}`;

                // --- 修复二：使用 if...else if 结构，确保左键和中键功能绝对互斥 ---
                if (e.button === 0) { // 左键: 编辑时间
                    if (activeTimeEditor) { removeTimeEditor(true); return; }
                    const currentTimeText = classEntry.querySelector('.class-entry-time').textContent;
                    const [currentStart, currentEnd] = currentTimeText.split(' - ');
                    const editor = document.createElement('div');
                    editor.className = 'time-editor';
                    editor.innerHTML = `<input type="time" value="${currentStart}"><span>-</span><input type="time" value="${currentEnd}">`;
                    editor.querySelectorAll('input[type="time"]').forEach(input => {
                        input.addEventListener('wheel', wheelEvent => {
                            wheelEvent.preventDefault();
                            const time = input.value.split(':');
                            let h = parseInt(time[0]), m = parseInt(time[1]);
                            if (wheelEvent.deltaY < 0) m += 15; else m -= 15;
                            if (m >= 60) { h += Math.floor(m / 60); m %= 60; } 
                            else if (m < 0) { h += Math.floor(m / 60); m = 60 + (m % 60); }
                            h = (h + 24) % 24;
                            input.value = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                        });
                    });
                    document.body.appendChild(editor);
                    const rect = classEntry.getBoundingClientRect();
                    editor.style.top = `${window.scrollY + rect.top}px`;
                    editor.style.left = `${window.scrollX + rect.left}px`;
                    activeTimeEditor = editor;
                    activeTimeEditor.dataset.studentId = studentId;
                    activeTimeEditor.dataset.eventKey = eventKey;
                    const firstInput = editor.querySelector('input');
                    firstInput.focus();
                    editor.addEventListener('keydown', (keyEvent) => {
                        if (keyEvent.key === 'Enter') { keyEvent.preventDefault(); removeTimeEditor(true); } 
                        else if (keyEvent.key === 'Escape') { keyEvent.preventDefault(); removeTimeEditor(false); }
                    });
                    setTimeout(() => document.addEventListener('mousedown', handleOutsideClick, true), 0);
                
                } else if (e.button === 1) { // 中键: 隐藏/删除
                    e.preventDefault();
                    if (!Array.isArray(student.inactiveClasses)) student.inactiveClasses = [];
                    if (student.inactiveClasses.includes(eventKey)) return;
                    student.inactiveClasses.push(eventKey);
                    saveData();
                    renderMonthlySchedule();
                    actionHistory.push({ type: 'inactivate', studentId, eventKey });
                    showToast('课程已隐藏', undoLastAction);
                }
            });

            //3. 拖拽生命周期时间
            gridContainer.addEventListener('dragstart', (e) => {
                const classEntry = e.target.closest('.class-entry');
                if (!classEntry || !classEntry.draggable) { e.preventDefault(); return; }
                setTimeout(() => classEntry.style.opacity = '0.5', 0);
                const currentTimeText = classEntry.querySelector('.class-entry-time').textContent;
                const [, currentEnd] = currentTimeText.split(' - ');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('application/json', JSON.stringify({ studentId: classEntry.dataset.studentId, originalDate: classEntry.dataset.dateKey, originalStart: classEntry.dataset.startTime, currentEnd: currentEnd }));
            });
            gridContainer.addEventListener('dragend', (e) => {
                const classEntry = e.target.closest('.class-entry');
                if (classEntry) {
                    classEntry.style.opacity = '1';
                    classEntry.draggable = false;
                }
                gridContainer.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            });
            gridContainer.addEventListener('dragover', (e) => { e.preventDefault(); const dayCell = e.target.closest('.day-cell'); if (dayCell) { gridContainer.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); dayCell.classList.add('drag-over'); } });
            gridContainer.addEventListener('dragleave', (e) => { const dayCell = e.target.closest('.day-cell'); if (dayCell) dayCell.classList.remove('drag-over'); });
            gridContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                const dayCell = e.target.closest('.day-cell');
                if (!dayCell) return;
                dayCell.classList.remove('drag-over');
                try {
                    const droppedData = JSON.parse(e.dataTransfer.getData('application/json'));
                    const targetDate = dayCell.dataset.date;
                    if (!droppedData || !targetDate || targetDate === droppedData.originalDate) return;
                    const student = data.projects.find(p => p.id == droppedData.studentId);
                    if (!student) return;
                    const originalKey = `${droppedData.originalDate}_${droppedData.originalStart}`;
                    const newKey = `${targetDate}_${droppedData.originalStart}`;
                    if (!student.overriddenClasses) student.overriddenClasses = [];
                    const movedOverrideIndex = student.overriddenClasses.findIndex(o => o.key === originalKey);
                    if (movedOverrideIndex > -1) { student.overriddenClasses.splice(movedOverrideIndex, 1); }
                    if (!student.inactiveClasses) student.inactiveClasses = [];
                    const originalRecurringIndex = student.inactiveClasses.indexOf(newKey);
                    if (originalRecurringIndex > -1) { student.inactiveClasses.splice(originalRecurringIndex, 1); }
                    if (movedOverrideIndex === -1) {
                         if (!student.inactiveClasses.includes(originalKey)) { student.inactiveClasses.push(originalKey); }
                    }
                    const existingOverrideIndex = student.overriddenClasses.findIndex(o => o.key === newKey);
                    if (existingOverrideIndex > -1) student.overriddenClasses.splice(existingOverrideIndex, 1);
                    student.overriddenClasses.push({ key: newKey, newStart: droppedData.originalStart, newEnd: droppedData.currentEnd });
                    saveData();
                    renderMonthlySchedule();
                } catch (err) { console.error("Drop error:", err); }
            });
            
            // 4. 全局键盘监听
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                    e.preventDefault();
                    undoLastAction();
                }
            });
            // --- 最终版代码 v6.1 (Stable Refactor) 结束 ---
            
            displayVersionAndTime(); // 初始化版本和时间显示
            initializeBoard('work');
        });
    })();
    </script>

</body>
</html>